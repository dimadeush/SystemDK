<?php/** * Project:   SystemDK: PHP Content Management System * File:      model_admin_shop.class.php * * @link      http://www.systemsdk.com/ * @copyright 2013 SystemDK * @author    Dmitriy Kravtsov <admin@systemsdk.com> * @package   SystemDK * @version   3.0 */class admin_shop extends model_base {    private $error;    private $img_array;    public function index() {        if(isset($_GET['cat'])) {            $cat = intval($_GET['cat']);        }        if(isset($_GET['categ'])) {            $categ = intval($_GET['categ']);        }        if(!isset($cat) and !isset($categ)) {            $cache = "home";            $cacheid = "home";            $cat = 0;            $categ = 0;        } elseif(isset($cat) and $cat != 0) {            if(isset($categ) and $categ != 0) {                $cache = "subcateg";                $cacheid = "cat".$cat."|categ".$categ;            } else {                $cache = "categ";                $cacheid = "cat".$cat;                $categ = 0;            }        } else {            header("Location: index.php?path=admin_shop&func=index&lang=".$this->registry->sitelang);            exit();        }        if(isset($_GET['num_page']) and intval($_GET['num_page']) != 0) {            $num_page = intval($_GET['num_page']);            if($num_page == 0) {                $num_page = 1;            }        } else {            $num_page = 1;        }        $num_string_rows = SYSTEMDK_ADMINROWS_PERPAGE;        $offset = ($num_page - 1) * $num_string_rows;        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cacheid."|".$num_page."|".$this->registry->language)) {            if($cache == "home") {                $sql = "SELECT a.catalog_id,a.catalog_name,a.catalog_date,a.catalog_show,(SELECT count(*) FROM ".PREFIX."_catalogs_".$this->registry->sitelang." b) as count_rows FROM ".PREFIX."_catalogs_".$this->registry->sitelang." a order by a.catalog_date ASC";            } elseif($cache == "categ") {                $sql = "SELECT a.category_id,a.category_name,a.category_date,a.category_show,(SELECT count(*) FROM ".PREFIX."_categories_".$this->registry->sitelang." b WHERE b.cat_catalog_id = ".$cat.") as count_rows,c.catalog_id,c.catalog_name FROM ".PREFIX."_categories_".$this->registry->sitelang." a RIGHT OUTER JOIN ".PREFIX."_catalogs_".$this->registry->sitelang." c ON a.cat_catalog_id=c.catalog_id WHERE c.catalog_id = ".$cat." order by a.category_date ASC";            } elseif($cache == "subcateg") {                $sql = "SELECT a.subcategory_id,a.subcategory_name,a.subcategory_date,a.subcategory_show,(SELECT count(*) FROM ".PREFIX."_subcategories_".$this->registry->sitelang." b WHERE b.subcategory_cat_id = ".$categ.") as count_rows,c.category_id,c.category_name,d.catalog_id,d.catalog_name FROM ".PREFIX."_subcategories_".$this->registry->sitelang." a RIGHT OUTER JOIN ".PREFIX."_categories_".$this->registry->sitelang." c ON a.subcategory_cat_id=c.category_id RIGHT OUTER JOIN ".PREFIX."_catalogs_".$this->registry->sitelang." d ON c.cat_catalog_id=d.catalog_id WHERE c.category_id = ".$categ." and d.catalog_id = ".$cat." order by a.subcategory_date ASC";            }            $result = $this->db->SelectLimit($sql,$num_string_rows,$offset);            if($result) {                if(isset($result->fields['0'])) {                    $numrows = intval($result->fields['0']);                } else {                    $numrows = 0;                }                if($numrows == 0 and $num_page > 1) {                    $this->registry->main_class->database_close();                    if($cache == "home") {                        header("Location: index.php?path=admin_shop&func=index&lang=".$this->registry->sitelang);                    } elseif($cache == "categ") {                        header("Location: index.php?path=admin_shop&func=index&cat=".$cat."&lang=".$this->registry->sitelang);                    } elseif($cache == "subcateg") {                        header("Location: index.php?path=admin_shop&func=index&cat=".$cat."&categ=".$categ."&lang=".$this->registry->sitelang);                    }                    exit();                }                if($cache == "categ" and isset($result->fields['5']) and intval($result->fields['5']) > 0) {                    $catalog_id = intval($result->fields['5']);                    $catalog_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['6']));                    $this->registry->main_class->assign("adminmodules_shop_catalog_id",$catalog_id);                    $this->registry->main_class->assign("adminmodules_shop_catalog_name",$catalog_name);                } elseif($cache == "subcateg" and isset($result->fields['5']) and intval($result->fields['5']) > 0) {                    $category_id = intval($result->fields['5']);                    $category_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['6']));                    $catalog_id = intval($result->fields['7']);                    $catalog_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['8']));                    $this->registry->main_class->assign("adminmodules_shop_catalog_id",$catalog_id);                    $this->registry->main_class->assign("adminmodules_shop_catalog_name",$catalog_name);                    $this->registry->main_class->assign("adminmodules_shop_category_id",$category_id);                    $this->registry->main_class->assign("adminmodules_shop_category_name",$category_name);                } elseif($cache != "home") {                    $this->registry->main_class->display_theme_adminheader();                    $this->registry->main_class->display_theme_adminmain();                    $this->registry->main_class->displayadmininfo();                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound".$cache."|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        if($cache == "categ") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESTITLE'));                            $this->registry->main_class->assign("shop_message","notfoundcatalog");                        } elseif($cache == "subcateg") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESTITLE'));                            $this->registry->main_class->assign("shop_message","notfoundcateg");                        }                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound".$cache."|".$this->registry->language);                    exit();                }                if($numrows > 0) {                    while(!$result->EOF) {                        if(!isset($numrows2)) {                            $numrows2 = intval($result->fields['4']);                        }                        $item_id = intval($result->fields['0']);                        $item_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['1']));                        $item_date = date("d.m.y H:i",intval($result->fields['2']));                        $item_show = intval($result->fields['3']);                        $items_all[] = array(                            "item_id" => $item_id,                            "item_name" => $item_name,                            "item_date" => $item_date,                            "item_show" => $item_show                        );                        $result->MoveNext();                    }                    $this->registry->main_class->assign("items_all",$items_all);                    if(isset($numrows2)) {                        $num_pages = @ceil($numrows2 / $num_string_rows);                    } else {                        $num_pages = 0;                    }                    if($num_pages > 1) {                        if($num_page > 1) {                            $prevpage = $num_page - 1;                            $this->registry->main_class->assign("prevpage",$prevpage);                        } else {                            $this->registry->main_class->assign("prevpage","no");                        }                        for($i = 1;$i < $num_pages + 1;$i++) {                            if($i == $num_page) {                                $html[] = array("number" => $i,"param1" => "1");                            } else {                                $pagelink = 5;                                if(($i > $num_page) and ($i < $num_page + $pagelink) or ($i < $num_page) and ($i > $num_page - $pagelink)) {                                    $html[] = array("number" => $i,"param1" => "2");                                }                                if(($i == $num_pages) and ($num_page < $num_pages - $pagelink)) {                                    $html[] = array("number" => $i,"param1" => "3");                                }                                if(($i == 1) and ($num_page > $pagelink + 1)) {                                    $html[] = array("number" => $i,"param1" => "4");                                }                            }                        }                        if($num_page < $num_pages) {                            $nextpage = $num_page + 1;                            $this->registry->main_class->assign("nextpage",$nextpage);                        } else {                            $this->registry->main_class->assign("nextpage","no");                        }                        $this->registry->main_class->assign("html",$html);                        $this->registry->main_class->assign("totalitems",$numrows2);                        $this->registry->main_class->assign("num_pages",$num_pages);                    } else {                        $this->registry->main_class->assign("html","no");                    }                } else {                    $this->registry->main_class->assign("items_all","no");                    $this->registry->main_class->assign("html","no");                }            } else {                $this->registry->main_class->display_theme_adminheader();                $this->registry->main_class->display_theme_adminmain();                $this->registry->main_class->displayadmininfo();                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);                $this->registry->main_class->assign("error",$error);                if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerror".$cache."|".$this->registry->language)) {                    $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                    if($cache == "home") {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMETITLE'));                    } elseif($cache == "categ") {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESTITLE'));                    } elseif($cache == "subcateg") {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESTITLE'));                    }                    $this->registry->main_class->assign("shop_message","sqlerror");                    $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                    $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                }                $this->registry->main_class->database_close();                $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerror".$cache."|".$this->registry->language);                exit();            }        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cacheid."|".$num_page."|".$this->registry->language)) {            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");            $this->registry->main_class->assign("adminmodules_shop_depth",$cache);            $this->registry->main_class->assign("adminmodules_shop_cat",$cat);            $this->registry->main_class->assign("adminmodules_shop_categ",$categ);            if($cache == "home") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMETITLE'));            } elseif($cache == "categ") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESTITLE'));            } elseif($cache == "subcateg") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESTITLE'));            }            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_display.html");        }        $this->registry->main_class->database_close();        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cacheid."|".$num_page."|".$this->registry->language);    }    public function shop_edit() {        if(isset($_GET['cat'])) {            $cat = intval($_GET['cat']);        }        if(isset($_GET['categ'])) {            $categ = intval($_GET['categ']);        }        if(isset($_GET['subcateg'])) {            $subcateg = intval($_GET['subcateg']);        }        if(isset($cat) and $cat != 0) {            if(isset($subcateg) and isset($categ) and $categ != 0) {                $cache = "subcateg";                if($subcateg != 0) {                    $cacheid = "cat".$cat."|categ".$categ."|subcateg".$subcateg;                    $itemid = $subcateg;                } else {                    $itemid = 0;                }            } elseif(isset($categ)) {                $cache = "categ";                if($categ != 0) {                    $cacheid = "cat".$cat."|categ".$categ;                    $itemid = $categ;                } else {                    $itemid = 0;                }            } else {                $cache = "cat";                $cacheid = "cat".$cat;                $itemid = $cat;                $categ = 0;            }        } else {            $cache = "cat";            $itemid = 0;        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if($itemid == 0) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|no".$cache."|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "cat") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMEEDITTITLE'));                    $this->registry->main_class->assign("shop_message","nocat");                } elseif($cache == "categ") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESEDITTITLE'));                    $this->registry->main_class->assign("shop_message","nocateg");                } elseif($cache == "subcateg") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESEDITTITLE'));                    $this->registry->main_class->assign("shop_message","nosubcateg");                }                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|no".$cache."|".$this->registry->language);            exit();        }        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|edit|".$cacheid."|".$this->registry->language)) {            if($cache == "cat") {                $sql = "SELECT a.catalog_id,a.catalog_img,a.catalog_name,a.catalog_description,a.catalog_position,a.catalog_show,a.catalog_date,a.catalog_meta_title,a.catalog_meta_keywords,a.catalog_meta_description FROM ".PREFIX."_catalogs_".$this->registry->sitelang." a WHERE a.catalog_id = ".$itemid;            } elseif($cache == "categ") {                $sql = "SELECT b.category_id,b.category_img,b.category_name,b.category_description,b.category_position,b.category_show,b.category_date,b.category_meta_title,b.category_meta_keywords,b.category_meta_description,b.cat_catalog_id,a.catalog_id,a.catalog_name FROM ".PREFIX."_catalogs_".$this->registry->sitelang." a LEFT OUTER JOIN ".PREFIX."_categories_".$this->registry->sitelang." b ON a.catalog_id=b.cat_catalog_id and a.catalog_id = ".$cat." and b.category_id = ".$itemid." order by (case WHEN b.category_id IS NULL THEN 0 ELSE b.category_id END) DESC,a.catalog_name ASC";            } elseif($cache == "subcateg") {                $sql = "SELECT c.subcategory_id,c.subcategory_img,c.subcategory_name,c.subcategory_description,c.subcategory_position,c.subcategory_show,c.subcategory_date,c.subcategory_meta_title,c.subcategory_meta_keywords,c.subcategory_meta_description,c.subcategory_cat_id,a.catalog_id,a.catalog_name,b.category_id,b.category_name FROM ".PREFIX."_catalogs_".$this->registry->sitelang." a INNER JOIN ".PREFIX."_categories_".$this->registry->sitelang." b ON a.catalog_id=b.cat_catalog_id and a.catalog_id = ".$cat." LEFT OUTER JOIN ".PREFIX."_subcategories_".$this->registry->sitelang." c ON b.category_id=c.subcategory_cat_id and c.subcategory_id = ".$itemid." and b.category_id = ".$categ." order by (case WHEN c.subcategory_id IS NULL THEN 0 ELSE c.subcategory_id END) DESC,b.category_name ASC";            }            $result = $this->db->Execute($sql);            if($result) {                if(isset($result->fields['0'])) {                    $numrows = intval($result->fields['0']);                } else {                    $numrows = 0;                }                if($numrows > 0) {                    require_once('../modules/shop/shop_config.inc');                    while(!$result->EOF) {                        if(isset($result->fields['0']) and intval($result->fields['0']) > 0) {                            $item_id = intval($result->fields['0']);                            $item_img = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['1']));                            $item_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['2']));                            $item_description = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['3']));                            $item_position = intval($result->fields['4']);                            $item_show = intval($result->fields['5']);                            $item_date = intval($result->fields['6']);                            $item_date2 = date("d.m.y",$item_date);                            $item_hour = date("H",$item_date);                            $item_minute = date("i",$item_date);                            $item_meta_title = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['7']));                            $item_meta_keywords = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['8']));                            $item_meta_description = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['9']));                            if($cache == "categ" or $cache == "subcateg") {                                if($cache != "subcateg") {                                    $in_catalog_id = intval($result->fields['10']);                                } else {                                    $in_catalog_id = intval($result->fields['11']);                                }                                $item_catalog_id = intval($result->fields['11']);                                $item_catalog_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['12']));                            } else {                                $in_catalog_id = "no";                                $item_catalog_id = "no";                                $item_catalog_name = "no";                            }                            if($cache == "subcateg") {                                $in_category_id = intval($result->fields['10']);                                $item_category_id = intval($result->fields['13']);                                $item_category_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['14']));                            } else {                                $in_category_id = "no";                                $item_category_id = "no";                                $item_category_name = "no";                            }                            $item_all[] = array(                                "item_id" => $item_id,                                "item_img" => $item_img,                                "item_imgpath" => SYSTEMDK_SHOP_IMAGE_PATH,                                "item_name" => $item_name,                                "item_description" => $item_description,                                "item_position" => $item_position,                                "item_show" => $item_show,                                "item_date" => $item_date2,                                "item_hour" => $item_hour,                                "item_minute" => $item_minute,                                "item_meta_title" => $item_meta_title,                                "item_meta_keywords" => $item_meta_keywords,                                "item_meta_description" => $item_meta_description,                                "in_catalog_id" => $in_catalog_id,                                "item_catalog_id" => $item_catalog_id,                                "item_catalog_name" => $item_catalog_name,                                "in_category_id" => $in_category_id,                                "item_category_id" => $item_category_id,                                "item_category_name" => $item_category_name                            );                        }                        if(($cache == "categ" or $cache == "subcateg") and isset($result->fields['11']) and intval($result->fields['11']) > 0) {                            $catalog_id = intval($result->fields['11']);                            $catalog_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['12']));                            $catalog_all_now = array("catalog_id" => $catalog_id,"catalog_name" => $catalog_name);                            if(!isset($catalogs_all) or (isset($catalogs_all) and !in_array($catalog_all_now,$catalogs_all))) {                                $catalogs_all[] = array("catalog_id" => $catalog_id,"catalog_name" => $catalog_name);                            }                        }                        if($cache == "subcateg" and isset($result->fields['13']) and intval($result->fields['13']) > 0) {                            $category_id = intval($result->fields['13']);                            $category_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['14']));                            $categories_all[] = array("category_id" => $category_id,"category_name" => $category_name);                        }                        $result->MoveNext();                    }                    $this->registry->main_class->assign("item_all",$item_all);                    $this->registry->main_class->assign("adminmodules_shop_item_id",$item_id);                    $this->registry->main_class->assign("adminmodules_shop_cat",$cat);                    $this->registry->main_class->assign("adminmodules_shop_categ",$categ);                    if(isset($catalogs_all)) {                        $this->registry->main_class->assign("catalogs_all",$catalogs_all);                    }                    if(isset($categories_all)) {                        $this->registry->main_class->assign("categories_all",$categories_all);                    }                } else {                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound2".$cache."|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        if($cache == "cat") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMEEDITTITLE'));                            $this->registry->main_class->assign("shop_message","notfoundcatalog");                        } elseif($cache == "categ") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESEDITTITLE'));                            $this->registry->main_class->assign("shop_message","notfoundcateg");                        } elseif($cache == "subcateg") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESEDITTITLE'));                            $this->registry->main_class->assign("shop_message","notfoundsubcateg");                        }                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound2".$cache."|".$this->registry->language);                    exit();                }            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);                $this->registry->main_class->assign("error",$error);                if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerror".$cache."|".$this->registry->language)) {                    $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                    if($cache == "cat") {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMEEDITTITLE'));                    } elseif($cache == "categ") {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESEDITTITLE'));                    } elseif($cache == "subcateg") {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESEDITTITLE'));                    }                    $this->registry->main_class->assign("shop_message","sqlerror");                    $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                    $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                }                $this->registry->main_class->database_close();                $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerror".$cache."|".$this->registry->language);                exit();            }            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");            if($cache == "cat") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMEEDITTITLE'));            } elseif($cache == "categ") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESEDITTITLE'));            } elseif($cache == "subcateg") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESEDITTITLE'));            }            $this->registry->main_class->assign("adminmodules_shop_depth",$cache);            $this->registry->main_class->assign("include_jquery","yes");            $this->registry->main_class->assign("include_jquery_data","dateinput");            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_edit.html");        }        $this->registry->main_class->database_close();        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|edit|".$cacheid."|".$this->registry->language);    }    public function shop_edit_inbase() {        if(isset($_POST['item_id'])) {            $item_id = intval($_POST['item_id']);        }        if(isset($_POST['item_name'])) {            $item_name = trim($_POST['item_name']);        }        if(isset($_POST['item_date'])) {            $item_date = trim($_POST['item_date']);        }        if(isset($_POST['item_hour'])) {            $item_hour = intval($_POST['item_hour']);        } else {            $item_hour = 0;        }        if(isset($_POST['item_minute'])) {            $item_minute = intval($_POST['item_minute']);        } else {            $item_minute = 0;        }        if(isset($_POST['item_action_img'])) {            $item_action_img = trim($_POST['item_action_img']);        }        if(isset($_POST['item_img'])) {            $item_img = trim($_POST['item_img']);        }        if(isset($_POST['item_description'])) {            $item_description = trim($_POST['item_description']);        }        if(isset($_POST['item_position'])) {            $item_position = intval($_POST['item_position']);        }        if(isset($_POST['item_show'])) {            $item_show = intval($_POST['item_show']);        }        if(isset($_POST['item_catalog'])) {            $item_catalog = intval($_POST['item_catalog']);        }        if(isset($_POST['item_catalog_old'])) {            $item_catalog_old = intval($_POST['item_catalog_old']);        }        if(isset($_POST['item_category'])) {            $item_category = intval($_POST['item_category']);        }        if(isset($_POST['item_category_old'])) {            $item_category_old = intval($_POST['item_category_old']);        }        if(isset($_POST['item_meta_title'])) {            $item_meta_title = trim($_POST['item_meta_title']);        }        if(isset($_POST['item_meta_keywords'])) {            $item_meta_keywords = trim($_POST['item_meta_keywords']);        }        if(isset($_POST['item_meta_description'])) {            $item_meta_description = trim($_POST['item_meta_description']);        }        if(isset($_POST['depth'])) {            $depth = intval($_POST['depth']);        }        if(isset($depth) and $depth == 1) {            $cache = "categ";        } elseif(isset($depth) and $depth == 2) {            $cache = "subcateg";        } else {            $cache = "cat";        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if((!isset($_POST['item_id']) or !isset($_POST['item_name']) or !isset($_POST['item_date']) or !isset($_POST['item_hour']) or !isset($_POST['item_minute']) or !isset($_POST['item_action_img']) or !isset($_POST['item_description']) or !isset($_POST['item_position']) or !isset($_POST['item_show']) or !isset($_POST['item_meta_title']) or !isset($_POST['item_meta_keywords']) or !isset($_POST['item_meta_description'])) or ($item_id == 0 or $item_name == "" or $item_date == "" or ($cache == "categ" and (!isset($item_catalog) or !isset($item_catalog_old) or $item_catalog == 0 or $item_catalog_old == 0)) or ($cache == "subcateg" and (!isset($item_category) or !isset($item_category_old) or $item_category == 0 or $item_category_old == 0)))) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notalldata".$cache."|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "cat") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMEEDITTITLE'));                } elseif($cache == "categ") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESEDITTITLE'));                } elseif($cache == "subcateg") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESEDITTITLE'));                }                $this->registry->main_class->assign("shop_message","notalldata");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notalldata".$cache."|".$this->registry->language);            exit();        }        $item_action_img = $this->registry->main_class->format_striptags($item_action_img);        require_once('../modules/shop/shop_config.inc');        if($item_action_img == 'del') {            $item_img = $this->registry->main_class->format_striptags($item_img);            if(@unlink("../".SYSTEMDK_SHOP_IMAGE_PATH."/".$item_img) or !is_file("../".SYSTEMDK_SHOP_IMAGE_PATH."/".$item_img)) {                $item_img = 'NULL';            } else {                if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|img".$cache."|".$this->registry->language)) {                    $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                    if($cache == "cat") {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMEEDITTITLE'));                    } elseif($cache == "categ") {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESEDITTITLE'));                    } elseif($cache == "subcateg") {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESEDITTITLE'));                    }                    $this->registry->main_class->assign("shop_message","notdelimg");                    $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                    $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                }                $this->registry->main_class->database_close();                $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|img".$cache."|".$this->registry->language);                exit();            }        } elseif($item_action_img == 'new_file') {            if(isset($_FILES['item_img']['name']) and trim($_FILES['item_img']['name']) !== '') {                if(is_uploaded_file($_FILES['item_img']['tmp_name'])) {                    if($_FILES['item_img']['size'] > SYSTEMDK_SHOP_IMAGE_MAXSIZE) {                        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editmaxsize".$cache."|".$this->registry->language)) {                            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                            if($cache == "cat") {                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMEEDITTITLE'));                            } elseif($cache == "categ") {                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESEDITTITLE'));                            } elseif($cache == "subcateg") {                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESEDITTITLE'));                            }                            $this->registry->main_class->assign("shop_message","maxsizeerror");                            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                        }                        $this->registry->main_class->database_close();                        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editmaxsize".$cache."|".$this->registry->language);                        exit();                    }                    if(($_FILES['item_img']['type'] == "image/gif") or ($_FILES['item_img']['type'] == "image/jpg") or ($_FILES['item_img']['type'] == "image/jpeg") or ($_FILES['item_img']['type'] == "image/pjpeg") or ($_FILES['item_img']['type'] == "image/png") or ($_FILES['item_img']['type'] == "image/bmp")) {                        $this->registry->main_class->set_locale();                        if(basename($this->registry->main_class->format_striptags($_FILES['item_img']['name'])) != "") {                            $item_img = date("dmY",time())."_".basename($this->registry->main_class->format_striptags($_FILES['item_img']['name']));                        } else {                            $item_img = "";                        }                        if(file_exists($item_img) and $item_img != "") {                            @unlink("../".SYSTEMDK_SHOP_IMAGE_PATH."/".$item_img);                        }                        if($item_img == "" or !@copy($_FILES['item_img']['tmp_name'],"../".SYSTEMDK_SHOP_IMAGE_PATH."/".$item_img)) {                            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editnotupload".$cache."|".$this->registry->language)) {                                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                                if($cache == "cat") {                                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMEEDITTITLE'));                                } elseif($cache == "categ") {                                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESEDITTITLE'));                                } elseif($cache == "subcateg") {                                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESEDITTITLE'));                                }                                $this->registry->main_class->assign("shop_message","notuploadfile");                                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                            }                            $this->registry->main_class->database_close();                            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editnotupload".$cache."|".$this->registry->language);                            exit();                        }                        $item_size2 = @getimagesize("../".SYSTEMDK_SHOP_IMAGE_PATH."/".$item_img);                        if(($item_size2[0] > SYSTEMDK_SHOP_IMAGE_MAXWIDTH) or ($item_size2[1] > SYSTEMDK_SHOP_IMAGE_MAXHEIGHT)) {                            @unlink("../".SYSTEMDK_SHOP_IMAGE_PATH."/".$item_img);                            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editnoteq".$cache."|".$this->registry->language)) {                                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                                if($cache == "cat") {                                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMEEDITTITLE'));                                } elseif($cache == "categ") {                                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESEDITTITLE'));                                } elseif($cache == "subcateg") {                                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESEDITTITLE'));                                }                                $this->registry->main_class->assign("shop_message","noteq");                                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                            }                            $this->registry->main_class->database_close();                            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editnoteq".$cache."|".$this->registry->language);                            exit();                        }                    } else {                        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editnoteqtype".$cache."|".$this->registry->language)) {                            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                            if($cache == "cat") {                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMEEDITTITLE'));                            } elseif($cache == "categ") {                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESEDITTITLE'));                            } elseif($cache == "subcateg") {                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESEDITTITLE'));                            }                            $this->registry->main_class->assign("shop_message","noteqtype");                            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                        }                        $this->registry->main_class->database_close();                        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editnoteqtype".$cache."|".$this->registry->language);                        exit();                    }                } else {                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editfile".$cache."|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        if($cache == "cat") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMEEDITTITLE'));                        } elseif($cache == "categ") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESEDITTITLE'));                        } elseif($cache == "subcateg") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESEDITTITLE'));                        }                        $this->registry->main_class->assign("shop_message","uploadfileerror");                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editfile".$cache."|".$this->registry->language);                    exit();                }                $item_img = $this->registry->main_class->processing_data($item_img,'need');            } else {                $item_img = 'NULL';            }        } else {            $item_img = $this->registry->main_class->format_striptags($item_img);            $item_img = $this->registry->main_class->processing_data($item_img);        }        $item_name = $this->registry->main_class->format_striptags($item_name);        $item_name = $this->registry->main_class->processing_data($item_name);        $item_date = $this->registry->main_class->format_striptags($item_date);        $item_date = $item_date.".".$item_hour.".".$item_minute;        $item_date = $this->registry->main_class->timetounix($item_date);        $item_description = $this->registry->main_class->format_striptags($item_description);        if($item_description != "") {            $item_description = $this->registry->main_class->processing_data($item_description);        } else {            $item_description = 'NULL';        }        $item_meta_title = $this->registry->main_class->format_striptags($item_meta_title);        if($item_meta_title != "") {            $item_meta_title = $this->registry->main_class->processing_data($item_meta_title);        } else {            $item_meta_title = 'NULL';        }        $item_meta_keywords = $this->registry->main_class->format_striptags($item_meta_keywords);        if($item_meta_keywords != "") {            $item_meta_keywords = $this->registry->main_class->processing_data($item_meta_keywords);        } else {            $item_meta_keywords = 'NULL';        }        $item_meta_description = $this->registry->main_class->format_striptags($item_meta_description);        if($item_meta_description != "") {            $item_meta_description = $this->registry->main_class->processing_data($item_meta_description);        } else {            $item_meta_description = 'NULL';        }        if($cache == "cat") {            $sql = "UPDATE ".PREFIX."_catalogs_".$this->registry->sitelang." SET catalog_img = ".$item_img.",catalog_name = ".$item_name.",catalog_description = ".$item_description.",catalog_show = '".$item_show."',catalog_date = '".$item_date."',catalog_meta_title = ".$item_meta_title.",catalog_meta_keywords = ".$item_meta_keywords.",catalog_meta_description = ".$item_meta_description." WHERE catalog_id = ".$item_id;            $result = $this->db->Execute($sql);            $num_result = $this->db->Affected_Rows();            if($result === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }        } elseif($cache == "categ") {            $this->db->StartTrans();            if($item_catalog != $item_catalog_old) {                $sql1 = "UPDATE ".PREFIX."_categories_".$this->registry->sitelang." SET category_position=category_position-1 WHERE category_position > 0 and cat_catalog_id = ".$item_catalog_old." and category_position > ".$item_position;                $result1 = $this->db->Execute($sql1);                if($result1 === false) {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                }                $sql2 = "SELECT max(category_position)+1 FROM ".PREFIX."_categories_".$this->registry->sitelang." WHERE cat_catalog_id = ".$item_catalog;                $result2 = $this->db->Execute($sql2);                if($result2) {                    if(isset($result2->fields['0'])) {                        $item_position = intval($result2->fields['0']);                    }                }                if(!isset($item_position)) {                    $item_position = 0;                }                if($result2 === false) {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                }            }            $sql = "UPDATE ".PREFIX."_categories_".$this->registry->sitelang." SET category_img = ".$item_img.",category_name = ".$item_name.",cat_catalog_id = ".$item_catalog.",category_description = ".$item_description.",category_position='".$item_position."',category_show = '".$item_show."',category_date = '".$item_date."',category_meta_title = ".$item_meta_title.",category_meta_keywords = ".$item_meta_keywords.",category_meta_description = ".$item_meta_description." WHERE category_id = ".$item_id;            $result = $this->db->Execute($sql);            if($result) {                $num_result = $this->db->Affected_Rows();            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            if((isset($result1) and $result1 === false) or (isset($result2) and $result2 === false)) {                $result = false;            }            $this->db->CompleteTrans();        } elseif($cache == "subcateg") {            $this->db->StartTrans();            if($item_category != $item_category_old) {                $sql1 = "UPDATE ".PREFIX."_subcategories_".$this->registry->sitelang." SET subcategory_position=subcategory_position-1 WHERE subcategory_position > 0 and subcategory_cat_id = ".$item_category_old." and subcategory_position > ".$item_position;                $result1 = $this->db->Execute($sql1);                if($result1 === false) {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                }                $sql2 = "SELECT max(subcategory_position)+1 FROM ".PREFIX."_subcategories_".$this->registry->sitelang." WHERE subcategory_cat_id = ".$item_category;                $result2 = $this->db->Execute($sql2);                if($result2) {                    if(isset($result2->fields['0'])) {                        $item_position = intval($result2->fields['0']);                    }                }                if(!isset($item_position)) {                    $item_position = 0;                }                if($result2 === false) {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                }            }            $sql = "UPDATE ".PREFIX."_subcategories_".$this->registry->sitelang." SET subcategory_img = ".$item_img.",subcategory_name = ".$item_name.",subcategory_cat_id = ".$item_category.",subcategory_description = ".$item_description.",subcategory_position='".$item_position."',subcategory_show = '".$item_show."',subcategory_date = '".$item_date."',subcategory_meta_title = ".$item_meta_title.",subcategory_meta_keywords = ".$item_meta_keywords.",subcategory_meta_description = ".$item_meta_description." WHERE subcategory_id = ".$item_id;            $result = $this->db->Execute($sql);            if($result) {                $num_result = $this->db->Affected_Rows();            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            if((isset($result1) and $result1 === false) or (isset($result2) and $result2 === false)) {                $result = false;            }            $this->db->CompleteTrans();        }        if($result === false) {            $this->registry->main_class->assign("error",$error);            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editsqlerror".$cache."|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "cat") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMEEDITTITLE'));                } elseif($cache == "categ") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESEDITTITLE'));                } elseif($cache == "subcateg") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESEDITTITLE'));                }                $this->registry->main_class->assign("shop_message","sqlerror");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editsqlerror".$cache."|".$this->registry->language);            exit();        } elseif($result !== false and $num_result == 0) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editok".$cache."|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "cat") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMEEDITTITLE'));                } elseif($cache == "categ") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESEDITTITLE'));                } elseif($cache == "subcateg") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESEDITTITLE'));                }                $this->registry->main_class->assign("shop_message","notsave");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editok".$cache."|".$this->registry->language);            exit();        } else {            if($cache == "cat") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sort|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sort|cat".$item_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$item_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|add");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_id);            } elseif($cache == "categ") {                if($item_catalog != $item_catalog_old) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                }                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sort|cat".$item_catalog_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sort|cat".$item_catalog);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog_old."|categ".$item_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog."|categ".$item_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$item_catalog_old."|categ".$item_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|add|cat".$item_catalog_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog);                if(intval(SYSTEMDK_SHOP_ITEMS_UNDERPARENT) > 0) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                }            } elseif($cache == "subcateg") {                if($item_category != $item_category_old) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                }                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog."|categ".$item_category_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog."|categ".$item_category);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sort|cat".$item_catalog_old."|categ".$item_category_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sort|cat".$item_catalog_old."|categ".$item_category);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog_old."|categ".$item_category_old."|subcateg".$item_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog_old."|categ".$item_category."|subcateg".$item_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$item_catalog."|categ".$item_category_old."|subcateg".$item_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog."|categ".$item_category_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog."|categ".$item_category_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog."|categ".$item_category);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog."|categ".$item_category);                if(intval(SYSTEMDK_SHOP_ITEMS_UNDERPARENT) > 0) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog);                }            }            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|editok".$cache."|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "cat") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPHOMEEDITTITLE'));                } elseif($cache == "categ") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESEDITTITLE'));                } elseif($cache == "subcateg") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESEDITTITLE'));                }                $this->registry->main_class->assign("shop_message","editok".$cache);                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|editok".$cache."|".$this->registry->language);        }    }    public function shop_add() {        if(isset($_GET['cat'])) {            $cat = intval($_GET['cat']);        }        if(isset($_GET['categ'])) {            $categ = intval($_GET['categ']);        }        if(isset($cat) and $cat != 0) {            if(isset($categ) and $categ != 0) {                $cache = "subcateg";                $cacheid = "add|cat".$cat."|categ".$categ."|subcateg";            } else {                $categ = 0;                $cache = "categ";                $cacheid = "add|cat".$cat."|categ";            }        } else {            $cat = 0;            $categ = 0;            $cache = "cat";            $cacheid = "add|cat";        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cacheid."|".$this->registry->language)) {            if($cache == "categ") {                $sql = "SELECT catalog_id,catalog_name FROM ".PREFIX."_catalogs_".$this->registry->sitelang." order by catalog_name ASC";            } elseif($cache == "subcateg") {                $sql = "SELECT a.category_id,a.category_name,b.catalog_id,b.catalog_name FROM ".PREFIX."_categories_".$this->registry->sitelang." a INNER JOIN ".PREFIX."_catalogs_".$this->registry->sitelang." b ON a.cat_catalog_id=b.catalog_id WHERE b.catalog_id = ".$cat." order by a.category_name ASC";            } else {                $sql = "no";            }            if($sql !== "no") {                $result = $this->db->Execute($sql);                if($result) {                    if(isset($result->fields['0'])) {                        $numrows = intval($result->fields['0']);                    } else {                        $numrows = 0;                    }                    if($numrows > 0) {                        while(!$result->EOF) {                            $item_id = intval($result->fields['0']);                            $item_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['1']));                            $item_all[] = array("item_id" => $item_id,"item_name" => $item_name);                            if($item_id == $cat and $cache == "categ") {                                $catalog_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['1']));                            }                            if(isset($result->fields['2']) and !isset($catalog_name) and $cache == "subcateg") {                                $catalog_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['3']));                            }                            if($item_id == $categ and !isset($category_name) and $cache == "subcateg") {                                $category_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['1']));                            }                            $result->MoveNext();                        }                        $this->registry->main_class->assign("item_all",$item_all);                        if(isset($catalog_name)) {                            $this->registry->main_class->assign("adminmodules_shop_cat_name",$catalog_name);                        }                        if(isset($category_name)) {                            $this->registry->main_class->assign("adminmodules_shop_categ_name",$category_name);                        }                        if((!isset($catalog_name) and ($cache == "categ" or $cache == "subcateg")) or (!isset($category_name) and $cache == "subcateg")) {                            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound4".$cache."|".$this->registry->language)) {                                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                                if($cache == "categ") {                                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESADDTITLE'));                                    $this->registry->main_class->assign("shop_message","notfoundcatalog");                                } elseif($cache == "subcateg") {                                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESADDTITLE'));                                    $this->registry->main_class->assign("shop_message","notfoundcateg");                                }                                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                            }                            $this->registry->main_class->database_close();                            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound4".$cache."|".$this->registry->language);                            exit();                        }                    } else {                        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound3".$cache."|".$this->registry->language)) {                            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                            if($cache == "categ") {                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESADDTITLE'));                                $this->registry->main_class->assign("shop_message","nocatalogs");                            } elseif($cache == "subcateg") {                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESADDTITLE'));                                $this->registry->main_class->assign("shop_message","nocategs");                            }                            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                        }                        $this->registry->main_class->database_close();                        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound3".$cache."|".$this->registry->language);                        exit();                    }                } else {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                    $this->registry->main_class->assign("error",$error);                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerror".$cache."|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        if($cache == "categ") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESADDTITLE'));                        } elseif($cache == "subcateg") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESADDTITLE'));                        }                        $this->registry->main_class->assign("shop_message","sqlerror");                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerror".$cache."|".$this->registry->language);                    exit();                }            }            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");            if($cache == "cat") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATALOGSADDTITLE'));            } elseif($cache == "categ") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESADDTITLE'));            } elseif($cache == "subcateg") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESADDTITLE'));            }            $this->registry->main_class->assign("adminmodules_shop_depth",$cache);            $this->registry->main_class->assign("adminmodules_shop_cat",$cat);            $this->registry->main_class->assign("adminmodules_shop_categ",$categ);            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_add.html");        }        $this->registry->main_class->database_close();        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cacheid."|".$this->registry->language);    }    public function shop_add_inbase() {        if(isset($_POST['item_name'])) {            $item_name = trim($_POST['item_name']);        }        if(isset($_POST['item_img'])) {            $item_img = trim($_POST['item_img']);        }        if(isset($_POST['item_description'])) {            $item_description = trim($_POST['item_description']);        }        if(isset($_POST['item_show'])) {            $item_show = intval($_POST['item_show']);        }        if(isset($_POST['item_catalog'])) {            $item_catalog = intval($_POST['item_catalog']);        }        if(isset($_POST['item_category'])) {            $item_category = intval($_POST['item_category']);        }        if(isset($_POST['item_meta_title'])) {            $item_meta_title = trim($_POST['item_meta_title']);        }        if(isset($_POST['item_meta_keywords'])) {            $item_meta_keywords = trim($_POST['item_meta_keywords']);        }        if(isset($_POST['item_meta_description'])) {            $item_meta_description = trim($_POST['item_meta_description']);        }        if(isset($_POST['depth'])) {            $depth = intval($_POST['depth']);        }        if(isset($depth) and $depth == 1) {            $cache = "categ";        } elseif(isset($depth) and $depth == 2) {            $cache = "subcateg";        } else {            $cache = "cat";        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if((!isset($_POST['item_name']) or !isset($_POST['item_description']) or !isset($_POST['item_show']) or !isset($_POST['item_meta_title']) or !isset($_POST['item_meta_keywords']) or !isset($_POST['item_meta_description'])) or ($item_name == "" or ($cache == "categ" and (!isset($item_catalog) or $item_catalog == 0)) or ($cache == "subcateg" and (!isset($item_category) or $item_category == 0)))) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addnotalldata".$cache."|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "cat") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATALOGSADDTITLE'));                } elseif($cache == "categ") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESADDTITLE'));                } elseif($cache == "subcateg") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESADDTITLE'));                }                $this->registry->main_class->assign("shop_message","notalldata");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addnotalldata".$cache."|".$this->registry->language);            exit();        }        require_once('../modules/shop/shop_config.inc');        if($this->registry->main_class->format_striptags($_FILES['item_img']['name']) != "") {            if(isset($_FILES['item_img']['name']) and trim($_FILES['item_img']['name']) !== '') {                if(is_uploaded_file($_FILES['item_img']['tmp_name'])) {                    if($_FILES['item_img']['size'] > SYSTEMDK_SHOP_IMAGE_MAXSIZE) {                        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addmaxsize".$cache."|".$this->registry->language)) {                            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                            if($cache == "cat") {                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATALOGSADDTITLE'));                            } elseif($cache == "categ") {                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESADDTITLE'));                            } elseif($cache == "subcateg") {                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESADDTITLE'));                            }                            $this->registry->main_class->assign("shop_message","maxsizeerror");                            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                        }                        $this->registry->main_class->database_close();                        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addmaxsize".$cache."|".$this->registry->language);                        exit();                    }                    if(($_FILES['item_img']['type'] == "image/gif") or ($_FILES['item_img']['type'] == "image/jpg") or ($_FILES['item_img']['type'] == "image/jpeg") or ($_FILES['item_img']['type'] == "image/pjpeg") or ($_FILES['item_img']['type'] == "image/png") or ($_FILES['item_img']['type'] == "image/bmp")) {                        $this->registry->main_class->set_locale();                        if(basename($this->registry->main_class->format_striptags($_FILES['item_img']['name'])) != "") {                            $item_img = date("dmY",time())."_".basename($this->registry->main_class->format_striptags($_FILES['item_img']['name']));                        } else {                            $item_img = "";                        }                        if(file_exists($item_img) and $item_img != "") {                            @unlink("../".SYSTEMDK_SHOP_IMAGE_PATH."/".$item_img);                        }                        if($item_img == "" or !@copy($_FILES['item_img']['tmp_name'],"../".SYSTEMDK_SHOP_IMAGE_PATH."/".$item_img)) {                            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addnotupload".$cache."|".$this->registry->language)) {                                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                                if($cache == "cat") {                                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATALOGSADDTITLE'));                                } elseif($cache == "categ") {                                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESADDTITLE'));                                } elseif($cache == "subcateg") {                                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESADDTITLE'));                                }                                $this->registry->main_class->assign("shop_message","notuploadfile");                                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                            }                            $this->registry->main_class->database_close();                            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addnotupload".$cache."|".$this->registry->language);                            exit();                        }                        $item_size2 = @getimagesize("../".SYSTEMDK_SHOP_IMAGE_PATH."/".$item_img);                        if(($item_size2[0] > SYSTEMDK_SHOP_IMAGE_MAXWIDTH) or ($item_size2[1] > SYSTEMDK_SHOP_IMAGE_MAXHEIGHT)) {                            @unlink("../".SYSTEMDK_SHOP_IMAGE_PATH."/".$item_img);                            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addnoteq".$cache."|".$this->registry->language)) {                                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                                if($cache == "cat") {                                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATALOGSADDTITLE'));                                } elseif($cache == "categ") {                                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESADDTITLE'));                                } elseif($cache == "subcateg") {                                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESADDTITLE'));                                }                                $this->registry->main_class->assign("shop_message","noteq");                                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                            }                            $this->registry->main_class->database_close();                            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addnoteq".$cache."|".$this->registry->language);                            exit();                        }                    } else {                        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addnoteqtype".$cache."|".$this->registry->language)) {                            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                            if($cache == "cat") {                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATALOGSADDTITLE'));                            } elseif($cache == "categ") {                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESADDTITLE'));                            } elseif($cache == "subcateg") {                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESADDTITLE'));                            }                            $this->registry->main_class->assign("shop_message","noteqtype");                            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                        }                        $this->registry->main_class->database_close();                        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addnoteqtype".$cache."|".$this->registry->language);                        exit();                    }                } else {                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addfile".$cache."|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        if($cache == "cat") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATALOGSADDTITLE'));                        } elseif($cache == "categ") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESADDTITLE'));                        } elseif($cache == "subcateg") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESADDTITLE'));                        }                        $this->registry->main_class->assign("shop_message","uploadfileerror");                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addfile".$cache."|".$this->registry->language);                    exit();                }                $item_img = $this->registry->main_class->processing_data($item_img,'need');            } else {                $item_img = 'NULL';            }        } else {            $item_img = 'NULL';        }        $item_name = $this->registry->main_class->format_striptags($item_name);        $item_name = $this->registry->main_class->processing_data($item_name);        $item_date = $this->registry->main_class->gettime();        $item_description = $this->registry->main_class->format_striptags($item_description);        if($item_description != "") {            $item_description = $this->registry->main_class->processing_data($item_description);        } else {            $item_description = 'NULL';        }        $item_meta_title = $this->registry->main_class->format_striptags($item_meta_title);        if($item_meta_title != "") {            $item_meta_title = $this->registry->main_class->processing_data($item_meta_title);        } else {            $item_meta_title = 'NULL';        }        $item_meta_keywords = $this->registry->main_class->format_striptags($item_meta_keywords);        if($item_meta_keywords != "") {            $item_meta_keywords = $this->registry->main_class->processing_data($item_meta_keywords);        } else {            $item_meta_keywords = 'NULL';        }        $item_meta_description = $this->registry->main_class->format_striptags($item_meta_description);        if($item_meta_description != "") {            $item_meta_description = $this->registry->main_class->processing_data($item_meta_description);        } else {            $item_meta_description = 'NULL';        }        if($cache == "cat") {            $sql = "SELECT max(catalog_position) FROM ".PREFIX."_catalogs_".$this->registry->sitelang;            $result = $this->db->Execute($sql);            if($result) {                if(isset($result->fields['0'])) {                    $item_position = intval($result->fields['0']) + 1;                }            }            if(!isset($item_position)) {                $item_position = 0;            }            $catalog_id = $this->db->GenID(PREFIX."_catalogs_id_".$this->registry->sitelang);            $sql = "INSERT INTO ".PREFIX."_catalogs_".$this->registry->sitelang." (catalog_id,catalog_img,catalog_name,catalog_description,catalog_position,catalog_show,catalog_date,catalog_meta_title,catalog_meta_keywords,catalog_meta_description) VALUES ('".$catalog_id."',".$item_img.",".$item_name.",".$item_description.",'".$item_position."','".$item_show."','".$item_date."',".$item_meta_title.",".$item_meta_keywords.",".$item_meta_description.")";        } elseif($cache == "categ") {            $sql = "SELECT max(category_position) FROM ".PREFIX."_categories_".$this->registry->sitelang." WHERE cat_catalog_id = ".$item_catalog;            $result = $this->db->Execute($sql);            if($result) {                if(isset($result->fields['0'])) {                    $item_position = intval($result->fields['0']) + 1;                }            }            if(!isset($item_position)) {                $item_position = 0;            }            $category_id = $this->db->GenID(PREFIX."_categories_id_".$this->registry->sitelang);            $sql = "INSERT INTO ".PREFIX."_categories_".$this->registry->sitelang." (category_id,category_img,category_name,cat_catalog_id,category_description,category_position,category_show,category_date,category_meta_title,category_meta_keywords,category_meta_description) VALUES ('".$category_id."',".$item_img.",".$item_name.",".$item_catalog.",".$item_description.",'".$item_position."','".$item_show."','".$item_date."',".$item_meta_title.",".$item_meta_keywords.",".$item_meta_description.")";        } elseif($cache == "subcateg") {            $sql = "SELECT max(subcategory_position) FROM ".PREFIX."_subcategories_".$this->registry->sitelang." WHERE subcategory_cat_id = ".$item_category;            $result = $this->db->Execute($sql);            if($result) {                if(isset($result->fields['0'])) {                    $item_position = intval($result->fields['0']) + 1;                }            }            if(!isset($item_position)) {                $item_position = 0;            }            $subcategory_id = $this->db->GenID(PREFIX."_subcategories_id_".$this->registry->sitelang);            $sql = "INSERT INTO ".PREFIX."_subcategories_".$this->registry->sitelang." (subcategory_id,subcategory_img,subcategory_name,subcategory_cat_id,subcategory_description,subcategory_position,subcategory_show,subcategory_date,subcategory_meta_title,subcategory_meta_keywords,subcategory_meta_description) VALUES ('".$subcategory_id."',".$item_img.",".$item_name.",".$item_category.",".$item_description.",'".$item_position."','".$item_show."','".$item_date."',".$item_meta_title.",".$item_meta_keywords.",".$item_meta_description.")";        }        $result = $this->db->Execute($sql);        $num_result = $this->db->Affected_Rows();        if($result === false) {            $error_message = $this->db->ErrorMsg();            $error_code = $this->db->ErrorNo();            $error[] = array("code" => $error_code,"message" => $error_message);        }        if($result === false) {            $this->registry->main_class->assign("error",$error);            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addsqlerror".$cache."|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "cat") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATALOGSADDTITLE'));                } elseif($cache == "categ") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESADDTITLE'));                } elseif($cache == "subcateg") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESADDTITLE'));                }                $this->registry->main_class->assign("shop_message","sqlerror");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addsqlerror".$cache."|".$this->registry->language);            exit();        } else {            if($cache == "cat") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sort|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|add");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");            } elseif($cache == "categ") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sort|cat".$item_catalog);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$item_catalog);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|add|cat".$item_catalog);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog);                if(intval(SYSTEMDK_SHOP_ITEMS_UNDERPARENT) > 0) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                }            } elseif($cache == "subcateg") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog."|categ".$item_category);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sort|cat".$item_catalog."|categ".$item_category);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$item_catalog."|categ".$item_category);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog."|categ".$item_category);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog."|categ".$item_category);                if(intval(SYSTEMDK_SHOP_ITEMS_UNDERPARENT) > 0) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog);                }            }            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|addok".$cache."|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "cat") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATALOGSADDTITLE'));                } elseif($cache == "categ") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCATEGORIESADDTITLE'));                } elseif($cache == "subcateg") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSUBCATEGORIESADDTITLE'));                }                $this->registry->main_class->assign("shop_message","addok".$cache);                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|addok".$cache."|".$this->registry->language);        }    }    public function shop_status() {        if(isset($_GET['action'])) {            $action = trim($_GET['action']);        } else {            $action = "";        }        if(!isset($_GET['action']) and isset($_POST['action'])) {            $action = trim($_POST['action']);        }        if(isset($_GET['cat'])) {            $cat = intval($_GET['cat']);        } else {            $cat = 0;        }        if($cat == 0 and isset($_POST['cat'])) {            $cat = intval($_POST['cat']);        }        if(isset($_GET['categ'])) {            $categ = intval($_GET['categ']);        } else {            $categ = 0;        }        if($categ == 0 and isset($_POST['categ'])) {            $categ = intval($_POST['categ']);        }        if(isset($_GET['subcateg'])) {            $subcateg = intval($_GET['subcateg']);        } else {            $subcateg = 0;        }        if($subcateg == 0 and isset($_POST['subcateg'])) {            $subcateg = intval($_POST['subcateg']);        }        if(isset($_GET['item_id'])) {            $item_id = intval($_GET['item_id']);        } else {            $item_id = 0;        }        if($item_id == 0 and isset($_POST['item_id']) and is_array($_POST['item_id']) and count($_POST['item_id']) > 0) {            $item_id_is_arr = 1;            for($i = 0,$size = count($_POST['item_id']);$i < $size;++$i) {                if($i == 0) {                    $item_id = "'".intval($_POST['item_id'][$i])."'";                } else {                    $item_id .= ",'".intval($_POST['item_id'][$i])."'";                }            }        } else {            $item_id_is_arr = 0;            $item_id = "'".$item_id."'";        }        $action = $this->registry->main_class->format_striptags($action);        if((($action == "on1" or $action == "off1" or $action == "delete1") and $cat == 0) or (($action == "on2" or $action == "off2" or $action == "delete2") and ($cat == 0 or $categ == 0)) or (($action == "on4" or $action == "off4" or $action == "delete4") and $cat == 0) or (($action == "on5" or $action == "off5" or $action == "delete5") and ($cat == 0 or $categ == 0)) or (($action == "on6" or $action == "off6" or $action == "delete6") and ($cat == 0 or $categ == 0 or $subcateg == 0))) {            $this->registry->main_class->display_theme_adminheader();            $this->registry->main_class->display_theme_adminmain();            $this->registry->main_class->displayadmininfo();            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|statusnotalldata|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOP'));                $this->registry->main_class->assign("shop_message","notalldata");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|statusnotalldata|".$this->registry->language);            exit();        }        if(!isset($item_id) or $action == "" or $item_id == "'0'") {            $this->registry->main_class->database_close();            if($action == "on1" or $action == "off1" or $action == "delete1") {                header("Location: index.php?path=admin_shop&func=index&cat=".$cat."&lang=".$this->registry->sitelang);            } elseif($action == "on2" or $action == "off2" or $action == "delete2") {                header("Location: index.php?path=admin_shop&func=index&cat=".$cat."&categ=".$categ."&lang=".$this->registry->sitelang);            } elseif($action == "on3" or $action == "off3" or $action == "delete3") {                header("Location: index.php?path=admin_shop&func=shop_items&lang=".$this->registry->sitelang);            } elseif($action == "on4" or $action == "off4" or $action == "delete4") {                header("Location: index.php?path=admin_shop&func=shop_items&cat=".$cat."&lang=".$this->registry->sitelang);            } elseif($action == "on5" or $action == "off5" or $action == "delete5") {                header("Location: index.php?path=admin_shop&func=shop_items&cat=".$cat."&categ=".$categ."&lang=".$this->registry->sitelang);            } elseif($action == "on6" or $action == "off6" or $action == "delete6") {                header("Location: index.php?path=admin_shop&func=shop_items&cat=".$cat."&categ=".$categ."&subcateg=".$subcateg."&lang=".$this->registry->sitelang);            } else {                header("Location: index.php?path=admin_shop&func=index&lang=".$this->registry->sitelang);            }            exit();        }        if($action == "on") {            $sql = "UPDATE ".PREFIX."_catalogs_".$this->registry->sitelang." SET catalog_show = '1' WHERE catalog_id IN (".$item_id.")";            $result = $this->db->Execute($sql);            $this->registry->main_class->assign("shop_message","on");        } elseif($action == "off") {            $sql = "UPDATE ".PREFIX."_catalogs_".$this->registry->sitelang." SET catalog_show = '0' WHERE catalog_id IN (".$item_id.")";            $result = $this->db->Execute($sql);            $this->registry->main_class->assign("shop_message","off");        } elseif($action == "delete") {            $this->db->StartTrans();            $this->shop_delete_images($item_id,$action);            $sql0 = "DELETE FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_subcategory_id IN (SELECT subcategory_id FROM ".PREFIX."_subcategories_".$this->registry->sitelang." WHERE subcategory_cat_id IN (SELECT category_id FROM ".PREFIX."_categories_".$this->registry->sitelang." where cat_catalog_id IN (".$item_id."))) or item_category_id IN (SELECT category_id FROM ".PREFIX."_categories_".$this->registry->sitelang." WHERE cat_catalog_id IN (".$item_id.")) or item_catalog_id IN (".$item_id.")";            $result0 = $this->db->Execute($sql0);            if($result0 === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $this->error[] = array("code" => $error_code,"message" => $error_message);            }            $sql1 = "DELETE FROM ".PREFIX."_subcategories_".$this->registry->sitelang." WHERE subcategory_cat_id IN (SELECT category_id FROM ".PREFIX."_categories_".$this->registry->sitelang." where cat_catalog_id IN (".$item_id."))";            $result1 = $this->db->Execute($sql1);            if($result1 === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $this->error[] = array("code" => $error_code,"message" => $error_message);            }            $sql2 = "DELETE FROM ".PREFIX."_categories_".$this->registry->sitelang." WHERE cat_catalog_id IN (".$item_id.")";            $result2 = $this->db->Execute($sql2);            if($result2 === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $this->error[] = array("code" => $error_code,"message" => $error_message);            }            $sql3 = "SELECT catalog_id FROM ".PREFIX."_catalogs_".$this->registry->sitelang." WHERE catalog_id IN (".$item_id.") ORDER BY catalog_position ASC";            $result3 = $this->db->Execute($sql3);            if($result3) {                if(isset($result3->fields['0'])) {                    while(!$result3->EOF) {                        $catalog_id = intval($result3->fields['0']);                        $sql4 = "SELECT catalog_position FROM ".PREFIX."_catalogs_".$this->registry->sitelang." WHERE catalog_id = ".$catalog_id;                        $result4 = $this->db->Execute($sql4);                        if($result4) {                            if(isset($result4->fields['0'])) {                                $catalog_position = intval($result4->fields['0']);                                $sql5 = "UPDATE ".PREFIX."_catalogs_".$this->registry->sitelang." SET catalog_position=catalog_position-1 WHERE catalog_position > 0 and catalog_position > ".$catalog_position;                                $result5 = $this->db->Execute($sql5);                                if($result5 === false) {                                    $error_message = $this->db->ErrorMsg();                                    $error_code = $this->db->ErrorNo();                                    $this->error[] = array("code" => $error_code,"message" => $error_message);                                }                            }                        } else {                            $error_message = $this->db->ErrorMsg();                            $error_code = $this->db->ErrorNo();                            $this->error[] = array("code" => $error_code,"message" => $error_message);                        }                        $result3->MoveNext();                    }                }            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $this->error[] = array("code" => $error_code,"message" => $error_message);            }            $sql = "DELETE FROM ".PREFIX."_catalogs_".$this->registry->sitelang." WHERE catalog_id IN (".$item_id.")";            $result = $this->db->Execute($sql);            if($result) {                $num_result = $this->db->Affected_Rows();            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $this->error[] = array("code" => $error_code,"message" => $error_message);            }            if($result0 === false or $result1 === false or $result2 === false or $result3 === false or (isset($result4) and $result4 === false) or (isset($result5) and $result5 === false) or isset($this->error)) {                $result = false;            } else {                $this->shop_delete_img_process();            }            $this->db->CompleteTrans();            $this->registry->main_class->assign("shop_message","delete");        } elseif($action == "on1") {            $sql = "UPDATE ".PREFIX."_categories_".$this->registry->sitelang." SET category_show = '1' WHERE category_id IN (".$item_id.")";            $result = $this->db->Execute($sql);            $this->registry->main_class->assign("shop_message","on1");        } elseif($action == "off1") {            $sql = "UPDATE ".PREFIX."_categories_".$this->registry->sitelang." SET category_show = '0' WHERE category_id IN (".$item_id.")";            $result = $this->db->Execute($sql);            $this->registry->main_class->assign("shop_message","off1");        } elseif($action == "delete1") {            $this->db->StartTrans();            $this->shop_delete_images($item_id,$action);            $sql0 = "DELETE FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_subcategory_id IN (SELECT subcategory_id FROM ".PREFIX."_subcategories_".$this->registry->sitelang." WHERE subcategory_cat_id IN (".$item_id.")) or item_category_id IN (".$item_id.")";            $result0 = $this->db->Execute($sql0);            if($result0 === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $this->error[] = array("code" => $error_code,"message" => $error_message);            }            $sql1 = "DELETE FROM ".PREFIX."_subcategories_".$this->registry->sitelang." WHERE subcategory_cat_id IN (".$item_id.")";            $result1 = $this->db->Execute($sql1);            if($result1 === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $this->error[] = array("code" => $error_code,"message" => $error_message);            }            $sql2 = "SELECT category_id,cat_catalog_id FROM ".PREFIX."_categories_".$this->registry->sitelang." WHERE category_id IN (".$item_id.") ORDER BY category_position ASC";            $result2 = $this->db->Execute($sql2);            if($result2) {                if(isset($result2->fields['0'])) {                    while(!$result2->EOF) {                        $category_id = intval($result2->fields['0']);                        $cat_catalog_id = intval($result2->fields['1']);                        $sql3 = "SELECT category_position FROM ".PREFIX."_categories_".$this->registry->sitelang." WHERE category_id = ".$category_id;                        $result3 = $this->db->Execute($sql3);                        if($result3) {                            if(isset($result3->fields['0'])) {                                $category_position = intval($result3->fields['0']);                                $sql4 = "UPDATE ".PREFIX."_categories_".$this->registry->sitelang." SET category_position=category_position-1 WHERE category_position > 0 and cat_catalog_id = ".$cat_catalog_id." and category_position > ".$category_position;                                $result4 = $this->db->Execute($sql4);                                if($result4 === false) {                                    $error_message = $this->db->ErrorMsg();                                    $error_code = $this->db->ErrorNo();                                    $this->error[] = array("code" => $error_code,"message" => $error_message);                                }                            }                        } else {                            $error_message = $this->db->ErrorMsg();                            $error_code = $this->db->ErrorNo();                            $this->error[] = array("code" => $error_code,"message" => $error_message);                        }                        $result2->MoveNext();                    }                }            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $this->error[] = array("code" => $error_code,"message" => $error_message);            }            $sql = "DELETE FROM ".PREFIX."_categories_".$this->registry->sitelang." WHERE category_id IN (".$item_id.")";            $result = $this->db->Execute($sql);            if($result) {                $num_result = $this->db->Affected_Rows();            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $this->error[] = array("code" => $error_code,"message" => $error_message);            }            if($result0 === false or $result1 === false or $result2 === false or (isset($result3) and $result3 === false) or (isset($result4) and $result4 === false) or isset($this->error)) {                $result = false;            } else {                $this->shop_delete_img_process();            }            $this->db->CompleteTrans();            $this->registry->main_class->assign("shop_message","delete1");        } elseif($action == "on2") {            $sql = "UPDATE ".PREFIX."_subcategories_".$this->registry->sitelang." SET subcategory_show = '1' WHERE subcategory_id IN (".$item_id.")";            $result = $this->db->Execute($sql);            $this->registry->main_class->assign("shop_message","on2");        } elseif($action == "off2") {            $sql = "UPDATE ".PREFIX."_subcategories_".$this->registry->sitelang." SET subcategory_show = '0' WHERE subcategory_id IN (".$item_id.")";            $result = $this->db->Execute($sql);            $this->registry->main_class->assign("shop_message","off2");        } elseif($action == "delete2") {            $this->db->StartTrans();            $this->shop_delete_images($item_id,$action);            $sql0 = "DELETE FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_subcategory_id IN (".$item_id.")";            $result0 = $this->db->Execute($sql0);            if($result0 === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $this->error[] = array("code" => $error_code,"message" => $error_message);            }            $sql1 = "SELECT subcategory_id,subcategory_cat_id FROM ".PREFIX."_subcategories_".$this->registry->sitelang." WHERE subcategory_id IN (".$item_id.") ORDER BY subcategory_position ASC";            $result1 = $this->db->Execute($sql1);            if($result1) {                if(isset($result1->fields['0'])) {                    while(!$result1->EOF) {                        $subcategory_id = intval($result1->fields['0']);                        $subcategory_cat_id = intval($result1->fields['1']);                        $sql2 = "SELECT subcategory_position FROM ".PREFIX."_subcategories_".$this->registry->sitelang." WHERE subcategory_id = ".$subcategory_id;                        $result2 = $this->db->Execute($sql2);                        if($result2) {                            if(isset($result2->fields['0'])) {                                $subcategory_position = intval($result2->fields['0']);                                $sql3 = "UPDATE ".PREFIX."_subcategories_".$this->registry->sitelang." SET subcategory_position=subcategory_position-1 WHERE subcategory_position > 0 and subcategory_cat_id = ".$subcategory_cat_id." and subcategory_position > ".$subcategory_position;                                $result3 = $this->db->Execute($sql3);                                if($result3 === false) {                                    $error_message = $this->db->ErrorMsg();                                    $error_code = $this->db->ErrorNo();                                    $this->error[] = array("code" => $error_code,"message" => $error_message);                                }                            }                        } else {                            $error_message = $this->db->ErrorMsg();                            $error_code = $this->db->ErrorNo();                            $this->error[] = array("code" => $error_code,"message" => $error_message);                        }                        $result1->MoveNext();                    }                }            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $this->error[] = array("code" => $error_code,"message" => $error_message);            }            $sql = "DELETE FROM ".PREFIX."_subcategories_".$this->registry->sitelang." WHERE subcategory_id IN (".$item_id.")";            $result = $this->db->Execute($sql);            if($result) {                $num_result = $this->db->Affected_Rows();            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $this->error[] = array("code" => $error_code,"message" => $error_message);            }            if($result0 === false or $result1 === false or (isset($result2) and $result2 === false) or (isset($result3) and $result3 === false) or isset($this->error)) {                $result = false;            } else {                $this->shop_delete_img_process();            }            $this->db->CompleteTrans();            $this->registry->main_class->assign("shop_message","delete2");        } elseif($action == "on3" or $action == "on4" or $action == "on5" or $action == "on6") {            $sql = "UPDATE ".PREFIX."_items_".$this->registry->sitelang." SET item_show = '1' WHERE item_id IN (".$item_id.")";            $result = $this->db->Execute($sql);            $this->registry->main_class->assign("shop_message","onitems");        } elseif($action == "off3" or $action == "off4" or $action == "off5" or $action == "off6") {            $sql = "UPDATE ".PREFIX."_items_".$this->registry->sitelang." SET item_show = '0' WHERE item_id IN (".$item_id.")";            $result = $this->db->Execute($sql);            $this->registry->main_class->assign("shop_message","offitems");        } elseif($action == "delete3" or $action == "delete4" or $action == "delete5" or $action == "delete6") {            $this->db->StartTrans();            $this->shop_delete_images($item_id,$action);            if($action == "delete3") {                $sql1 = "SELECT item_id FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_id IN (".$item_id.") ORDER BY item_position ASC";                $result1 = $this->db->Execute($sql1);                if($result1) {                    if(isset($result1->fields['0'])) {                        while(!$result1->EOF) {                            $sort_item_id = intval($result1->fields['0']);                            $sql2 = "SELECT item_position FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_id = ".$sort_item_id;                            $result2 = $this->db->Execute($sql2);                            if($result2) {                                if(isset($result2->fields['0'])) {                                    $item_position = intval($result2->fields['0']);                                    $sql3 = "UPDATE ".PREFIX."_items_".$this->registry->sitelang." SET item_position=item_position-1 WHERE item_position > 0 and item_catalog_id is null and item_category_id is null and item_subcategory_id is null and item_position > ".$item_position;                                    $result3 = $this->db->Execute($sql3);                                    if($result3 === false) {                                        $error_message = $this->db->ErrorMsg();                                        $error_code = $this->db->ErrorNo();                                        $this->error[] = array("code" => $error_code,"message" => $error_message);                                    }                                }                            } else {                                $error_message = $this->db->ErrorMsg();                                $error_code = $this->db->ErrorNo();                                $this->error[] = array("code" => $error_code,"message" => $error_message);                            }                            $result1->MoveNext();                        }                    }                } else {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $this->error[] = array("code" => $error_code,"message" => $error_message);                }            } elseif($action == "delete4") {                $sql1 = "SELECT item_id,item_catalog_id FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_id IN (".$item_id.") ORDER BY item_position ASC";                $result1 = $this->db->Execute($sql1);                if($result1) {                    if(isset($result1->fields['0'])) {                        while(!$result1->EOF) {                            $sort_item_id = intval($result1->fields['0']);                            $item_catalog_id = intval($result1->fields['1']);                            $sql2 = "SELECT item_position FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_id = ".$sort_item_id;                            $result2 = $this->db->Execute($sql2);                            if($result2) {                                if(isset($result2->fields['0'])) {                                    $item_position = intval($result2->fields['0']);                                    $sql3 = "UPDATE ".PREFIX."_items_".$this->registry->sitelang." SET item_position=item_position-1 WHERE item_position > 0 and item_catalog_id = ".$item_catalog_id." and item_position > ".$item_position;                                    $result3 = $this->db->Execute($sql3);                                    if($result3 === false) {                                        $error_message = $this->db->ErrorMsg();                                        $error_code = $this->db->ErrorNo();                                        $this->error[] = array("code" => $error_code,"message" => $error_message);                                    }                                }                            } else {                                $error_message = $this->db->ErrorMsg();                                $error_code = $this->db->ErrorNo();                                $this->error[] = array("code" => $error_code,"message" => $error_message);                            }                            $result1->MoveNext();                        }                    }                } else {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $this->error[] = array("code" => $error_code,"message" => $error_message);                }            } elseif($action == "delete5") {                $sql1 = "SELECT item_id,item_category_id FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_id IN (".$item_id.") ORDER BY item_position ASC";                $result1 = $this->db->Execute($sql1);                if($result1) {                    if(isset($result1->fields['0'])) {                        while(!$result1->EOF) {                            $sort_item_id = intval($result1->fields['0']);                            $item_category_id = intval($result1->fields['1']);                            $sql2 = "SELECT item_position FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_id = ".$sort_item_id;                            $result2 = $this->db->Execute($sql2);                            if($result2) {                                if(isset($result2->fields['0'])) {                                    $item_position = intval($result2->fields['0']);                                    $sql3 = "UPDATE ".PREFIX."_items_".$this->registry->sitelang." SET item_position=item_position-1 WHERE item_position > 0 and item_category_id = ".$item_category_id." and item_position > ".$item_position;                                    $result3 = $this->db->Execute($sql3);                                    if($result3 === false) {                                        $error_message = $this->db->ErrorMsg();                                        $error_code = $this->db->ErrorNo();                                        $this->error[] = array("code" => $error_code,"message" => $error_message);                                    }                                }                            } else {                                $error_message = $this->db->ErrorMsg();                                $error_code = $this->db->ErrorNo();                                $this->error[] = array("code" => $error_code,"message" => $error_message);                            }                            $result1->MoveNext();                        }                    }                } else {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $this->error[] = array("code" => $error_code,"message" => $error_message);                }            } elseif($action == "delete6") {                $sql1 = "SELECT item_id,item_subcategory_id FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_id IN (".$item_id.") ORDER BY item_position ASC";                $result1 = $this->db->Execute($sql1);                if($result1) {                    if(isset($result1->fields['0'])) {                        while(!$result1->EOF) {                            $sort_item_id = intval($result1->fields['0']);                            $item_subcategory_id = intval($result1->fields['1']);                            $sql2 = "SELECT item_position FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_id = ".$sort_item_id;                            $result2 = $this->db->Execute($sql2);                            if($result2) {                                if(isset($result2->fields['0'])) {                                    $item_position = intval($result2->fields['0']);                                    $sql3 = "UPDATE ".PREFIX."_items_".$this->registry->sitelang." SET item_position=item_position-1 WHERE item_position > 0 and item_subcategory_id = ".$item_subcategory_id." and item_position > ".$item_position;                                    $result3 = $this->db->Execute($sql3);                                    if($result3 === false) {                                        $error_message = $this->db->ErrorMsg();                                        $error_code = $this->db->ErrorNo();                                        $this->error[] = array("code" => $error_code,"message" => $error_message);                                    }                                }                            } else {                                $error_message = $this->db->ErrorMsg();                                $error_code = $this->db->ErrorNo();                                $this->error[] = array("code" => $error_code,"message" => $error_message);                            }                            $result1->MoveNext();                        }                    }                } else {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $this->error[] = array("code" => $error_code,"message" => $error_message);                }            }            $sql = "DELETE FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_id IN (".$item_id.")";            $result = $this->db->Execute($sql);            if($result) {                $num_result = $this->db->Affected_Rows();            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $this->error[] = array("code" => $error_code,"message" => $error_message);            }            if($result1 === false or (isset($result2) and $result2 === false) or (isset($result3) and $result3 === false) or isset($this->error)) {                $result = false;            } else {                $this->shop_delete_img_process();            }            $this->db->CompleteTrans();            $this->registry->main_class->assign("shop_message","deleteitems");        } else {            $this->registry->main_class->database_close();            header("Location: index.php?path=admin_shop&func=index&lang=".$this->registry->sitelang);            exit();        }        if($action != "delete" and $action != "delete1" and  $action != "delete2" and $action != "delete3" and $action != "delete4" and $action != "delete5" and $action != "delete6") {            if($result) {                $num_result = $this->db->Affected_Rows();            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $this->error[] = array("code" => $error_code,"message" => $error_message);            }        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if($result === false) {            $this->registry->main_class->assign("error",$this->error);            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|statussqlerror|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOP'));                $this->registry->main_class->assign("shop_message","sqlerror");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|statussqlerror|".$this->registry->language);            exit();        } elseif($result !== false and $num_result == 0) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|statusok|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOP'));                $this->registry->main_class->assign("shop_message","notsave");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|statusok|".$this->registry->language);            exit();        } else {            if($action == "on" or $action == "off" or $action == "delete") {                if($action == "delete") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                } else {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|home");                }                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|add");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin");            } elseif($action == "on1" or $action == "off1" or $action == "delete1") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$cat);                if($action == "delete1") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$cat);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sort|cat".$cat);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                }                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$cat);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|add|cat".$cat);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home"); // |cat".$cat                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home"); // |cat".$cat                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$cat);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$cat);            } elseif($action == "on2" or $action == "off2" or $action == "delete2") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$cat."|categ".$categ);                if($action == "delete2") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$cat."|categ".$categ);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sort|cat".$cat."|categ".$categ);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                }                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$cat."|categ".$categ);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$cat);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$cat);                //$this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$cat."|categ".$categ);                //$this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$cat."|categ".$categ);            } elseif($action == "on3" or $action == "off3" or $action == "delete3") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|home|items");                if($action == "delete3") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                }                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|home");            } elseif($action == "on4" or $action == "off4" or $action == "delete4") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$cat."|items");                if($action == "delete4") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$cat);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                }                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$cat);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$cat);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$cat);            } elseif($action == "on5" or $action == "off5" or $action == "delete5") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$cat."|categ".$categ."|items");                if($action == "delete5") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$cat."|categ".$categ);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                }                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$cat."|categ".$categ);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$cat);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$cat);            } elseif($action == "on6" or $action == "off6" or $action == "delete6") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$cat."|categ".$categ."|subcateg".$subcateg."|items");                if($action == "delete6") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$cat."|categ".$categ."|subcateg".$subcateg);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                }                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$cat."|categ".$categ."|subcateg".$subcateg);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$cat);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$cat);            }            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$action."|ok|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOP'));                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$action."|ok|".$this->registry->language);        }    }    private function shop_delete_images($item_id = "",$action = "") {        require_once('../modules/shop/shop_config.inc');        if($action == "delete") {            $sql0 = "SELECT item_id,item_img FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_subcategory_id IN (SELECT subcategory_id FROM ".PREFIX."_subcategories_".$this->registry->sitelang." WHERE subcategory_cat_id IN (SELECT category_id FROM ".PREFIX."_categories_".$this->registry->sitelang." where cat_catalog_id IN (".$item_id."))) or item_category_id IN (SELECT category_id FROM ".PREFIX."_categories_".$this->registry->sitelang." WHERE cat_catalog_id IN (".$item_id.")) or item_catalog_id IN (".$item_id.")";            $this->shop_array_images($sql0,SYSTEMDK_SHOP_ITEMIMAGE_PATH);            $sql1 = "SELECT subcategory_id,subcategory_img FROM ".PREFIX."_subcategories_".$this->registry->sitelang." WHERE subcategory_cat_id IN (SELECT category_id FROM ".PREFIX."_categories_".$this->registry->sitelang." where cat_catalog_id IN (".$item_id."))";            $this->shop_array_images($sql1,SYSTEMDK_SHOP_IMAGE_PATH);            $sql2 = "SELECT category_id,category_img FROM ".PREFIX."_categories_".$this->registry->sitelang." WHERE cat_catalog_id IN (".$item_id.")";            $this->shop_array_images($sql2,SYSTEMDK_SHOP_IMAGE_PATH);            $sql = "SELECT catalog_id,catalog_img FROM ".PREFIX."_catalogs_".$this->registry->sitelang." WHERE catalog_id IN (".$item_id.")";            $this->shop_array_images($sql,SYSTEMDK_SHOP_IMAGE_PATH);        } elseif($action == "delete1") {            $sql0 = "SELECT item_id,item_img FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_subcategory_id IN (SELECT subcategory_id FROM ".PREFIX."_subcategories_".$this->registry->sitelang." WHERE subcategory_cat_id IN (".$item_id.")) or item_category_id IN (".$item_id.")";            $this->shop_array_images($sql0,SYSTEMDK_SHOP_ITEMIMAGE_PATH);            $sql1 = "SELECT subcategory_id,subcategory_img FROM ".PREFIX."_subcategories_".$this->registry->sitelang." WHERE subcategory_cat_id IN (".$item_id.")";            $this->shop_array_images($sql1,SYSTEMDK_SHOP_IMAGE_PATH);            $sql = "SELECT category_id,category_img FROM ".PREFIX."_categories_".$this->registry->sitelang." WHERE category_id IN (".$item_id.")";            $this->shop_array_images($sql,SYSTEMDK_SHOP_IMAGE_PATH);        } elseif($action == "delete2") {            $sql0 = "SELECT item_id,item_img FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_subcategory_id IN (".$item_id.")";            $this->shop_array_images($sql0,SYSTEMDK_SHOP_ITEMIMAGE_PATH);            $sql = "SELECT subcategory_id,subcategory_img FROM ".PREFIX."_subcategories_".$this->registry->sitelang." WHERE subcategory_id IN (".$item_id.")";            $this->shop_array_images($sql,SYSTEMDK_SHOP_IMAGE_PATH);        } elseif($action == "delete3" or $action == "delete4" or $action == "delete5" or $action == "delete6") {            $sql = "SELECT item_id,item_img FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE item_id IN (".$item_id.")";            $this->shop_array_images($sql,SYSTEMDK_SHOP_ITEMIMAGE_PATH);        }    }    private function shop_array_images($sql,$image_path) {        $result = $this->db->Execute($sql);        if($result) {            if(isset($result->fields['0'])) {                $numrows = intval($result->fields['0']);            } else {                $numrows = 0;            }            if($numrows > 0) {                while(!$result->EOF) {                    $img = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['1']));                    $this->img_array[] = array("image_path" => $image_path,"img" => $img);                    $result->MoveNext();                }            }        } else {            $error_message = $this->db->ErrorMsg();            $error_code = $this->db->ErrorNo();            $this->error[] = array("code" => $error_code,"message" => $error_message);        }    }    private function shop_delete_img_process() {        if(isset($this->img_array) and is_array($this->img_array) and count($this->img_array) > 0) {            for($i = 0,$size = count($this->img_array);$i < $size;++$i) {                @unlink("../".$this->img_array[$i]['image_path']."/".$this->img_array[$i]['img']);            }        }    }    public function shop_items() {        if(isset($_GET['cat'])) {            $cat = intval($_GET['cat']);        }        if(isset($_GET['categ'])) {            $categ = intval($_GET['categ']);        }        if(isset($_GET['subcateg'])) {            $subcateg = intval($_GET['subcateg']);        }        if(!isset($cat) and !isset($categ) and !isset($subcateg)) {            $cache = "homei";            $cacheid = "home|items";            $cat = 0;            $categ = 0;            $subcateg = 0;        } elseif(isset($cat) and $cat != 0) {            if(isset($subcateg) and $subcateg != 0) {                $cache = "subcategi";                $cacheid = "cat".$cat."|categ".$categ."|subcateg".$subcateg."|items";            } elseif(isset($categ) and $categ != 0) {                $cache = "categi";                $cacheid = "cat".$cat."|categ".$categ."|items";                $subcateg = 0;            } else {                $cache = "cati";                $cacheid = "cat".$cat."|items";                $categ = 0;                $subcateg = 0;            }        } else {            header("Location: index.php?path=admin_shop&func=index&lang=".$this->registry->sitelang);            exit();        }        if(isset($_GET['num_page']) and intval($_GET['num_page']) != 0) {            $num_page = intval($_GET['num_page']);            if($num_page == 0) {                $num_page = 1;            }        } else {            $num_page = 1;        }        $num_string_rows = SYSTEMDK_ADMINROWS_PERPAGE;        $offset = ($num_page - 1) * $num_string_rows;        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cacheid."|".$num_page."|".$this->registry->language)) {            if($cache == "homei") {                $sql = "SELECT a.item_id,a.item_name,a.item_show,a.item_quantity,a.item_quantity_unlim,a.item_quantity_param,a.item_display,a.item_date,(SELECT count(*) FROM ".PREFIX."_items_".$this->registry->sitelang." b WHERE b.item_catalog_id is NULL and b.item_category_id is NULL and b.item_subcategory_id is NULL) as count_rows FROM ".PREFIX."_items_".$this->registry->sitelang." a WHERE a.item_catalog_id is NULL and a.item_category_id is NULL and a.item_subcategory_id is NULL order by a.item_date ASC";            } elseif($cache == "cati") {                $sql = "SELECT a.item_id,a.item_name,a.item_show,a.item_quantity,a.item_quantity_unlim,a.item_quantity_param,a.item_display,a.item_date,(SELECT count(*) FROM ".PREFIX."_items_".$this->registry->sitelang." e,".PREFIX."_catalogs_".$this->registry->sitelang." f WHERE f.catalog_id=e.item_catalog_id and e.item_catalog_id = ".$cat.") as count_rows,b.catalog_id,b.catalog_name FROM ".PREFIX."_items_".$this->registry->sitelang." a RIGHT OUTER JOIN ".PREFIX."_catalogs_".$this->registry->sitelang." b on a.item_catalog_id=b.catalog_id WHERE b.catalog_id = ".$cat." order by a.item_date ASC";            } elseif($cache == "categi") {                $sql = "SELECT a.item_id,a.item_name,a.item_show,a.item_quantity,a.item_quantity_unlim,a.item_quantity_param,a.item_display,a.item_date,(SELECT count(*) FROM ".PREFIX."_items_".$this->registry->sitelang." e,".PREFIX."_categories_".$this->registry->sitelang." f,".PREFIX."_catalogs_".$this->registry->sitelang." g WHERE f.category_id=e.item_category_id and g.catalog_id=f.cat_catalog_id and e.item_category_id = ".$categ." and g.catalog_id = ".$cat.") as count_rows,c.catalog_id,c.catalog_name,b.category_id,b.category_name FROM ".PREFIX."_items_".$this->registry->sitelang." a RIGHT OUTER JOIN ".PREFIX."_categories_".$this->registry->sitelang." b on a.item_category_id=b.category_id INNER JOIN ".PREFIX."_catalogs_".$this->registry->sitelang." c on b.cat_catalog_id=c.catalog_id WHERE b.category_id = ".$categ." and c.catalog_id = ".$cat." order by a.item_date ASC";            } elseif($cache == "subcategi") {                $sql = "SELECT a.item_id,a.item_name,a.item_show,a.item_quantity,a.item_quantity_unlim,a.item_quantity_param,a.item_display,a.item_date,(SELECT count(*) FROM ".PREFIX."_items_".$this->registry->sitelang." e,".PREFIX."_subcategories_".$this->registry->sitelang." f,".PREFIX."_categories_".$this->registry->sitelang." g,".PREFIX."_catalogs_".$this->registry->sitelang." h WHERE f.subcategory_id=e.item_subcategory_id and g.category_id=f.subcategory_cat_id and h.catalog_id=g.cat_catalog_id and e.item_subcategory_id = ".$subcateg." and g.category_id = ".$categ." and h.catalog_id = ".$cat.") as count_rows,d.catalog_id,d.catalog_name,c.category_id,c.category_name,b.subcategory_id,b.subcategory_name FROM ".PREFIX."_items_".$this->registry->sitelang." a RIGHT OUTER JOIN ".PREFIX."_subcategories_".$this->registry->sitelang." b on a.item_subcategory_id=b.subcategory_id INNER JOIN ".PREFIX."_categories_".$this->registry->sitelang." c on b.subcategory_cat_id=c.category_id INNER JOIN ".PREFIX."_catalogs_".$this->registry->sitelang." d on c.cat_catalog_id=d.catalog_id WHERE b.subcategory_id = ".$subcateg." and c.category_id = ".$categ." and d.catalog_id = ".$cat." order by a.item_date ASC";            }            $result = $this->db->SelectLimit($sql,$num_string_rows,$offset);            if($result) {                if(isset($result->fields['0'])) {                    $numrows = intval($result->fields['0']);                } else {                    $numrows = 0;                }                if($numrows == 0 and $num_page > 1) {                    $this->registry->main_class->database_close();                    if($cache == "homei") {                        header("Location: index.php?path=admin_shop&func=shop_items&lang=".$this->registry->sitelang);                    } elseif($cache == "cati") {                        header("Location: index.php?path=admin_shop&func=shop_items&cat=".$cat."&lang=".$this->registry->sitelang);                    } elseif($cache == "categi") {                        header("Location: index.php?path=admin_shop&func=shop_items&cat=".$cat."&categ=".$categ."&lang=".$this->registry->sitelang);                    } elseif($cache == "subcategi") {                        header("Location: index.php?path=admin_shop&func=shop_items&cat=".$cat."&categ=".$categ."&subcateg=".$subcateg."&lang=".$this->registry->sitelang);                    }                    exit();                }                if($cache == "cati" and isset($result->fields['9']) and intval($result->fields['9']) > 0) {                    $catalog_id = intval($result->fields['9']);                    $catalog_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['10']));                    $this->registry->main_class->assign("adminmodules_shop_catalog_id",$catalog_id);                    $this->registry->main_class->assign("adminmodules_shop_catalog_name",$catalog_name);                } elseif($cache == "categi" and isset($result->fields['11']) and intval($result->fields['11']) > 0) {                    $category_id = intval($result->fields['11']);                    $category_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['12']));                    $catalog_id = intval($result->fields['9']);                    $catalog_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['10']));                    $this->registry->main_class->assign("adminmodules_shop_catalog_id",$catalog_id);                    $this->registry->main_class->assign("adminmodules_shop_catalog_name",$catalog_name);                    $this->registry->main_class->assign("adminmodules_shop_category_id",$category_id);                    $this->registry->main_class->assign("adminmodules_shop_category_name",$category_name);                } elseif($cache == "subcategi" and isset($result->fields['13']) and intval($result->fields['13']) > 0) {                    $subcategory_id = intval($result->fields['13']);                    $subcategory_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['14']));                    $category_id = intval($result->fields['11']);                    $category_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['12']));                    $catalog_id = intval($result->fields['9']);                    $catalog_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['10']));                    $this->registry->main_class->assign("adminmodules_shop_catalog_id",$catalog_id);                    $this->registry->main_class->assign("adminmodules_shop_catalog_name",$catalog_name);                    $this->registry->main_class->assign("adminmodules_shop_category_id",$category_id);                    $this->registry->main_class->assign("adminmodules_shop_category_name",$category_name);                    $this->registry->main_class->assign("adminmodules_shop_subcategory_id",$subcategory_id);                    $this->registry->main_class->assign("adminmodules_shop_subcategory_name",$subcategory_name);                } elseif($cache != "homei") {                    $this->registry->main_class->display_theme_adminheader();                    $this->registry->main_class->display_theme_adminmain();                    $this->registry->main_class->displayadmininfo();                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound".$cache."|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        if($cache == "cati") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSHOWCATITEMS'));                            $this->registry->main_class->assign("shop_message","notfoundcatalog");                        } elseif($cache == "categi") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSHOWCATEGITEMS'));                            $this->registry->main_class->assign("shop_message","notfoundcateg");                        } elseif($cache == "subcategi") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSHOWSUBCATEGITEMS'));                            $this->registry->main_class->assign("shop_message","notfoundsubcateg");                        }                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound".$cache."|".$this->registry->language);                    exit();                }                if($numrows > 0) {                    while(!$result->EOF) {                        if(!isset($numrows2)) {                            $numrows2 = intval($result->fields['8']);                        }                        $item_id = intval($result->fields['0']);                        $item_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['1']));                        $item_show = intval($result->fields['2']);                        $item_quantity = intval($result->fields['3']);                        $item_quantity_unlim = intval($result->fields['4']);                        $item_quantity_param = intval($result->fields['5']);                        $item_display = intval($result->fields['6']);                        $item_date = date("d.m.y H:i",intval($result->fields['7']));                        $items_all[] = array(                            "item_id" => $item_id,                            "item_name" => $item_name,                            "item_show" => $item_show,                            "item_quantity" => $item_quantity,                            "item_quantity_unlim" => $item_quantity_unlim,                            "item_quantity_param" => $item_quantity_param,                            "item_display" => $item_display,                            "item_date" => $item_date                        );                        $result->MoveNext();                    }                    $this->registry->main_class->assign("items_all",$items_all);                    if(isset($numrows2)) {                        $num_pages = @ceil($numrows2 / $num_string_rows);                    } else {                        $num_pages = 0;                    }                    if($num_pages > 1) {                        if($num_page > 1) {                            $prevpage = $num_page - 1;                            $this->registry->main_class->assign("prevpage",$prevpage);                        } else {                            $this->registry->main_class->assign("prevpage","no");                        }                        for($i = 1;$i < $num_pages + 1;$i++) {                            if($i == $num_page) {                                $html[] = array("number" => $i,"param1" => "1");                            } else {                                $pagelink = 5;                                if(($i > $num_page) and ($i < $num_page + $pagelink) or ($i < $num_page) and ($i > $num_page - $pagelink)) {                                    $html[] = array("number" => $i,"param1" => "2");                                }                                if(($i == $num_pages) and ($num_page < $num_pages - $pagelink)) {                                    $html[] = array("number" => $i,"param1" => "3");                                }                                if(($i == 1) and ($num_page > $pagelink + 1)) {                                    $html[] = array("number" => $i,"param1" => "4");                                }                            }                        }                        if($num_page < $num_pages) {                            $nextpage = $num_page + 1;                            $this->registry->main_class->assign("nextpage",$nextpage);                        } else {                            $this->registry->main_class->assign("nextpage","no");                        }                        $this->registry->main_class->assign("html",$html);                        $this->registry->main_class->assign("totalitems",$numrows2);                        $this->registry->main_class->assign("num_pages",$num_pages);                    } else {                        $this->registry->main_class->assign("html","no");                    }                } else {                    $this->registry->main_class->assign("items_all","no");                    $this->registry->main_class->assign("html","no");                }            } else {                $this->registry->main_class->display_theme_adminheader();                $this->registry->main_class->display_theme_adminmain();                $this->registry->main_class->displayadmininfo();                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);                $this->registry->main_class->assign("error",$error);                if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerror".$cache."|".$this->registry->language)) {                    $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                    if($cache == "homei") {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSHOWITEMS'));                    } elseif($cache == "cati") {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSHOWCATITEMS'));                    } elseif($cache == "categi") {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSHOWCATEGITEMS'));                    } elseif($cache == "subcategi") {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSHOWSUBCATEGITEMS'));                    }                    $this->registry->main_class->assign("shop_message","sqlerror");                    $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                    $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                }                $this->registry->main_class->database_close();                $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerror".$cache."|".$this->registry->language);                exit();            }        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cacheid."|".$num_page."|".$this->registry->language)) {            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");            $this->registry->main_class->assign("adminmodules_shop_depth",$cache);            $this->registry->main_class->assign("adminmodules_shop_cat",$cat);            $this->registry->main_class->assign("adminmodules_shop_categ",$categ);            $this->registry->main_class->assign("adminmodules_shop_subcateg",$subcateg);            if($cache == "homei") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSHOWITEMS'));            } elseif($cache == "cati") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSHOWCATITEMS'));            } elseif($cache == "categi") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSHOWCATEGITEMS'));            } elseif($cache == "subcategi") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSHOWSUBCATEGITEMS'));            }            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_items_display.html");        }        $this->registry->main_class->database_close();        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cacheid."|".$num_page."|".$this->registry->language);    }    public function shop_edit_item() {        if(isset($_GET['item_id'])) {            $itemid = intval($_GET['item_id']);        } else {            $item_id = 0;        }        if(isset($_GET['cat'])) {            $cat = intval($_GET['cat']);        }        if(isset($_GET['categ'])) {            $categ = intval($_GET['categ']);        }        if(isset($_GET['subcateg'])) {            $subcateg = intval($_GET['subcateg']);        }        if(isset($cat) and $cat != 0) {            if(isset($subcateg) and isset($categ) and $categ != 0) {                $cache = "subcategi";                if($subcateg != 0) {                    $cacheid = "cat".$cat."|categ".$categ."|subcateg".$subcateg."|item".$itemid;                    $check = 1;                } else {                    $check = 0;                }            } elseif(isset($categ)) {                $cache = "categi";                if($categ != 0) {                    $cacheid = "cat".$cat."|categ".$categ."|item".$itemid;                    $check = 1;                } else {                    $check = 0;                }                $subcateg = 0;            } else {                $cache = "cati";                $cacheid = "cat".$cat."|item".$itemid;                $check = 1;                $categ = 0;                $subcateg = 0;            }        } else {            $cache = "homei";            $cacheid = "home|item".$itemid;            if(!isset($itemid)) {                $itemid = 0;            }            $check = 1;            $cat = 0;            $categ = 0;            $subcateg = 0;        }        if($itemid == 0 or $check == 0) {            $this->registry->main_class->display_theme_adminheader();            $this->registry->main_class->display_theme_adminmain();            $this->registry->main_class->displayadmininfo();            if($itemid == 0) {                $cache = "item";            }            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|no".$cache."|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMEDITTITLE'));                if($itemid == 0) {                    $this->registry->main_class->assign("shop_message","noitem");                } elseif($cache == "cati") {                    $this->registry->main_class->assign("shop_message","nocat");                } elseif($cache == "categi") {                    $this->registry->main_class->assign("shop_message","nocateg");                } elseif($cache == "subcategi") {                    $this->registry->main_class->assign("shop_message","nosubcateg");                }                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|no".$cache."|".$this->registry->language);            exit();        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|edit|".$cacheid."|".$this->registry->language)) {            if($cache == "homei") {                $sql = "SELECT a.item_id as item_id,a.item_img as item_img,a.item_name as item_name,a.item_price as item_price,a.item_price_discounted as item_price_discounted,a.item_catalog_id as item_catalog_id,a.item_category_id as item_category_id,a.item_subcategory_id as item_subcategory_id,a.item_short_description as item_short_description,a.item_description as item_description,a.item_show as item_show,a.item_quantity as item_quantity,a.item_quantity_unlim as item_quantity_unlim,a.item_quantity_param as item_quantity_param,a.item_display as item_display,a.item_date as item_date,a.item_meta_title as item_meta_title,a.item_meta_keywords as item_meta_keywords,a.item_meta_description as item_meta_description,null as catalog_id,null as catalog_name,null as category_id,null as category_name,null as subcategory_id,null as subcategory_name,a.item_position as item_position FROM ".PREFIX."_items_".$this->registry->sitelang." a WHERE a.item_id = ".$itemid." UNION SELECT null as item_id,null as item_img,null as item_name,null as item_price,null as item_price_discounted,null as item_catalog_id,null as item_category_id,null as item_subcategory_id,null as item_short_description,null as item_description,null as item_show,null as item_quantity,null as item_quantity_unlim,null as item_quantity_param,null as item_display,null as item_date,null as item_meta_title,null as item_meta_keywords,null as item_meta_description,b.catalog_id as catalog_id,b.catalog_name as catalog_name,c.category_id as category_id,c.category_name as category_name,d.subcategory_id as subcategory_id,d.subcategory_name as subcategory_name, null as item_position FROM ".PREFIX."_catalogs_".$this->registry->sitelang." b LEFT OUTER JOIN ".PREFIX."_categories_".$this->registry->sitelang." c ON b.catalog_id=c.cat_catalog_id LEFT OUTER JOIN ".PREFIX."_subcategories_".$this->registry->sitelang." d ON c.category_id=d.subcategory_cat_id order by (case WHEN item_id IS NULL THEN 0 ELSE item_id END) DESC,catalog_name ASC,category_name ASC,subcategory_name ASC";            } elseif($cache == "cati") {                $sql = "SELECT a.item_id,a.item_img,a.item_name,a.item_price,a.item_price_discounted,a.item_catalog_id,a.item_category_id,a.item_subcategory_id,a.item_short_description,a.item_description,a.item_show,a.item_quantity,a.item_quantity_unlim,a.item_quantity_param,a.item_display,a.item_date,a.item_meta_title,a.item_meta_keywords,a.item_meta_description,b.catalog_id,b.catalog_name,c.category_id,c.category_name,d.subcategory_id,d.subcategory_name,a.item_position FROM ".PREFIX."_catalogs_".$this->registry->sitelang." b LEFT OUTER JOIN ".PREFIX."_items_".$this->registry->sitelang." a ON b.catalog_id=a.item_catalog_id and b.catalog_id = ".$cat." and a.item_id = ".$itemid." LEFT OUTER JOIN ".PREFIX."_categories_".$this->registry->sitelang." c ON b.catalog_id=c.cat_catalog_id and b.catalog_id = ".$cat." LEFT OUTER JOIN ".PREFIX."_subcategories_".$this->registry->sitelang." d ON  c.category_id=d.subcategory_cat_id order by (case WHEN a.item_id IS NULL THEN 0 ELSE a.item_id END) DESC,b.catalog_name ASC,c.category_name ASC,d.subcategory_name ASC";            } elseif($cache == "categi") {                $sql = "SELECT a.item_id,a.item_img,a.item_name,a.item_price,a.item_price_discounted,a.item_catalog_id,a.item_category_id,a.item_subcategory_id,a.item_short_description,a.item_description,a.item_show,a.item_quantity,a.item_quantity_unlim,a.item_quantity_param,a.item_display,a.item_date,a.item_meta_title,a.item_meta_keywords,a.item_meta_description,b.catalog_id,b.catalog_name,c.category_id,c.category_name,d.subcategory_id,d.subcategory_name,a.item_position FROM ".PREFIX."_catalogs_".$this->registry->sitelang." b LEFT OUTER JOIN ".PREFIX."_categories_".$this->registry->sitelang." c ON b.catalog_id=c.cat_catalog_id and b.catalog_id = ".$cat." LEFT OUTER JOIN ".PREFIX."_items_".$this->registry->sitelang." a ON c.category_id=a.item_category_id and a.item_id = ".$itemid." and c.category_id = ".$categ." LEFT OUTER JOIN ".PREFIX."_subcategories_".$this->registry->sitelang." d ON d.subcategory_cat_id=c.category_id order by (case WHEN a.item_id IS NULL THEN 0 ELSE a.item_id END) DESC,b.catalog_name ASC,c.category_name ASC,d.subcategory_name ASC";            } elseif($cache == "subcategi") {                $sql = "SELECT a.item_id,a.item_img,a.item_name,a.item_price,a.item_price_discounted,a.item_catalog_id,a.item_category_id,a.item_subcategory_id,a.item_short_description,a.item_description,a.item_show,a.item_quantity,a.item_quantity_unlim,a.item_quantity_param,a.item_display,a.item_date,a.item_meta_title,a.item_meta_keywords,a.item_meta_description,b.catalog_id,b.catalog_name,c.category_id,c.category_name,d.subcategory_id,d.subcategory_name,a.item_position FROM ".PREFIX."_catalogs_".$this->registry->sitelang." b LEFT OUTER JOIN ".PREFIX."_categories_".$this->registry->sitelang." c ON b.catalog_id=c.cat_catalog_id and b.catalog_id = ".$cat." LEFT OUTER JOIN ".PREFIX."_subcategories_".$this->registry->sitelang." d ON c.category_id=d.subcategory_cat_id LEFT OUTER JOIN ".PREFIX."_items_".$this->registry->sitelang." a ON d.subcategory_id=a.item_subcategory_id and a.item_id = ".$itemid." and d.subcategory_id = ".$subcateg." and c.category_id = ".$categ." order by (case WHEN a.item_id IS NULL THEN 0 ELSE a.item_id END) DESC,b.catalog_name ASC,c.category_name ASC,d.subcategory_name ASC";            }            $result = $this->db->Execute($sql);            if($result) {                if(isset($result->fields['0'])) {                    $numrows = intval($result->fields['0']);                } else {                    $numrows = 0;                }                if($numrows > 0) {                    require_once('../modules/shop/shop_config.inc');                    while(!$result->EOF) {                        if(isset($result->fields['0']) and intval($result->fields['0']) > 0 and !isset($item_all)) {                            $item_id = intval($result->fields['0']);                            $item_img = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['1']));                            $item_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['2']));                            $item_price = floatval($result->fields['3']);                            $item_price_discounted = floatval($result->fields['4']);                            $item_catalog_id = intval($result->fields['5']);                            $item_category_id = intval($result->fields['6']);                            $item_subcategory_id = intval($result->fields['7']);                            $item_short_description = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['8']));                            $item_description = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['9']));                            $item_position = intval($result->fields['25']);                            $item_show = intval($result->fields['10']);                            $item_quantity = intval($result->fields['11']);                            $item_quantity_unlim = intval($result->fields['12']);                            $item_quantity_param = intval($result->fields['13']);                            $item_display = intval($result->fields['14']);                            $item_date = intval($result->fields['15']);                            $item_date2 = date("d.m.y",$item_date);                            $item_hour = date("H",$item_date);                            $item_minute = date("i",$item_date);                            $item_meta_title = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['16']));                            $item_meta_keywords = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['17']));                            $item_meta_description = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['18']));                            if($cache == "cati" or $cache == "categi" or $cache == "subcategi") {                                $in_catalog_id = intval($result->fields['19']);                                $item_catalog_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['20']));                            } else {                                $in_catalog_id = "no";                                $item_catalog_name = "no";                            }                            if($cache == "categi" or $cache == "subcategi") {                                $in_category_id = intval($result->fields['21']);                                $item_category_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['22']));                            } else {                                $in_category_id = "no";                                $item_category_name = "no";                            }                            if($cache == "subcategi") {                                $in_subcategory_id = intval($result->fields['23']);                                $item_subcategory_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['24']));                            } else {                                $in_subcategory_id = "no";                                $item_subcategory_name = "no";                            }                            $item_all[] = array(                                "item_id" => $item_id,                                "item_img" => $item_img,                                "item_imgpath" => SYSTEMDK_SHOP_ITEMIMAGE_PATH,                                "item_name" => $item_name,                                "item_price" => $item_price,                                "item_price_discounted" => $item_price_discounted,                                "item_catalog_id" => $item_catalog_id,                                "item_category_id" => $item_category_id,                                "item_subcategory_id" => $item_subcategory_id,                                "item_short_description" => $item_short_description,                                "item_description" => $item_description,                                "item_show" => $item_show,                                "item_quantity" => $item_quantity,                                "item_quantity_unlim" => $item_quantity_unlim,                                "item_quantity_param" => $item_quantity_param,                                "item_display" => $item_display,                                "item_date" => $item_date2,                                "item_hour" => $item_hour,                                "item_minute" => $item_minute,                                "item_meta_title" => $item_meta_title,                                "item_meta_keywords" => $item_meta_keywords,                                "item_meta_description" => $item_meta_description,                                "in_catalog_id" => $in_catalog_id,                                "item_catalog_name" => $item_catalog_name,                                "in_category_id" => $in_category_id,                                "item_category_name" => $item_category_name,                                "in_subcategory_id" => $in_subcategory_id,                                "item_subcategory_name" => $item_subcategory_name,                                "item_position" => $item_position                            );                        }                        if(isset($result->fields['19']) and intval($result->fields['19']) > 0) {                            $catalog_id = intval($result->fields['19']);                            $catalog_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['20']));                            $catalog_all_now = array("catalog_id" => $catalog_id,"catalog_name" => $catalog_name);                            if(!isset($catalogs_all) or (isset($catalogs_all) and !in_array($catalog_all_now,$catalogs_all))) {                                $catalogs_all[] = array("catalog_id" => $catalog_id,"catalog_name" => $catalog_name);                            }                        }                        if(isset($result->fields['21']) and intval($result->fields['21']) > 0) {                            $category_id = intval($result->fields['21']);                            $category_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['22']));                            $category_all_now = array("category_id" => $category_id,"category_name" => $category_name);                            if(!isset($categories_all) or (isset($categories_all) and !in_array($category_all_now,$categories_all))) {                                $categories_all[] = array(                                    "category_id" => $category_id,                                    "category_name" => $category_name                                );                            }                        }                        if(isset($result->fields['23']) and intval($result->fields['23']) > 0) {                            $subcategory_id = intval($result->fields['23']);                            $subcategory_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['24']));                            $subcategories_all[] = array(                                "subcategory_id" => $subcategory_id,                                "subcategory_name" => $subcategory_name                            );                        }                        $result->MoveNext();                    }                    $this->registry->main_class->assign("item_all",$item_all);                    $this->registry->main_class->assign("adminmodules_shop_item_id",$item_id);                    $this->registry->main_class->assign("adminmodules_shop_cat",$cat);                    $this->registry->main_class->assign("adminmodules_shop_categ",$categ);                    $this->registry->main_class->assign("adminmodules_shop_subcateg",$subcateg);                    if(isset($catalogs_all)) {                        $this->registry->main_class->assign("catalogs_all",$catalogs_all);                    }                    if(isset($categories_all)) {                        $this->registry->main_class->assign("categories_all",$categories_all);                    }                    if(isset($subcategories_all)) {                        $this->registry->main_class->assign("subcategories_all",$subcategories_all);                    }                } else {                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound2item|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMEDITTITLE'));                        $this->registry->main_class->assign("shop_message","notfounditem");                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound2item|".$this->registry->language);                    exit();                }            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);                $this->registry->main_class->assign("error",$error);                if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerroritem|".$this->registry->language)) {                    $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMEDITTITLE'));                    $this->registry->main_class->assign("shop_message","sqlerror");                    $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                    $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                }                $this->registry->main_class->database_close();                $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerroritem|".$this->registry->language);                exit();            }            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMEDITTITLE'));            $this->registry->main_class->assign("adminmodules_shop_depth",$cache);            $this->registry->main_class->assign("include_jquery","yes");            $this->registry->main_class->assign("include_jquery_data","dateinput");            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_item_edit.html");        }        $this->registry->main_class->database_close();        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|edit|".$cacheid."|".$this->registry->language);    }    public function shop_editi_inbase() {        if(isset($_POST['item_id'])) {            $item_id = intval($_POST['item_id']);        }        if(isset($_POST['item_img'])) {            $item_img = trim($_POST['item_img']);        }        if(isset($_POST['item_action_img'])) {            $item_action_img = trim($_POST['item_action_img']);        }        if(isset($_POST['item_name'])) {            $item_name = trim($_POST['item_name']);        }        if(isset($_POST['item_price'])) {            $item_price = $this->registry->main_class->float2db($_POST['item_price']);        }        if(isset($_POST['item_price_discounted'])) {            $item_price_discounted = $this->registry->main_class->float2db($_POST['item_price_discounted']);        }        if(isset($_POST['item_home'])) {            $item_home = intval($_POST['item_home']);        }        if(isset($_POST['item_catalog'])) {            $item_catalog = intval($_POST['item_catalog']);        }        if(isset($_POST['item_catalog_old'])) {            $item_catalog_old = intval($_POST['item_catalog_old']);        }        if(isset($_POST['item_category'])) {            $item_category = intval($_POST['item_category']);        }        if(isset($_POST['item_category_old'])) {            $item_category_old = intval($_POST['item_category_old']);        }        if(isset($_POST['item_subcategory'])) {            $item_subcategory = intval($_POST['item_subcategory']);        }        if(isset($_POST['item_subcategory_old'])) {            $item_subcategory_old = intval($_POST['item_subcategory_old']);        }        if(isset($_POST['item_short_description'])) {            $item_short_description = trim($_POST['item_short_description']);        }        if(isset($_POST['item_description'])) {            $item_description = trim($_POST['item_description']);        }        if(isset($_POST['item_position'])) {            $item_position = intval($_POST['item_position']);        }        if(isset($_POST['item_show'])) {            $item_show = intval($_POST['item_show']);        }        if(isset($_POST['item_quantity'])) {            $item_quantity = intval($_POST['item_quantity']);        }        if(isset($_POST['item_quantity_unlim'])) {            $item_quantity_unlim = intval($_POST['item_quantity_unlim']);        }        if(isset($_POST['item_quantity_param'])) {            $item_quantity_param = intval($_POST['item_quantity_param']);        }        if(isset($_POST['item_display'])) {            $item_display = intval($_POST['item_display']);        }        if(isset($_POST['item_display_old'])) {            $item_display_old = intval($_POST['item_display_old']);        }        if(isset($_POST['item_date'])) {            $item_date = trim($_POST['item_date']);        }        if(isset($_POST['item_hour'])) {            $item_hour = intval($_POST['item_hour']);        } else {            $item_hour = 0;        }        if(isset($_POST['item_minute'])) {            $item_minute = intval($_POST['item_minute']);        } else {            $item_minute = 0;        }        if(isset($_POST['item_meta_title'])) {            $item_meta_title = trim($_POST['item_meta_title']);        }        if(isset($_POST['item_meta_keywords'])) {            $item_meta_keywords = trim($_POST['item_meta_keywords']);        }        if(isset($_POST['item_meta_description'])) {            $item_meta_description = trim($_POST['item_meta_description']);        }        if(isset($_POST['depth'])) {            $depth = intval($_POST['depth']);        }        if(isset($depth) and $depth == 1) {            $cache = "cati";        } elseif(isset($depth) and $depth == 2) {            $cache = "categi";        } elseif(isset($depth) and $depth == 3) {            $cache = "subcategi";        } else {            $cache = "homei";        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if((!isset($_POST['item_id']) or !isset($_POST['item_action_img']) or !isset($_POST['item_name']) or !isset($_POST['item_price']) or !isset($_POST['item_price_discounted']) or !isset($_POST['item_home']) or !isset($_POST['item_catalog']) or !isset($_POST['item_category']) or !isset($_POST['item_subcategory']) or !isset($_POST['item_short_description']) or !isset($_POST['item_description']) or !isset($_POST['item_position']) or !isset($_POST['item_show']) or !isset($_POST['item_quantity']) or !isset($_POST['item_quantity_unlim']) or !isset($_POST['item_quantity_param']) or !isset($_POST['item_display']) or !isset($_POST['item_display_old']) or !isset($_POST['item_date']) or !isset($_POST['item_hour']) or !isset($_POST['item_minute']) or !isset($_POST['item_meta_title']) or !isset($_POST['item_meta_keywords']) or !isset($_POST['item_meta_description'])) or ($item_id == 0 or $item_name == "" or $item_short_description == "" or $item_description == "" or $item_date == "" or ($cache == "cati" and (!isset($item_catalog) or !isset($item_catalog_old) or $item_catalog == 0 or $item_catalog_old == 0)) or ($cache == "categi" and (!isset($item_category) or !isset($item_category_old) or !isset($item_catalog_old) or $item_category == 0 or $item_category_old == 0 or $item_catalog_old == 0)) or ($cache == "subcategi" and (!isset($item_subcategory) or !isset($item_subcategory_old) or !isset($item_category_old) or !isset($item_catalog_old) or $item_subcategory == 0 or $item_subcategory_old == 0 or $item_category_old == 0 or $item_catalog_old == 0)))) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notalldatai|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMEDITTITLE'));                $this->registry->main_class->assign("shop_message","notalldata");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notalldatai|".$this->registry->language);            exit();        }        $item_action_img = $this->registry->main_class->format_striptags($item_action_img);        require_once('../modules/shop/shop_config.inc');        if($item_action_img == 'del') {            $item_img = $this->registry->main_class->format_striptags($item_img);            if(@unlink("../".SYSTEMDK_SHOP_ITEMIMAGE_PATH."/".$item_img) or !is_file("../".SYSTEMDK_SHOP_ITEMIMAGE_PATH."/".$item_img)) {                $item_img = 'NULL';            } else {                if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|img".$cache."|".$this->registry->language)) {                    $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMEDITTITLE'));                    $this->registry->main_class->assign("shop_message","notdelimg");                    $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                    $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                }                $this->registry->main_class->database_close();                $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|img".$cache."|".$this->registry->language);                exit();            }        } elseif($item_action_img == 'new_file') {            if(isset($_FILES['item_img']['name']) and trim($_FILES['item_img']['name']) !== '') {                if(is_uploaded_file($_FILES['item_img']['tmp_name'])) {                    if($_FILES['item_img']['size'] > SYSTEMDK_SHOP_ITEMIMAGE_MAXSIZE) {                        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editmaxsizeitem|".$this->registry->language)) {                            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMEDITTITLE'));                            $this->registry->main_class->assign("shop_message","maxsizeerror");                            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                        }                        $this->registry->main_class->database_close();                        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editmaxsizeitem|".$this->registry->language);                        exit();                    }                    if(($_FILES['item_img']['type'] == "image/gif") or ($_FILES['item_img']['type'] == "image/jpg") or ($_FILES['item_img']['type'] == "image/jpeg") or ($_FILES['item_img']['type'] == "image/pjpeg") or ($_FILES['item_img']['type'] == "image/png") or ($_FILES['item_img']['type'] == "image/bmp")) {                        $this->registry->main_class->set_locale();                        if(basename($this->registry->main_class->format_striptags($_FILES['item_img']['name'])) != "") {                            $item_img = date("dmY",time())."_".basename($this->registry->main_class->format_striptags($_FILES['item_img']['name']));                        } else {                            $item_img = "";                        }                        if(file_exists($item_img) and $item_img != "") {                            @unlink("../".SYSTEMDK_SHOP_ITEMIMAGE_PATH."/".$item_img);                        }                        if($item_img == "" or !@copy($_FILES['item_img']['tmp_name'],"../".SYSTEMDK_SHOP_ITEMIMAGE_PATH."/".$item_img)) {                            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editnotuploaditem|".$this->registry->language)) {                                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMEDITTITLE'));                                $this->registry->main_class->assign("shop_message","notuploadfile");                                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                            }                            $this->registry->main_class->database_close();                            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editnotuploaditem|".$this->registry->language);                            exit();                        }                        $item_size2 = @getimagesize("../".SYSTEMDK_SHOP_ITEMIMAGE_PATH."/".$item_img);                        if(($item_size2[0] > SYSTEMDK_SHOP_ITEMIMAGE_MAXWIDTH) or ($item_size2[1] > SYSTEMDK_SHOP_ITEMIMAGE_MAXHEIGHT)) {                            @unlink("../".SYSTEMDK_SHOP_ITEMIMAGE_PATH."/".$item_img);                            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editnoteqitem|".$this->registry->language)) {                                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMEDITTITLE'));                                $this->registry->main_class->assign("shop_message","noteq");                                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                            }                            $this->registry->main_class->database_close();                            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editnoteqitem|".$this->registry->language);                            exit();                        }                    } else {                        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editnoteqtypeitem|".$this->registry->language)) {                            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMEDITTITLE'));                            $this->registry->main_class->assign("shop_message","noteqtype");                            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                        }                        $this->registry->main_class->database_close();                        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editnoteqtypeitem|".$this->registry->language);                        exit();                    }                } else {                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editfileitem|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMEDITTITLE'));                        $this->registry->main_class->assign("shop_message","uploadfileerror");                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editfileitem|".$this->registry->language);                    exit();                }                $item_img = $this->registry->main_class->processing_data($item_img,'need');            } else {                $item_img = 'NULL';            }        } else {            $item_img = $this->registry->main_class->format_striptags($item_img);            $item_img = $this->registry->main_class->processing_data($item_img);        }        $item_name = $this->registry->main_class->format_striptags($item_name);        $item_name = $this->registry->main_class->processing_data($item_name);        if(intval($item_price_discounted) == 0) {            $item_price_discounted = 'NULL';        } else {            $item_price_discounted = "'".$item_price_discounted."'";        }        if($cache == "homei") {            if($item_catalog > 0) {                $item_catalog_id = "'".$item_catalog."'";                $item_category_id = 'NULL';                $item_subcategory_id = 'NULL';                $item_display = 'NULL';                $where1 = "item_position > 0 and item_position > ".$item_position." and item_catalog_id is NULL and item_category_id is NULL and item_subcategory_id is NULL";                $where2 = "item_catalog_id = ".$item_catalog;            } elseif($item_category > 0) {                $item_catalog_id = 'NULL';                $item_category_id = "'".$item_category."'";                $item_subcategory_id = 'NULL';                $item_display = 'NULL';                $where1 = "item_position > 0 and item_position > ".$item_position." and item_catalog_id is NULL and item_category_id is NULL and item_subcategory_id is NULL";                $where2 = "item_category_id = ".$item_category;            } elseif($item_subcategory > 0) {                $item_catalog_id = 'NULL';                $item_category_id = 'NULL';                $item_subcategory_id = "'".$item_subcategory."'";                $item_display = 'NULL';                $where1 = "item_position > 0 and item_position > ".$item_position." and item_catalog_id is NULL and item_category_id is NULL and item_subcategory_id is NULL";                $where2 = "item_subcategory_id = ".$item_subcategory;            } else {                $item_catalog_id = 'NULL';                $item_category_id = 'NULL';                $item_subcategory_id = 'NULL';            }        } elseif($cache == "cati") {            if($item_home > 0) {                $item_catalog_id = 'NULL';                $item_category_id = 'NULL';                $item_subcategory_id = 'NULL';                $item_display = 'NULL';                $where1 = "item_position > 0 and item_position > ".$item_position." and item_catalog_id = ".$item_catalog_old;                $where2 = "item_catalog_id is NULL and item_category_id is NULL and item_subcategory_id is NULL";            } elseif($item_category > 0) {                $item_catalog_id = 'NULL';                $item_category_id = "'".$item_category."'";                $item_subcategory_id = 'NULL';                $item_display = 'NULL';                $where1 = "item_position > 0 and item_position > ".$item_position." and item_catalog_id = ".$item_catalog_old;                $where2 = "item_category_id = ".$item_category;            } elseif($item_subcategory > 0) {                $item_catalog_id = 'NULL';                $item_category_id = 'NULL';                $item_subcategory_id = "'".$item_subcategory."'";                $item_display = 'NULL';                $where1 = "item_position > 0 and item_position > ".$item_position." and item_catalog_id = ".$item_catalog_old;                $where2 = "item_subcategory_id = ".$item_subcategory;            } else {                $item_catalog_id = "'".$item_catalog."'";                $item_category_id = 'NULL';                $item_subcategory_id = 'NULL';                if($item_catalog != $item_catalog_old) {                    $where1 = "item_position > 0 and item_position > ".$item_position." and item_catalog_id = ".$item_catalog_old;                    $where2 = "item_catalog_id = ".$item_catalog;                }            }        } elseif($cache == "categi") {            if($item_home > 0) {                $item_catalog_id = 'NULL';                $item_category_id = 'NULL';                $item_subcategory_id = 'NULL';                $item_display = 'NULL';                $where1 = "item_position > 0 and item_position > ".$item_position." and item_category_id = ".$item_category_old;                $where2 = "item_catalog_id is NULL and item_category_id is NULL and item_subcategory_id is NULL";            } elseif($item_catalog > 0) {                $item_catalog_id = "'".$item_catalog."'";                $item_category_id = 'NULL';                $item_subcategory_id = 'NULL';                $item_display = 'NULL';                $where1 = "item_position > 0 and item_position > ".$item_position." and item_category_id = ".$item_category_old;                $where2 = "item_catalog_id = ".$item_catalog;            } elseif($item_subcategory > 0) {                $item_catalog_id = 'NULL';                $item_category_id = 'NULL';                $item_subcategory_id = "'".$item_subcategory."'";                $item_display = 'NULL';                $where1 = "item_position > 0 and item_position > ".$item_position." and item_category_id = ".$item_category_old;                $where2 = "item_subcategory_id = ".$item_subcategory;            } else {                $item_catalog_id = 'NULL';                $item_category_id = "'".$item_category."'";                $item_subcategory_id = 'NULL';                if($item_category != $item_category_old) {                    $where1 = "item_position > 0 and item_position > ".$item_position." and item_category_id = ".$item_category_old;                    $where2 = "item_category_id = ".$item_category;                }            }        } elseif($cache == "subcategi") {            if($item_home > 0) {                $item_catalog_id = 'NULL';                $item_category_id = 'NULL';                $item_subcategory_id = 'NULL';                $item_display = 'NULL';                $where1 = "item_position > 0 and item_position > ".$item_position." and item_subcategory_id = ".$item_subcategory_old;                $where2 = "item_catalog_id is NULL and item_category_id is NULL and item_subcategory_id is NULL";            } elseif($item_catalog > 0) {                $item_catalog_id = "'".$item_catalog."'";                $item_category_id = 'NULL';                $item_subcategory_id = 'NULL';                $item_display = 'NULL';                $where1 = "item_position > 0 and item_position > ".$item_position." and item_subcategory_id = ".$item_subcategory_old;                $where2 = "item_catalog_id = ".$item_catalog;            } elseif($item_category > 0) {                $item_catalog_id = 'NULL';                $item_category_id = "'".$item_category."'";                $item_subcategory_id = 'NULL';                $item_display = 'NULL';                $where1 = "item_position > 0 and item_position > ".$item_position." and item_subcategory_id = ".$item_subcategory_old;                $where2 = "item_category_id = ".$item_category;            } else {                $item_catalog_id = 'NULL';                $item_category_id = 'NULL';                $item_subcategory_id = "'".$item_subcategory."'";                if($item_subcategory != $item_subcategory_old) {                    $where1 = "item_position > 0 and item_position > ".$item_position." and item_subcategory_id = ".$item_subcategory_old;                    $where2 = "item_subcategory_id = ".$item_subcategory;                }            }        }        //$item_short_description = $this->registry->main_class->format_striptags($item_short_description);        if($item_short_description != "") {            $item_short_description = $this->registry->main_class->processing_data($item_short_description);        } else {            $item_short_description = 'NULL';        }        //$item_description = $this->registry->main_class->format_striptags($item_description);        if($item_description != "") {            $item_description = $this->registry->main_class->processing_data($item_description);        } else {            $item_description = 'NULL';        }        if($item_quantity == 0) {            $item_quantity = 'NULL';        } else {            $item_quantity = "'".$item_quantity."'";        }        if($item_quantity_param == 0) {            $item_quantity_param = 'NULL';        } else {            $item_quantity_param = "'".$item_quantity_param."'";        }        if($item_display == 0) {            $item_display = 'NULL';        } else {            $item_display = "'".$item_display."'";        }        $item_date = $this->registry->main_class->format_striptags($item_date);        $item_date = $item_date.".".$item_hour.".".$item_minute;        $item_date = $this->registry->main_class->timetounix($item_date);        $item_meta_title = $this->registry->main_class->format_striptags($item_meta_title);        if($item_meta_title != "") {            $item_meta_title = $this->registry->main_class->processing_data($item_meta_title);        } else {            $item_meta_title = 'NULL';        }        $item_meta_keywords = $this->registry->main_class->format_striptags($item_meta_keywords);        if($item_meta_keywords != "") {            $item_meta_keywords = $this->registry->main_class->processing_data($item_meta_keywords);        } else {            $item_meta_keywords = 'NULL';        }        $item_meta_description = $this->registry->main_class->format_striptags($item_meta_description);        if($item_meta_description != "") {            $item_meta_description = $this->registry->main_class->processing_data($item_meta_description);        } else {            $item_meta_description = 'NULL';        }        $this->db->StartTrans();        if(isset($where1) and isset($where2)) {            $result4 = $this->db->Execute("UPDATE ".PREFIX."_items_".$this->registry->sitelang." SET item_position=item_position-1 WHERE ".$where1);            if($result4 === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            $sql2 = "SELECT max(item_position)+1 FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE ".$where2;            $result5 = $this->db->Execute($sql2);            if($result5) {                if(isset($result5->fields['0'])) {                    $item_position = intval($result5->fields['0']);                } else {                    $item_position = 0;                }            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }        }        $check_db_need_lobs = $this->registry->main_class->check_db_need_lobs();        if($check_db_need_lobs == 'yes') {            $sql = "UPDATE ".PREFIX."_items_".$this->registry->sitelang." SET item_img = ".$item_img.",item_name = ".$item_name.",item_price = '".$item_price."',item_price_discounted = ".$item_price_discounted.",item_catalog_id = ".$item_catalog_id.",item_category_id = ".$item_category_id.",item_subcategory_id = ".$item_subcategory_id.",item_short_description = empty_clob(),item_description = empty_clob(),item_position = '".$item_position."',item_show = '".$item_show."',item_quantity = ".$item_quantity.",item_quantity_unlim = '".$item_quantity_unlim."',item_quantity_param = ".$item_quantity_param.",item_display = ".$item_display.",item_date = '".$item_date."',item_meta_title = ".$item_meta_title.",item_meta_keywords = ".$item_meta_keywords.",item_meta_description = ".$item_meta_description." WHERE item_id = ".$item_id;            $result = $this->db->Execute($sql);            $num_result = $this->db->Affected_Rows();            if($result === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            $item_short_description = substr(substr($item_short_description,0,-1),1);            $result2 = $this->db->UpdateClob(PREFIX.'_items_'.$this->registry->sitelang,'item_short_description',$item_short_description,'item_id='.$item_id);            if($result2 === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            $item_description = substr(substr($item_description,0,-1),1);            $result3 = $this->db->UpdateClob(PREFIX.'_items_'.$this->registry->sitelang,'item_description',$item_description,'item_id='.$item_id);            if($result3 === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            if($result2 === false or $result3 === false or (isset($result4) and $result4 === false) or (isset($result5) and $result5 === false)) {                $result = false;            }        } else {            $sql = "UPDATE ".PREFIX."_items_".$this->registry->sitelang." SET item_img = ".$item_img.",item_name = ".$item_name.",item_price = '".$item_price."',item_price_discounted = ".$item_price_discounted.",item_catalog_id = ".$item_catalog_id.",item_category_id = ".$item_category_id.",item_subcategory_id = ".$item_subcategory_id.",item_short_description = ".$item_short_description.",item_description = ".$item_description.",item_position = '".$item_position."',item_show = '".$item_show."',item_quantity = ".$item_quantity.",item_quantity_unlim = '".$item_quantity_unlim."',item_quantity_param = ".$item_quantity_param.",item_display = ".$item_display.",item_date = '".$item_date."',item_meta_title = ".$item_meta_title.",item_meta_keywords = ".$item_meta_keywords.",item_meta_description = ".$item_meta_description." WHERE item_id = ".$item_id;            $result = $this->db->Execute($sql);            $num_result = $this->db->Affected_Rows();            if($result === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            if((isset($result4) and $result4 === false) or (isset($result5) and $result5 === false)) {                $result = false;            }        }        $this->db->CompleteTrans();        if($result === false) {            $this->registry->main_class->assign("error",$error);            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editsqlerroritem|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMEDITTITLE'));                $this->registry->main_class->assign("shop_message","sqlerror");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editsqlerroritem|".$this->registry->language);            exit();        } elseif($result !== false and $num_result == 0) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editokitem|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMEDITTITLE'));                $this->registry->main_class->assign("shop_message","notsave");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|editokitem|".$this->registry->language);            exit();        } else {            if($cache == "homei") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|home|items");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|home|item".$item_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|home");                if($item_catalog > 0) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog."|items");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                } elseif($item_category > 0) {                    $item_catalog = $this->shop_getdepthinfo($item_category,2);                    if(isset($item_catalog['0'])) {                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog['0']."|categ".$item_category."|items");                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog['0']."|categ".$item_category);                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog['0']."|categ".$item_category);                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog['0']."|categ".$item_category);                    }                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                } elseif($item_subcategory > 0) {                    $item_catalog = $this->shop_getdepthinfo($item_subcategory,3);                    if(isset($item_catalog['0']) and isset($item_catalog['1'])) {                        $item_category = $item_catalog['0'];                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog['1']."|categ".$item_category."|subcateg".$item_subcategory."|items");                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog['1']."|categ".$item_category."|subcateg".$item_subcategory);                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog['1']."|categ".$item_category."|subcateg".$item_subcategory);                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog['1']."|categ".$item_category."|subcateg".$item_subcategory);                    }                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                }            } elseif($cache == "cati") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog_old."|items");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog."|items");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog);                if($item_display == "'3'" or $item_display_old == 3) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                }                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$item_catalog_old."|item".$item_id);                if($item_home > 0) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|home|items");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                } elseif($item_category > 0) {                    $item_catalog = $this->shop_getdepthinfo($item_category,2);                    if(isset($item_catalog['0'])) {                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog['0']."|categ".$item_category."|items");                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog['0']."|categ".$item_category);                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog['0']."|categ".$item_category);                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog['0']."|categ".$item_category);                    }                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                } elseif($item_subcategory > 0) {                    $item_catalog = $this->shop_getdepthinfo($item_subcategory,3);                    if(isset($item_catalog['0']) and isset($item_catalog['1'])) {                        $item_category = $item_catalog['0'];                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog['1']."|categ".$item_category."|subcateg".$item_subcategory."|items");                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog['1']."|categ".$item_category."|subcateg".$item_subcategory);                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog['1']."|categ".$item_category."|subcateg".$item_subcategory);                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog['1']."|categ".$item_category."|subcateg".$item_subcategory);                    }                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                }            } elseif($cache == "categi") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog_old."|categ".$item_category_old."|items");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog_old."|categ".$item_category."|items");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$item_catalog_old."|categ".$item_category_old."|item".$item_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog_old."|categ".$item_category_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog_old."|categ".$item_category);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog_old."|categ".$item_category_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog_old."|categ".$item_category_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog_old."|categ".$item_category);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog_old."|categ".$item_category);                if($item_display == "'3'" or $item_display_old == 3) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog_old);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog_old);                } elseif($item_display == "'2'" or $item_display_old == 2) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog_old);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog_old);                }                if($item_home > 0) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|home|items");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                } elseif($item_catalog > 0) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog."|items");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                } elseif($item_subcategory > 0) {                    $item_catalog = $this->shop_getdepthinfo($item_subcategory,3);                    if(isset($item_catalog['0']) and isset($item_catalog['1'])) {                        $item_category = $item_catalog['0'];                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog['1']."|categ".$item_category."|subcateg".$item_subcategory."|items");                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog['1']."|categ".$item_category."|subcateg".$item_subcategory);                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog['1']."|categ".$item_category."|subcateg".$item_subcategory);                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog['1']."|categ".$item_category."|subcateg".$item_subcategory);                    }                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                }            } elseif($cache == "subcategi") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog_old."|categ".$item_category_old."|subcateg".$item_subcategory_old."|items");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog_old."|categ".$item_category_old."|subcateg".$item_subcategory."|items");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog_old."|categ".$item_category_old."|subcateg".$item_subcategory_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog_old."|categ".$item_category_old."|subcateg".$item_subcategory);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$item_catalog_old."|categ".$item_category_old."|subcateg".$item_subcategory_old."|item".$item_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog_old."|categ".$item_category_old."|subcateg".$item_subcategory_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog_old."|categ".$item_category_old."|subcateg".$item_subcategory_old);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog_old."|categ".$item_category_old."|subcateg".$item_subcategory);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog_old."|categ".$item_category_old."|subcateg".$item_subcategory);                if($item_display == "'3'" or $item_display_old == 3) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog_old);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog_old);                } elseif($item_display == "'2'" or $item_display_old == 2) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog_old);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog_old);                } elseif($item_display == "'1'" or $item_display_old == 1) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog_old."|categ".$item_category_old);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog_old."|categ".$item_category_old);                }                if($item_home > 0) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|home|items");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                } elseif($item_catalog > 0) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog."|items");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                } elseif($item_category > 0) {                    $item_catalog = $this->shop_getdepthinfo($item_category,2);                    if(isset($item_catalog['0'])) {                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog['0']."|categ".$item_category."|items");                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog['0']."|categ".$item_category);                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog['0']."|categ".$item_category);                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog['0']."|categ".$item_category);                    }                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                }            }            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|editokitem|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMEDITTITLE'));                $this->registry->main_class->assign("shop_message","editokitem");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|editokitem|".$this->registry->language);        }    }    private function shop_getdepthinfo($shop_depth_id,$depth = 0) {        $shop_depth_id = intval($shop_depth_id);        $depth = intval($depth);        if($shop_depth_id != 0 and $depth != 0 and ($depth == 2 or $depth == 3)) {            if($depth == 2) {                $sql = "SELECT cat_catalog_id FROM ".PREFIX."_categories_".$this->registry->sitelang." WHERE category_id=".$shop_depth_id;            } elseif($depth == 3) {                $sql = "SELECT b.subcategory_cat_id,a.cat_catalog_id FROM ".PREFIX."_subcategories_".$this->registry->sitelang." b,".PREFIX."_categories_".$this->registry->sitelang." a WHERE b.subcategory_cat_id=a.category_id and b.subcategory_id=".$shop_depth_id;            }            $result = $this->db->Execute($sql);            if($result) {                if(isset($result->fields['0']) and intval($result->fields['0']) > 0) {                    $depthinfo = $result->fields;                }            }        }        if(isset($depthinfo)) {            return $depthinfo;        } else {            return 0;        }    }    public function shop_add_item() {        if(isset($_GET['cat'])) {            $cat = intval($_GET['cat']);        }        if(isset($_GET['categ'])) {            $categ = intval($_GET['categ']);        }        if(isset($_GET['subcateg'])) {            $subcateg = intval($_GET['subcateg']);        }        if(isset($cat) and $cat != 0) {            if(isset($subcateg) and isset($categ) and $categ != 0) {                $cache = "subcategi";                if($subcateg != 0) {                    $cacheid = "cat".$cat."|categ".$categ."|subcateg".$subcateg."|item";                    $check = 1;                } else {                    $check = 0;                }            } elseif(isset($categ)) {                $cache = "categi";                if($categ != 0) {                    $cacheid = "cat".$cat."|categ".$categ."|item";                    $check = 1;                } else {                    $check = 0;                }                $subcateg = 0;            } else {                $cache = "cati";                $cacheid = "cat".$cat."|item";                $check = 1;                $categ = 0;                $subcateg = 0;            }        } elseif(isset($cat) and $cat == 0) {            $cache = "cati";            $check = 0;            $categ = 0;            $subcateg = 0;        } else {            $cache = "homei";            $cacheid = "home|item";            $check = 1;            $cat = 0;            $categ = 0;            $subcateg = 0;        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if($check == 0) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|no2".$cache."|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMADDTITLE'));                if($cache == "cati") {                    $this->registry->main_class->assign("shop_message","nocat");                } elseif($cache == "categi") {                    $this->registry->main_class->assign("shop_message","nocateg");                } elseif($cache == "subcategi") {                    $this->registry->main_class->assign("shop_message","nosubcateg");                }                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|no2".$cache."|".$this->registry->language);            exit();        }        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|add|".$cacheid."|".$this->registry->language)) {            if($cache == "cati" or $cache == "categi" or $cache == "subcategi") {                if($cache == "cati") {                    $sql = "SELECT a.catalog_id,a.catalog_name FROM ".PREFIX."_catalogs_".$this->registry->sitelang." a order by a.catalog_name ASC";                } elseif($cache == "categi") {                    $sql = "SELECT a.catalog_id,a.catalog_name,b.category_id,b.category_name FROM ".PREFIX."_catalogs_".$this->registry->sitelang." a,".PREFIX."_categories_".$this->registry->sitelang." b WHERE a.catalog_id=b.cat_catalog_id and a.catalog_id = ".$cat." order by b.category_name ASC";                } elseif($cache == "subcategi") {                    $sql = "SELECT a.catalog_id,a.catalog_name,b.category_id,b.category_name,c.subcategory_id,c.subcategory_name FROM ".PREFIX."_catalogs_".$this->registry->sitelang." a,".PREFIX."_categories_".$this->registry->sitelang." b,".PREFIX."_subcategories_".$this->registry->sitelang." c WHERE a.catalog_id=b.cat_catalog_id and a.catalog_id = ".$cat." and b.category_id=c.subcategory_cat_id and b.category_id = ".$categ." order by c.subcategory_name ASC";                }                $result = $this->db->Execute($sql);                if($result) {                    if(isset($result->fields['0'])) {                        $numrows = intval($result->fields['0']);                    } else {                        $numrows = 0;                    }                    if($numrows > 0) {                        while(!$result->EOF) {                            if(isset($result->fields['0']) and intval($result->fields['0']) > 0) {                                $catalog_id = intval($result->fields['0']);                                $catalog_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['1']));                                $catalog_all_now = array("catalog_id" => $catalog_id,"catalog_name" => $catalog_name);                                if(!isset($catalogs_all) or (isset($catalogs_all) and !in_array($catalog_all_now,$catalogs_all))) {                                    $catalogs_all[] = array(                                        "catalog_id" => $catalog_id,                                        "catalog_name" => $catalog_name                                    );                                }                                if($catalog_id == $cat) {                                    $in_catalog_name = $catalog_name;                                }                            }                            if(($cache == "categi" or $cache == "subcategi") and isset($result->fields['2']) and intval($result->fields['2']) > 0) {                                $category_id = intval($result->fields['2']);                                $category_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['3']));                                $category_all_now = array(                                    "category_id" => $category_id,                                    "category_name" => $category_name                                );                                if(!isset($categories_all) or (isset($categories_all) and !in_array($category_all_now,$categories_all))) {                                    $categories_all[] = array(                                        "category_id" => $category_id,                                        "category_name" => $category_name                                    );                                }                                if($category_id == $categ) {                                    $in_category_name = $category_name;                                }                            }                            if($cache == "subcategi" and isset($result->fields['4']) and intval($result->fields['4']) > 0) {                                $subcategory_id = intval($result->fields['4']);                                $subcategory_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['5']));                                $subcategories_all[] = array(                                    "subcategory_id" => $subcategory_id,                                    "subcategory_name" => $subcategory_name                                );                                if($subcategory_id == $subcateg) {                                    $in_subcategory_name = $subcategory_name;                                }                            }                            $result->MoveNext();                        }                        if((!isset($in_catalog_name) and $cache == "cati") or (!isset($in_category_name) and $cache == "categi") or (!isset($in_subcategory_name) and $cache == "subcategi")) {                            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound2".$cache."|".$this->registry->language)) {                                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMADDTITLE'));                                if($cache == "cati") {                                    $this->registry->main_class->assign("shop_message","notfoundcatalog");                                } elseif($cache == "categi") {                                    $this->registry->main_class->assign("shop_message","notfoundcateg");                                } elseif($cache == "subcategi") {                                    $this->registry->main_class->assign("shop_message","notfoundsubcateg");                                }                                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                            }                            $this->registry->main_class->database_close();                            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound2".$cache."|".$this->registry->language);                            exit();                        }                        $this->registry->main_class->assign("adminmodules_shop_cat",$cat);                        $this->registry->main_class->assign("adminmodules_shop_categ",$categ);                        $this->registry->main_class->assign("adminmodules_shop_subcateg",$subcateg);                        $this->registry->main_class->assign("adminmodules_shop_cat_name",$in_catalog_name);                        if(isset($in_category_name)) {                            $this->registry->main_class->assign("adminmodules_shop_categ_name",$in_category_name);                        }                        if(isset($in_subcategory_name)) {                            $this->registry->main_class->assign("adminmodules_shop_subcateg_name",$in_subcategory_name);                        }                        if(isset($catalogs_all)) {                            $this->registry->main_class->assign("catalogs_all",$catalogs_all);                        }                        if(isset($categories_all)) {                            $this->registry->main_class->assign("categories_all",$categories_all);                        }                        if(isset($subcategories_all)) {                            $this->registry->main_class->assign("subcategories_all",$subcategories_all);                        }                    } else {                        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound2".$cache."|".$this->registry->language)) {                            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMADDTITLE'));                            if($cache == "cati") {                                $this->registry->main_class->assign("shop_message","notfoundcatalog");                            } elseif($cache == "categi") {                                $this->registry->main_class->assign("shop_message","notfoundcateg");                            } elseif($cache == "subcategi") {                                $this->registry->main_class->assign("shop_message","notfoundsubcateg");                            }                            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                        }                        $this->registry->main_class->database_close();                        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound2".$cache."|".$this->registry->language);                        exit();                    }                } else {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                    $this->registry->main_class->assign("error",$error);                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerroritem2|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMADDTITLE'));                        $this->registry->main_class->assign("shop_message","sqlerror");                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerroritem2|".$this->registry->language);                    exit();                }            }            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMADDTITLE'));            $this->registry->main_class->assign("adminmodules_shop_depth",$cache);            $this->registry->main_class->assign("include_jquery","yes");            $this->registry->main_class->assign("include_jquery_data","dateinput");            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_item_add.html");        }        $this->registry->main_class->database_close();        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|add|".$cacheid."|".$this->registry->language);    }    public function shop_addi_inbase() {        if(isset($_POST['item_img'])) {            $item_img = trim($_POST['item_img']);        }        if(isset($_POST['item_action_img'])) {            $item_action_img = trim($_POST['item_action_img']);        }        if(isset($_POST['item_name'])) {            $item_name = trim($_POST['item_name']);        }        if(isset($_POST['item_price'])) {            $item_price = $this->registry->main_class->float2db($_POST['item_price']);        }        if(isset($_POST['item_price_discounted'])) {            $item_price_discounted = $this->registry->main_class->float2db($_POST['item_price_discounted']);        }        if(isset($_POST['item_home'])) {            $item_home = intval($_POST['item_home']);        }        if(isset($_POST['item_catalog'])) {            $item_catalog = intval($_POST['item_catalog']);        }        if(isset($_POST['item_category'])) {            $item_category = intval($_POST['item_category']);        }        if(isset($_POST['item_subcategory'])) {            $item_subcategory = intval($_POST['item_subcategory']);        }        if(isset($_POST['item_short_description'])) {            $item_short_description = trim($_POST['item_short_description']);        }        if(isset($_POST['item_description'])) {            $item_description = trim($_POST['item_description']);        }        if(isset($_POST['item_show'])) {            $item_show = intval($_POST['item_show']);        }        if(isset($_POST['item_quantity'])) {            $item_quantity = intval($_POST['item_quantity']);        }        if(isset($_POST['item_quantity_unlim'])) {            $item_quantity_unlim = intval($_POST['item_quantity_unlim']);        }        if(isset($_POST['item_quantity_param'])) {            $item_quantity_param = intval($_POST['item_quantity_param']);        }        if(isset($_POST['item_display'])) {            $item_display = intval($_POST['item_display']);        }        if(isset($_POST['item_date'])) {            $item_date = trim($_POST['item_date']);        }        if(isset($_POST['item_hour'])) {            $item_hour = intval($_POST['item_hour']);        } else {            $item_hour = 0;        }        if(isset($_POST['item_minute'])) {            $item_minute = intval($_POST['item_minute']);        } else {            $item_minute = 0;        }        if(isset($_POST['item_meta_title'])) {            $item_meta_title = trim($_POST['item_meta_title']);        }        if(isset($_POST['item_meta_keywords'])) {            $item_meta_keywords = trim($_POST['item_meta_keywords']);        }        if(isset($_POST['item_meta_description'])) {            $item_meta_description = trim($_POST['item_meta_description']);        }        if(isset($_POST['depth'])) {            $depth = intval($_POST['depth']);        }        if(isset($depth) and $depth == 1) {            $cache = "cati";        } elseif(isset($depth) and $depth == 2) {            $cache = "categi";        } elseif(isset($depth) and $depth == 3) {            $cache = "subcategi";        } else {            $cache = "homei";        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if((!isset($_POST['item_action_img']) or !isset($_POST['item_name']) or !isset($_POST['item_price']) or !isset($_POST['item_price_discounted']) or (!isset($_POST['item_home']) and $cache == "homei") or (!isset($_POST['item_catalog']) and $cache == "cati") or ((!isset($_POST['item_catalog']) or !isset($_POST['item_category'])) and $cache == "categi") or ((!isset($_POST['item_catalog']) or !isset($_POST['item_category']) or !isset($_POST['item_subcategory'])) and $cache == "subcategi") or !isset($_POST['item_short_description']) or !isset($_POST['item_description']) or !isset($_POST['item_show']) or !isset($_POST['item_quantity']) or !isset($_POST['item_quantity_unlim']) or !isset($_POST['item_quantity_param']) or !isset($_POST['item_display']) or !isset($_POST['item_date']) or !isset($_POST['item_hour']) or !isset($_POST['item_minute']) or !isset($_POST['item_meta_title']) or !isset($_POST['item_meta_keywords']) or !isset($_POST['item_meta_description'])) or ($item_name == "" or $item_short_description == "" or $item_description == "" or $item_date == "" or ($cache == "homei" and $item_home == 0) or ($cache == "cati" and (!isset($item_catalog) or $item_catalog == 0)) or ($cache == "categi" and (!isset($item_category) or !isset($item_catalog) or $item_category == 0 or $item_catalog == 0)) or ($cache == "subcategi" and (!isset($item_subcategory) or !isset($item_category) or !isset($item_catalog) or $item_subcategory == 0 or $item_category == 0 or $item_catalog == 0)))) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notalldatai2|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMADDTITLE'));                $this->registry->main_class->assign("shop_message","notalldata");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notalldatai2|".$this->registry->language);            exit();        }        $item_action_img = $this->registry->main_class->format_striptags($item_action_img);        require_once('../modules/shop/shop_config.inc');        if($item_action_img == 'new_file') {            if(isset($_FILES['item_img']['name']) and trim($_FILES['item_img']['name']) !== '') {                if(is_uploaded_file($_FILES['item_img']['tmp_name'])) {                    if($_FILES['item_img']['size'] > SYSTEMDK_SHOP_ITEMIMAGE_MAXSIZE) {                        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addmaxsizeitem|".$this->registry->language)) {                            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMADDTITLE'));                            $this->registry->main_class->assign("shop_message","maxsizeerror");                            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                        }                        $this->registry->main_class->database_close();                        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addmaxsizeitem|".$this->registry->language);                        exit();                    }                    if(($_FILES['item_img']['type'] == "image/gif") or ($_FILES['item_img']['type'] == "image/jpg") or ($_FILES['item_img']['type'] == "image/jpeg") or ($_FILES['item_img']['type'] == "image/pjpeg") or ($_FILES['item_img']['type'] == "image/png") or ($_FILES['item_img']['type'] == "image/bmp")) {                        $this->registry->main_class->set_locale();                        if(basename($this->registry->main_class->format_striptags($_FILES['item_img']['name'])) != "") {                            $item_img = date("dmY",time())."_".basename($this->registry->main_class->format_striptags($_FILES['item_img']['name']));                        } else {                            $item_img = "";                        }                        if(file_exists($item_img) and $item_img != "") {                            @unlink("../".SYSTEMDK_SHOP_ITEMIMAGE_PATH."/".$item_img);                        }                        if($item_img == "" or !@copy($_FILES['item_img']['tmp_name'],"../".SYSTEMDK_SHOP_ITEMIMAGE_PATH."/".$item_img)) {                            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addnotuploaditem|".$this->registry->language)) {                                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMADDTITLE'));                                $this->registry->main_class->assign("shop_message","notuploadfile");                                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                            }                            $this->registry->main_class->database_close();                            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addnotuploaditem|".$this->registry->language);                            exit();                        }                        $item_size2 = @getimagesize("../".SYSTEMDK_SHOP_ITEMIMAGE_PATH."/".$item_img);                        if(($item_size2[0] > SYSTEMDK_SHOP_ITEMIMAGE_MAXWIDTH) or ($item_size2[1] > SYSTEMDK_SHOP_ITEMIMAGE_MAXHEIGHT)) {                            @unlink("../".SYSTEMDK_SHOP_ITEMIMAGE_PATH."/".$item_img);                            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addnoteqitem|".$this->registry->language)) {                                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMADDTITLE'));                                $this->registry->main_class->assign("shop_message","noteq");                                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                            }                            $this->registry->main_class->database_close();                            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addnoteqitem|".$this->registry->language);                            exit();                        }                    } else {                        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addnoteqtypeitem|".$this->registry->language)) {                            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMADDTITLE'));                            $this->registry->main_class->assign("shop_message","noteqtype");                            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                        }                        $this->registry->main_class->database_close();                        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addnoteqtypeitem|".$this->registry->language);                        exit();                    }                } else {                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addfileitem|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMADDTITLE'));                        $this->registry->main_class->assign("shop_message","uploadfileerror");                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addfileitem|".$this->registry->language);                    exit();                }                $item_img = $this->registry->main_class->processing_data($item_img,'need');            } else {                $item_img = 'NULL';            }        } else {            $item_img = 'NULL';        }        $item_name = $this->registry->main_class->format_striptags($item_name);        $item_name = $this->registry->main_class->processing_data($item_name);        if(intval($item_price_discounted) == 0) {            $item_price_discounted = 'NULL';        } else {            $item_price_discounted = "'".$item_price_discounted."'";        }        if($cache == "homei") {            $item_catalog_id = 'NULL';            $item_category_id = 'NULL';            $item_subcategory_id = 'NULL';        } elseif($cache == "cati") {            $item_catalog_id = "'".$item_catalog."'";            $item_category_id = 'NULL';            $item_subcategory_id = 'NULL';        } elseif($cache == "categi") {            $item_catalog_id = 'NULL';            $item_category_id = "'".$item_category."'";            $item_subcategory_id = 'NULL';        } elseif($cache == "subcategi") {            $item_catalog_id = 'NULL';            $item_category_id = 'NULL';            $item_subcategory_id = "'".$item_subcategory."'";        }        //$item_short_description = $this->registry->main_class->format_striptags($item_short_description);        if($item_short_description != "") {            $item_short_description = $this->registry->main_class->processing_data($item_short_description);        } else {            $item_short_description = 'NULL';        }        //$item_description = $this->registry->main_class->format_striptags($item_description);        if($item_description != "") {            $item_description = $this->registry->main_class->processing_data($item_description);        } else {            $item_description = 'NULL';        }        if($item_quantity == 0) {            $item_quantity = 'NULL';        } else {            $item_quantity = "'".$item_quantity."'";        }        if($item_quantity_param == 0) {            $item_quantity_param = 'NULL';        } else {            $item_quantity_param = "'".$item_quantity_param."'";        }        if($item_display == 0) {            $item_display = 'NULL';        } else {            $item_display = "'".$item_display."'";        }        $item_date = $this->registry->main_class->format_striptags($item_date);        $item_date = $item_date.".".$item_hour.".".$item_minute;        $item_date = $this->registry->main_class->timetounix($item_date);        $item_meta_title = $this->registry->main_class->format_striptags($item_meta_title);        if($item_meta_title != "") {            $item_meta_title = $this->registry->main_class->processing_data($item_meta_title);        } else {            $item_meta_title = 'NULL';        }        $item_meta_keywords = $this->registry->main_class->format_striptags($item_meta_keywords);        if($item_meta_keywords != "") {            $item_meta_keywords = $this->registry->main_class->processing_data($item_meta_keywords);        } else {            $item_meta_keywords = 'NULL';        }        $item_meta_description = $this->registry->main_class->format_striptags($item_meta_description);        if($item_meta_description != "") {            $item_meta_description = $this->registry->main_class->processing_data($item_meta_description);        } else {            $item_meta_description = 'NULL';        }        if($cache == "homei") {            $where = "item_catalog_id is NULL and item_category_id is NULL and item_subcategory_id is NULL";        } elseif($cache == "cati") {            $where = "item_catalog_id = ".$item_catalog_id;        } elseif($cache == "categi") {            $where = "item_category_id = ".$item_category_id;        } elseif($cache == "subcategi") {            $where = "item_subcategory_id = ".$item_subcategory_id;        }        $sql = "SELECT max(item_position)+1 FROM ".PREFIX."_items_".$this->registry->sitelang." WHERE ".$where;        $result = $this->db->Execute($sql);        if($result) {            if(isset($result->fields['0'])) {                $item_position = intval($result->fields['0']);            }        }        if(!isset($item_position)) {            $item_position = 0;        }        $item_id = $this->db->GenID(PREFIX."_items_id_".$this->registry->sitelang);        $check_db_need_lobs = $this->registry->main_class->check_db_need_lobs();        if($check_db_need_lobs == 'yes') {            $this->db->StartTrans();            $sql = "INSERT INTO ".PREFIX."_items_".$this->registry->sitelang." (item_id,item_img,item_name,item_price,item_price_discounted,item_catalog_id,item_category_id,item_subcategory_id,item_short_description,item_description,item_position,item_show,item_quantity,item_quantity_unlim,item_quantity_param,item_display,item_date,item_meta_title,item_meta_keywords,item_meta_description) VALUES ('".$item_id."',".$item_img.",".$item_name.",'".$item_price."',".$item_price_discounted.",".$item_catalog_id.",".$item_category_id.",".$item_subcategory_id.",empty_clob(),empty_clob(),'".$item_position."','".$item_show."',".$item_quantity.",'".$item_quantity_unlim."',".$item_quantity_param.",".$item_display.",'".$item_date."',".$item_meta_title.",".$item_meta_keywords.",".$item_meta_description.")";            $result = $this->db->Execute($sql);            $num_result = $this->db->Affected_Rows();            if($result === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            $item_short_description = substr(substr($item_short_description,0,-1),1);            $result2 = $this->db->UpdateClob(PREFIX.'_items_'.$this->registry->sitelang,'item_short_description',$item_short_description,'item_id='.$item_id);            if($result2 === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            $item_description = substr(substr($item_description,0,-1),1);            $result3 = $this->db->UpdateClob(PREFIX.'_items_'.$this->registry->sitelang,'item_description',$item_description,'item_id='.$item_id);            if($result3 === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            $this->db->CompleteTrans();            if($result2 === false or $result3 === false) {                $result = false;            }        } else {            $sql = "INSERT INTO ".PREFIX."_items_".$this->registry->sitelang." (item_id,item_img,item_name,item_price,item_price_discounted,item_catalog_id,item_category_id,item_subcategory_id,item_short_description,item_description,item_position,item_show,item_quantity,item_quantity_unlim,item_quantity_param,item_display,item_date,item_meta_title,item_meta_keywords,item_meta_description) VALUES ('".$item_id."',".$item_img.",".$item_name.",'".$item_price."',".$item_price_discounted.",".$item_catalog_id.",".$item_category_id.",".$item_subcategory_id.",".$item_short_description.",".$item_description.",'".$item_position."','".$item_show."',".$item_quantity.",'".$item_quantity_unlim."',".$item_quantity_param.",".$item_display.",'".$item_date."',".$item_meta_title.",".$item_meta_keywords.",".$item_meta_description.")";            $result = $this->db->Execute($sql);            $num_result = $this->db->Affected_Rows();            if($result === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }        }        if($result === false) {            $this->registry->main_class->assign("error",$error);            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addsqlerroritem|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMADDTITLE'));                $this->registry->main_class->assign("shop_message","sqlerror");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|addsqlerroritem|".$this->registry->language);            exit();        } else {            if($cache == "homei") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|home|items");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");            } elseif($cache == "cati") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog."|items");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog);                if($item_display == "'3'") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                }            } elseif($cache == "categi") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog."|categ".$item_category."|items");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog."|categ".$item_category);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog."|categ".$item_category);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog."|categ".$item_category);                if($item_display == "'3'") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog);                } elseif($item_display == "'2'") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog);                }            } elseif($cache == "subcategi") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|cat".$item_catalog."|categ".$item_category."|subcateg".$item_subcategory."|items");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$item_catalog."|categ".$item_category."|subcateg".$item_subcategory);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog."|categ".$item_category."|subcateg".$item_subcategory);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog."|categ".$item_category."|subcateg".$item_subcategory);                if($item_display == "'3'") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog);                } elseif($item_display == "'2'") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog);                } elseif($item_display == "'1'") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$item_catalog."|categ".$item_category);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$item_catalog."|categ".$item_category);                }            }            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|addokitem|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPITEMADDTITLE'));                $this->registry->main_class->assign("shop_message","addokitem");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|addokitem|".$this->registry->language);        }    }    public function shop_sort() {        if(isset($_GET['cat'])) {            $cat = intval($_GET['cat']);        }        if(isset($_GET['categ'])) {            $categ = intval($_GET['categ']);        }        if(isset($_GET['subcateg'])) {            $subcateg = intval($_GET['subcateg']);        }        if(isset($_GET['items'])) {            $items = intval($_GET['items']);        }        if(!isset($cat) and !isset($categ) and !isset($subcateg)) {            if(isset($items) and $items == 1) {                $cache = "homei";                $cacheid = "i|home";            } else {                $cache = "home";                $cacheid = "|home";            }            $cat = 0;            $categ = 0;            $subcateg = 0;            $itemid = 1;        } elseif(isset($cat) and $cat != 0) {            if(isset($subcateg) and isset($categ) and $categ != 0 and isset($items) and $items == 1) {                $cache = "subcategi";                if($subcateg != 0) {                    $cacheid = "i|cat".$cat."|categ".$categ."|subcateg".$subcateg;                    $itemid = $subcateg;                } else {                    $itemid = 0;                }            } elseif(isset($categ)) {                if(isset($items) and $items == 1) {                    $cache = "categi";                } else {                    $cache = "subcateg";                }                if($categ != 0) {                    if(isset($items) and $items == 1) {                        $cacheid = "i|cat".$cat."|categ".$categ;                    } else {                        $cacheid = "|cat".$cat."|categ".$categ;                    }                    $itemid = $categ;                    $subcateg = 0;                } else {                    $itemid = 0;                }            } else {                if(isset($items) and $items == 1) {                    $cache = "cati";                    $cacheid = "i|cat".$cat;                } else {                    $cache = "categ";                    $cacheid = "|cat".$cat;                }                $itemid = $cat;                $categ = 0;                $subcateg = 0;            }        } else {            if(isset($items) and $items == 1) {                $cache = "cati";            } else {                $cache = "categ";            }            $itemid = 0;        }        if($itemid == 0) {            $this->registry->main_class->display_theme_adminheader();            $this->registry->main_class->display_theme_adminmain();            $this->registry->main_class->displayadmininfo();            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sortno".$cache."|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSORTTITLE'));                if($cache == "categ" or $cache == "cati") {                    $this->registry->main_class->assign("shop_message","nocat");                } elseif($cache == "subcateg" or $cache == "categi") {                    $this->registry->main_class->assign("shop_message","nocateg");                } elseif($cache == "subcategi") {                    $this->registry->main_class->assign("shop_message","nosubcateg");                }                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sortno".$cache."|".$this->registry->language);            exit();        }        if(isset($_GET['num_page']) and intval($_GET['num_page']) != 0) {            $num_page = intval($_GET['num_page']);            if($num_page == 0) {                $num_page = 1;            }        } else {            $num_page = 1;        }        $num_string_rows = SYSTEMDK_ADMINROWS_PERPAGE;        $offset = ($num_page - 1) * $num_string_rows;        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|sort".$cacheid."|".$num_page."|".$this->registry->language)) {            if($cache == "home") {                $sql = "SELECT a.catalog_id,a.catalog_name,a.catalog_position,a.catalog_show,(SELECT count(*) FROM ".PREFIX."_catalogs_".$this->registry->sitelang." b) as count_rows FROM ".PREFIX."_catalogs_".$this->registry->sitelang." a order by a.catalog_position ASC";            } elseif($cache == "categ") {                $sql = "SELECT a.category_id,a.category_name,a.category_position,a.category_show,(SELECT count(*) FROM ".PREFIX."_categories_".$this->registry->sitelang." b WHERE b.cat_catalog_id = ".$cat.") as count_rows,c.catalog_id,c.catalog_name FROM ".PREFIX."_categories_".$this->registry->sitelang." a RIGHT OUTER JOIN ".PREFIX."_catalogs_".$this->registry->sitelang." c ON a.cat_catalog_id=c.catalog_id WHERE c.catalog_id = ".$cat." order by a.category_position ASC";            } elseif($cache == "subcateg") {                $sql = "SELECT a.subcategory_id,a.subcategory_name,a.subcategory_position,a.subcategory_show,(SELECT count(*) FROM ".PREFIX."_subcategories_".$this->registry->sitelang." b WHERE b.subcategory_cat_id = ".$categ.") as count_rows,c.category_id,c.category_name,d.catalog_id,d.catalog_name FROM ".PREFIX."_subcategories_".$this->registry->sitelang." a RIGHT OUTER JOIN ".PREFIX."_categories_".$this->registry->sitelang." c ON c.category_id=a.subcategory_cat_id RIGHT OUTER JOIN ".PREFIX."_catalogs_".$this->registry->sitelang." d ON d.catalog_id=c.cat_catalog_id WHERE c.category_id = ".$categ." and d.catalog_id = ".$cat." order by a.subcategory_position ASC";            } elseif($cache == "homei") {                $sql = "SELECT a.item_id,a.item_name,a.item_position,a.item_show,(SELECT count(*) FROM ".PREFIX."_items_".$this->registry->sitelang." b WHERE b.item_catalog_id is NULL and b.item_category_id is NULL and b.item_subcategory_id is NULL) as count_rows FROM ".PREFIX."_items_".$this->registry->sitelang." a WHERE a.item_catalog_id is NULL and a.item_category_id is NULL and a.item_subcategory_id is NULL order by a.item_position ASC";            } elseif($cache == "cati") {                $sql = "SELECT a.item_id,a.item_name,a.item_position,a.item_show,(SELECT count(*) FROM ".PREFIX."_items_".$this->registry->sitelang." e,".PREFIX."_catalogs_".$this->registry->sitelang." f WHERE f.catalog_id=e.item_catalog_id and e.item_catalog_id = ".$cat.") as count_rows,b.catalog_id,b.catalog_name FROM ".PREFIX."_items_".$this->registry->sitelang." a RIGHT OUTER JOIN ".PREFIX."_catalogs_".$this->registry->sitelang." b on a.item_catalog_id=b.catalog_id WHERE b.catalog_id = ".$cat." order by a.item_position ASC";            } elseif($cache == "categi") {                $sql = "SELECT a.item_id,a.item_name,a.item_position,a.item_show,(SELECT count(*) FROM ".PREFIX."_items_".$this->registry->sitelang." e,".PREFIX."_categories_".$this->registry->sitelang." f,".PREFIX."_catalogs_".$this->registry->sitelang." g WHERE f.category_id=e.item_category_id and g.catalog_id=f.cat_catalog_id and e.item_category_id = ".$categ." and g.catalog_id = ".$cat.") as count_rows,b.category_id,b.category_name,c.catalog_id,c.catalog_name FROM ".PREFIX."_items_".$this->registry->sitelang." a RIGHT OUTER JOIN ".PREFIX."_categories_".$this->registry->sitelang." b on a.item_category_id=b.category_id INNER JOIN ".PREFIX."_catalogs_".$this->registry->sitelang." c on b.cat_catalog_id=c.catalog_id WHERE b.category_id = ".$categ." and c.catalog_id = ".$cat." order by a.item_position ASC";            } elseif($cache == "subcategi") {                $sql = "SELECT a.item_id,a.item_name,a.item_position,a.item_show,(SELECT count(*) FROM ".PREFIX."_items_".$this->registry->sitelang." e,".PREFIX."_subcategories_".$this->registry->sitelang." f,".PREFIX."_categories_".$this->registry->sitelang." g,".PREFIX."_catalogs_".$this->registry->sitelang." h WHERE f.subcategory_id=e.item_subcategory_id and g.category_id=f.subcategory_cat_id and h.catalog_id=g.cat_catalog_id and e.item_subcategory_id = ".$subcateg." and g.category_id = ".$categ." and h.catalog_id = ".$cat.") as count_rows,b.subcategory_id,b.subcategory_name,c.category_id,c.category_name,d.catalog_id,d.catalog_name FROM ".PREFIX."_items_".$this->registry->sitelang." a RIGHT OUTER JOIN ".PREFIX."_subcategories_".$this->registry->sitelang." b on a.item_subcategory_id=b.subcategory_id INNER JOIN ".PREFIX."_categories_".$this->registry->sitelang." c on b.subcategory_cat_id=c.category_id INNER JOIN ".PREFIX."_catalogs_".$this->registry->sitelang." d on c.cat_catalog_id=d.catalog_id WHERE b.subcategory_id = ".$subcateg." and c.category_id = ".$categ." and d.catalog_id = ".$cat." order by a.item_position ASC";            }            $result = $this->db->SelectLimit($sql,$num_string_rows,$offset);            if($result) {                if(isset($result->fields['0'])) {                    $numrows = intval($result->fields['0']);                } else {                    $numrows = 0;                }                if($numrows == 0 and $num_page > 1) {                    $this->registry->main_class->database_close();                    if($cache == "home") {                        header("Location: index.php?path=admin_shop&func=shop_sort&lang=".$this->registry->sitelang);                    } elseif($cache == "categ") {                        header("Location: index.php?path=admin_shop&func=shop_sort&cat=".$cat."&lang=".$this->registry->sitelang);                    } elseif($cache == "subcateg") {                        header("Location: index.php?path=admin_shop&func=shop_sort&cat=".$cat."&categ=".$categ."&lang=".$this->registry->sitelang);                    }                    if($cache == "homei") {                        header("Location: index.php?path=admin_shop&func=shop_sort&items=1&lang=".$this->registry->sitelang);                    } elseif($cache == "cati") {                        header("Location: index.php?path=admin_shop&func=shop_sort&items=1&cat=".$cat."&lang=".$this->registry->sitelang);                    } elseif($cache == "categi") {                        header("Location: index.php?path=admin_shop&func=shop_sort&items=1&cat=".$cat."&categ=".$categ."&lang=".$this->registry->sitelang);                    } elseif($cache == "subcategi") {                        header("Location: index.php?path=admin_shop&func=shop_sort&items=1&cat=".$cat."&categ=".$categ."&subcateg=".$subcateg."&lang=".$this->registry->sitelang);                    }                    exit();                }                if(($cache == "categ" or $cache == "cati") and isset($result->fields['5']) and intval($result->fields['5']) > 0) {                    $catalog_id = intval($result->fields['5']);                    $catalog_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['6']));                    $this->registry->main_class->assign("adminmodules_shop_catalog_id",$catalog_id);                    $this->registry->main_class->assign("adminmodules_shop_catalog_name",$catalog_name);                } elseif(($cache == "subcateg" or $cache == "categi") and isset($result->fields['5']) and intval($result->fields['5']) > 0) {                    $category_id = intval($result->fields['5']);                    $category_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['6']));                    $catalog_id = intval($result->fields['7']);                    $catalog_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['8']));                    $this->registry->main_class->assign("adminmodules_shop_catalog_id",$catalog_id);                    $this->registry->main_class->assign("adminmodules_shop_catalog_name",$catalog_name);                    $this->registry->main_class->assign("adminmodules_shop_category_id",$category_id);                    $this->registry->main_class->assign("adminmodules_shop_category_name",$category_name);                } elseif($cache == "subcategi" and isset($result->fields['5']) and intval($result->fields['5']) > 0) {                    $subcategory_id = intval($result->fields['5']);                    $subcategory_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['6']));                    $category_id = intval($result->fields['7']);                    $category_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['8']));                    $catalog_id = intval($result->fields['9']);                    $catalog_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['10']));                    $this->registry->main_class->assign("adminmodules_shop_catalog_id",$catalog_id);                    $this->registry->main_class->assign("adminmodules_shop_catalog_name",$catalog_name);                    $this->registry->main_class->assign("adminmodules_shop_category_id",$category_id);                    $this->registry->main_class->assign("adminmodules_shop_category_name",$category_name);                    $this->registry->main_class->assign("adminmodules_shop_subcategory_id",$subcategory_id);                    $this->registry->main_class->assign("adminmodules_shop_subcategory_name",$subcategory_name);                } elseif($cache != "home" and $cache != "homei") {                    $this->registry->main_class->display_theme_adminheader();                    $this->registry->main_class->display_theme_adminmain();                    $this->registry->main_class->displayadmininfo();                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sortnotfound".$cache."|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSORTTITLE'));                        if($cache == "categ" or $cache == "cati") {                            $this->registry->main_class->assign("shop_message","notfoundcatalog");                        } elseif($cache == "subcateg" or $cache == "categi") {                            $this->registry->main_class->assign("shop_message","notfoundcateg");                        } elseif($cache == "subcategi") {                            $this->registry->main_class->assign("shop_message","notfoundsubcateg");                        }                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sortnotfound".$cache."|".$this->registry->language);                    exit();                }                if($numrows > 0) {                    while(!$result->EOF) {                        if(!isset($numrows2)) {                            $numrows2 = intval($result->fields['4']);                        }                        $item_id = intval($result->fields['0']);                        $item_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['1']));                        $item_position = intval($result->fields['2']);                        $item_show = intval($result->fields['3']);                        $items_all[] = array(                            "item_id" => $item_id,                            "item_name" => $item_name,                            "item_position" => $item_position,                            "item_show" => $item_show                        );                        $result->MoveNext();                    }                    $this->registry->main_class->assign("items_all",$items_all);                    if(isset($numrows2)) {                        $num_pages = @ceil($numrows2 / $num_string_rows);                    } else {                        $num_pages = 0;                    }                    if($num_pages > 1) {                        if($num_page > 1) {                            $prevpage = $num_page - 1;                            $this->registry->main_class->assign("prevpage",$prevpage);                        } else {                            $this->registry->main_class->assign("prevpage","no");                        }                        for($i = 1;$i < $num_pages + 1;$i++) {                            if($i == $num_page) {                                $html[] = array("number" => $i,"param1" => "1");                            } else {                                $pagelink = 5;                                if(($i > $num_page) and ($i < $num_page + $pagelink) or ($i < $num_page) and ($i > $num_page - $pagelink)) {                                    $html[] = array("number" => $i,"param1" => "2");                                }                                if(($i == $num_pages) and ($num_page < $num_pages - $pagelink)) {                                    $html[] = array("number" => $i,"param1" => "3");                                }                                if(($i == 1) and ($num_page > $pagelink + 1)) {                                    $html[] = array("number" => $i,"param1" => "4");                                }                            }                        }                        if($num_page < $num_pages) {                            $nextpage = $num_page + 1;                            $this->registry->main_class->assign("nextpage",$nextpage);                        } else {                            $this->registry->main_class->assign("nextpage","no");                        }                        $this->registry->main_class->assign("html",$html);                        $this->registry->main_class->assign("totalitems",$numrows2);                        $this->registry->main_class->assign("num_pages",$num_pages);                    } else {                        $this->registry->main_class->assign("html","no");                    }                } else {                    $this->registry->main_class->assign("items_all","no");                    $this->registry->main_class->assign("html","no");                }            } else {                $this->registry->main_class->display_theme_adminheader();                $this->registry->main_class->display_theme_adminmain();                $this->registry->main_class->displayadmininfo();                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);                $this->registry->main_class->assign("error",$error);                if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sortsqlerror|".$this->registry->language)) {                    $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSORTTITLE'));                    $this->registry->main_class->assign("shop_message","sqlerror");                    $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                    $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                }                $this->registry->main_class->database_close();                $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sortsqlerror|".$this->registry->language);                exit();            }        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|sort".$cacheid."|".$num_page."|".$this->registry->language)) {            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");            $this->registry->main_class->assign("adminmodules_shop_depth",$cache);            $this->registry->main_class->assign("adminmodules_shop_cat",$cat);            $this->registry->main_class->assign("adminmodules_shop_categ",$categ);            $this->registry->main_class->assign("adminmodules_shop_subcateg",$subcateg);            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSORTTITLE'));            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_sort.html");        }        $this->registry->main_class->database_close();        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|sort".$cacheid."|".$num_page."|".$this->registry->language);    }    public function shop_sort_save() {        if(isset($_POST['cat'])) {            $cat = intval($_POST['cat']);        }        if(isset($_POST['categ'])) {            $categ = intval($_POST['categ']);        }        if(isset($_POST['subcateg'])) {            $subcateg = intval($_POST['subcateg']);        }        if(isset($_POST['depth'])) {            $depth = intval($_POST['depth']);        }        if(isset($depth) and $depth == 1) {            $cache = "categ";        } elseif(isset($depth) and $depth == 2) {            $cache = "subcateg";        } elseif(isset($depth) and $depth == 3) {            $cache = "homei";        } elseif(isset($depth) and $depth == 4) {            $cache = "cati";        } elseif(isset($depth) and $depth == 5) {            $cache = "categi";        } elseif(isset($depth) and $depth == 6) {            $cache = "subcategi";        } else {            $cache = "home";        }        if(isset($_POST['item_id']) and is_array($_POST['item_id']) and count($_POST['item_id']) > 0 and isset($_POST['item_position']) and is_array($_POST['item_position']) and count($_POST['item_position']) > 0) {            $item_id_is_arr = 1;            for($i = 0,$size = count($_POST['item_id']);$i < $size;++$i) {                if($i == 0) {                    $item_id = " WHEN ".intval($_POST['item_id'][$i])." THEN ".intval($_POST['item_position'][$i]);                } else {                    $item_id .= " WHEN ".intval($_POST['item_id'][$i])." THEN ".intval($_POST['item_position'][$i]);                }            }        } else {            $item_id_is_arr = 0;        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if((!isset($_POST['item_id']) or !isset($_POST['item_position'])) or ((($cache == "cati" or $cache == "categ") and (!isset($cat) or $cat == 0)) or (($cache == "categi" or $cache == "subcateg") and (!isset($categ) or !isset($cat) or $categ == 0 or $cat == 0)) or ($cache == "subcategi" and (!isset($subcateg) or !isset($categ) or !isset($cat) or $subcateg == 0 or $categ == 0 or $cat == 0)))) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sortnotalldata|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSORTTITLE'));                $this->registry->main_class->assign("shop_message","notalldata");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sortnotalldata|".$this->registry->language);            exit();        }        if($cache == "home") {            $sql = "UPDATE ".PREFIX."_catalogs_".$this->registry->sitelang." SET catalog_position = (CASE catalog_id ".$item_id." ELSE catalog_position END)";        } elseif($cache == "categ") {            $sql = "UPDATE ".PREFIX."_categories_".$this->registry->sitelang." SET category_position = (CASE category_id ".$item_id." ELSE category_position END)";        } elseif($cache == "subcateg") {            $sql = "UPDATE ".PREFIX."_subcategories_".$this->registry->sitelang." SET subcategory_position = (CASE subcategory_id ".$item_id." ELSE subcategory_position END)";        } elseif($cache == "homei" or $cache == "cati" or $cache == "categi" or $cache == "subcategi") {            $sql = "UPDATE ".PREFIX."_items_".$this->registry->sitelang." SET item_position = (CASE item_id ".$item_id." ELSE item_position END)";        }        $result = $this->db->Execute($sql);        if($result) {            $num_result = $this->db->Affected_Rows();        } else {            $error_message = $this->db->ErrorMsg();            $error_code = $this->db->ErrorNo();            $error[] = array("code" => $error_code,"message" => $error_message);        }        if($result === false) {            $this->registry->main_class->assign("error",$error);            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sortsqlerror|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSORTTITLE'));                $this->registry->main_class->assign("shop_message","sqlerror");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sortsqlerror|".$this->registry->language);            exit();        } elseif($result !== false and $num_result == 0) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sortok|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSORTTITLE'));                $this->registry->main_class->assign("shop_message","notsave");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sortok|".$this->registry->language);            exit();        } else {            require_once('../modules/shop/shop_config.inc');            if($cache == "home") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sort|home");                if(SYSTEMDK_SHOP_CATALOGS_ORDER == "catalog_position") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                }            } elseif($cache == "categ") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sort|cat".$cat);                if(SYSTEMDK_SHOP_CATEGORIES_ORDER == "category_position") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$cat);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$cat);                    if(SYSTEMDK_SHOP_ITEMS_UNDERPARENT > 0) {                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                    }                }            } elseif($cache == "subcateg") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sort|cat".$cat."|categ".$categ);                if(SYSTEMDK_SHOP_SUBCATEGORIES_ORDER == "subcategory_position") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$cat."|categ".$categ);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$cat."|categ".$categ);                    if(SYSTEMDK_SHOP_ITEMS_UNDERPARENT > 0) {                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$cat);                        $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$cat);                    }                }            } elseif($cache == "homei") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|home");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|home");                if(SYSTEMDK_SHOP_HOMEITEMS_ORDER == "item_position") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                }            } elseif($cache == "cati") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$cat);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$cat);                if(SYSTEMDK_SHOP_HOMEITEMS_ORDER == "item_position") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                }                if(SYSTEMDK_SHOP_CATITEMS_ORDER == "item_position") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$cat);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$cat);                }            } elseif($cache == "categi") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$cat."|categ".$categ);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$cat."|categ".$categ);                if(SYSTEMDK_SHOP_HOMEITEMS_ORDER == "item_position") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                }                if(SYSTEMDK_SHOP_CATITEMS_ORDER == "item_position") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$cat);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$cat);                }                if(SYSTEMDK_SHOP_CATEGITEMS_ORDER == "item_position") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$cat."|categ".$categ);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$cat."|categ".$categ);                }            } elseif($cache == "subcategi") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|sorti|cat".$cat."|categ".$categ."|subcateg".$subcateg);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|edit|cat".$cat."|categ".$categ."|subcateg".$subcateg);                if(SYSTEMDK_SHOP_HOMEITEMS_ORDER == "item_position") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|home");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|home");                }                if(SYSTEMDK_SHOP_CATITEMS_ORDER == "item_position") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$cat);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$cat);                }                if(SYSTEMDK_SHOP_CATEGITEMS_ORDER == "item_position") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$cat."|categ".$categ);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$cat."|categ".$categ);                }                if(SYSTEMDK_SHOP_SUBCATEGITEMS_ORDER == "item_position") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|other|cat".$cat."|categ".$categ."|subcateg".$subcateg);                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|admin|cat".$cat."|categ".$categ."|subcateg".$subcateg);                }            }            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|sort|ok|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSORTTITLE'));                $this->registry->main_class->assign("shop_message","sortok");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|sort|ok|".$this->registry->language);        }    }    public function shop_orders() {        if(isset($_GET['status'])) {            $status = intval($_GET['status']);        } else {            $status = 0;        }        if(!isset($_GET['status']) and isset($_POST['status'])) {            $status = intval($_POST['status']);        }        if($status == 0 or $status == 1 or $status == 2 or $status == 3 or $status == 4 or $status == 5 or $status == 6 or $status == 7 or $status == 8 or $status == 9) {            $cache = $status;        } else {            $cache = 0;        }        if(isset($_GET['num_page']) and intval($_GET['num_page']) != 0) {            $num_page = intval($_GET['num_page']);            if($num_page == 0) {                $num_page = 1;            }        } else {            $num_page = 1;        }        $num_string_rows = SYSTEMDK_ADMINROWS_PERPAGE;        $offset = ($num_page - 1) * $num_string_rows;        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|orders|".$cache."|".$num_page."|".$this->registry->language)) {            if($cache == 0) {                $where1 = "";                $where2 = "";            } else {                $where1 = "WHERE a.order_status = '".$cache."'";                $where2 = "WHERE b.order_status = '".$cache."'";            }            $sql = "SELECT a.order_id,a.order_date,a.ship_date,a.order_status,a.order_customer_id,(SELECT count(*) FROM ".PREFIX."_orders_".$this->registry->sitelang." b ".$where2.") as count_rows FROM ".PREFIX."_orders_".$this->registry->sitelang." a ".$where1." order by a.order_date DESC";            $result = $this->db->SelectLimit($sql,$num_string_rows,$offset);            if($result) {                if(isset($result->fields['0'])) {                    $numrows = intval($result->fields['0']);                } else {                    $numrows = 0;                }                if($numrows == 0 and $num_page > 1) {                    $this->registry->main_class->database_close();                    header("Location: index.php?path=admin_shop&func=shop_order&status=".$cache."&lang=".$this->registry->sitelang);                    exit();                }                if($numrows > 0) {                    while(!$result->EOF) {                        if(!isset($numrows2)) {                            $numrows2 = intval($result->fields['5']);                        }                        $order_id = intval($result->fields['0']);                        $order_date = date("d.m.y H:i",intval($result->fields['1']));                        if(intval($result->fields['2']) == 0) {                            $ship_date = "no";                        } else {                            $ship_date = date("d.m.y H:i",intval($result->fields['2']));                        }                        $order_status = intval($result->fields['3']);                        $order_customer_id = intval($result->fields['4']);                        if($order_customer_id == 0) {                            $order_customer_id = "no";                        }                        $orders_all[] = array(                            "order_id" => $order_id,                            "order_date" => $order_date,                            "ship_date" => $ship_date,                            "order_status" => $order_status,                            "order_customer_id" => $order_customer_id                        );                        $result->MoveNext();                    }                    $this->registry->main_class->assign("orders_all",$orders_all);                    if(isset($numrows2)) {                        $num_pages = @ceil($numrows2 / $num_string_rows);                    } else {                        $num_pages = 0;                    }                    if($num_pages > 1) {                        if($num_page > 1) {                            $prevpage = $num_page - 1;                            $this->registry->main_class->assign("prevpage",$prevpage);                        } else {                            $this->registry->main_class->assign("prevpage","no");                        }                        for($i = 1;$i < $num_pages + 1;$i++) {                            if($i == $num_page) {                                $html[] = array("number" => $i,"param1" => "1");                            } else {                                $pagelink = 5;                                if(($i > $num_page) and ($i < $num_page + $pagelink) or ($i < $num_page) and ($i > $num_page - $pagelink)) {                                    $html[] = array("number" => $i,"param1" => "2");                                }                                if(($i == $num_pages) and ($num_page < $num_pages - $pagelink)) {                                    $html[] = array("number" => $i,"param1" => "3");                                }                                if(($i == 1) and ($num_page > $pagelink + 1)) {                                    $html[] = array("number" => $i,"param1" => "4");                                }                            }                        }                        if($num_page < $num_pages) {                            $nextpage = $num_page + 1;                            $this->registry->main_class->assign("nextpage",$nextpage);                        } else {                            $this->registry->main_class->assign("nextpage","no");                        }                        $this->registry->main_class->assign("html",$html);                        $this->registry->main_class->assign("totalorders",$numrows2);                        $this->registry->main_class->assign("num_pages",$num_pages);                    } else {                        $this->registry->main_class->assign("html","no");                    }                } else {                    $this->registry->main_class->assign("orders_all","no");                    $this->registry->main_class->assign("html","no");                }            } else {                $this->registry->main_class->display_theme_adminheader();                $this->registry->main_class->display_theme_adminmain();                $this->registry->main_class->displayadmininfo();                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);                $this->registry->main_class->assign("error",$error);                if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|orderssqlerror|".$this->registry->language)) {                    $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPORDERSTITLE'));                    $this->registry->main_class->assign("shop_message","sqlerror");                    $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                    $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                }                $this->registry->main_class->database_close();                $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|orderssqlerror|".$this->registry->language);                exit();            }        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|orders|".$cache."|".$num_page."|".$this->registry->language)) {            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");            $this->registry->main_class->assign("adminmodules_shop_status",$cache);            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPORDERSTITLE'));            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_orders.html");        }        $this->registry->main_class->database_close();        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|orders|".$cache."|".$num_page."|".$this->registry->language);    }    public function shop_orderproc() {        if(isset($_GET['order_id'])) {            $order_id = intval($_GET['order_id']);        } else {            $order_id = 0;        }        if(isset($_GET['edit'])) {            $edit = intval($_GET['edit']);        } else {            $edit = 0;        }        if($edit > 0) {            $edit = 'edit';        } else {            $edit = '';        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if($order_id == 0) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$edit."noorder|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($edit == 'edit') {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                } else {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSHOWORDER'));                }                $this->registry->main_class->assign("shop_message","noorder");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$edit."noorder|".$this->registry->language);            exit();        }        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|order|".$edit.$order_id."|".$this->registry->language)) {            $sql = "SELECT a.order_id,a.order_customer_id,a.order_amount,a.order_date,a.ship_date,a.order_status,a.ship_name,a.ship_street,a.ship_house,a.ship_flat,a.ship_city,a.ship_state,a.ship_postalcode,a.ship_country,a.ship_telephone,a.ship_email,a.ship_addinfo,a.order_delivery,a.order_pay,a.order_comments,a.order_ip,b.order_item_id,b.item_id,b.order_item_name,b.order_item_price,b.order_item_quantity,null,null,null,null,null,null,e.user_login,e.user_name,e.user_surname,f.delivery_price,g.pay_price FROM ".PREFIX."_orders_".$this->registry->sitelang." a LEFT OUTER JOIN ".PREFIX."_order_items_".$this->registry->sitelang." b ON a.order_id=b.order_id LEFT OUTER JOIN ".PREFIX."_users e ON a.order_customer_id=e.user_id LEFT OUTER JOIN ".PREFIX."_delivery_".$this->registry->sitelang." f ON a.order_delivery=f.delivery_id LEFT OUTER JOIN ".PREFIX."_pay_".$this->registry->sitelang." g ON a.order_pay=g.pay_id WHERE a.order_id = ".$order_id." UNION ALL SELECT null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,c.delivery_id,c.delivery_name,c.delivery_price,null,null,null,null,null,null,null,null FROM ".PREFIX."_delivery_".$this->registry->sitelang." c UNION ALL SELECT null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,d.pay_id,d.pay_name,d.pay_price,null,null,null,null,null FROM ".PREFIX."_pay_".$this->registry->sitelang." d";            $result = $this->db->Execute($sql);            if($result) {                if(isset($result->fields['0'])) {                    $numrows = intval($result->fields['0']);                } else {                    $numrows = 0;                }                if($numrows > 0) {                    while(!$result->EOF) {                        if(!isset($order_all) and intval($result->fields['0']) > 0) {                            $order_id = intval($result->fields['0']);                            $order_customer_id = intval($result->fields['1']);                            $order_customer_login = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['32']));                            $order_customer_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['33']));                            $order_customer_surname = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['34']));                            $order_amount = floatval($result->fields['2']);                            $order_amount2 = $order_amount + floatval($result->fields['35']) + (($order_amount * floatval($result->fields['36'])) / 100);                            $order_date = intval($result->fields['3']);                            $order_date2 = date("d.m.y",$order_date);                            $order_hour = date("H",$order_date);                            $order_minute = date("i",$order_date);                            if(intval($result->fields['4']) == 0) {                                $ship_date2 = "no";                                $ship_hour = "no";                                $ship_minute = "no";                            } else {                                $ship_date = intval($result->fields['4']);                                $ship_date2 = date("d.m.y",$ship_date);                                $ship_hour = date("H",$ship_date);                                $ship_minute = date("i",$ship_date);                            }                            $order_status = intval($result->fields['5']);                            $ship_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['6']));                            $ship_street = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['7']));                            $ship_house = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['8']));                            $ship_flat = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['9']));                            $ship_city = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['10']));                            $ship_state = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['11']));                            $ship_postalcode = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['12']));                            $ship_country = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['13']));                            $ship_telephone = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['14']));                            $ship_email = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['15']));                            $ship_addinfo = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['16']));                            $order_delivery = intval($result->fields['17']);                            $order_pay = intval($result->fields['18']);                            $order_comments = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['19']));                            $order_ip = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['20']));                            $order_all[] = array(                                "order_id" => $order_id,                                "order_customer_id" => $order_customer_id,                                "order_amount" => number_format($order_amount,2,'.',' '),                                "order_amount2" => number_format($order_amount2,2,'.',' '),                                "order_date" => $order_date2,                                "order_hour" => $order_hour,                                "order_minute" => $order_minute,                                "ship_date" => $ship_date2,                                "ship_hour" => $ship_hour,                                "ship_minute" => $ship_minute,                                "order_status" => $order_status,                                "ship_name" => $ship_name,                                "ship_street" => $ship_street,                                "ship_house" => $ship_house,                                "ship_flat" => $ship_flat,                                "ship_city" => $ship_city,                                "ship_state" => $ship_state,                                "ship_postalcode" => $ship_postalcode,                                "ship_country" => $ship_country,                                "ship_telephone" => $ship_telephone,                                "ship_email" => $ship_email,                                "ship_addinfo" => $ship_addinfo,                                "order_delivery" => $order_delivery,                                "order_pay" => $order_pay,                                "order_comments" => $order_comments,                                "order_customer_login" => $order_customer_login,                                "order_customer_name" => $order_customer_name,                                "order_customer_surname" => $order_customer_surname,                                "order_ip" => $order_ip                            );                        }                        if(isset($result->fields['21']) and intval($result->fields['21']) > 0) {                            $order_item_id = intval($result->fields['21']);                            $item_id = intval($result->fields['22']);                            $order_item_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['23']));                            $order_item_price = number_format(floatval($result->fields['24']),2,'.',' ');                            $order_item_quantity = intval($result->fields['25']);                            $order_items_all_now = array(                                "order_item_id" => $order_item_id,                                "item_id" => $item_id,                                "order_item_name" => $order_item_name,                                "order_item_price" => $order_item_price,                                "order_item_quantity" => $order_item_quantity                            );                            if(!isset($order_items_all) or (isset($order_items_all) and !in_array($order_items_all_now,$order_items_all))) {                                $order_items_all[] = array(                                    "order_item_id" => $order_item_id,                                    "item_id" => $item_id,                                    "order_item_name" => $order_item_name,                                    "order_item_price" => $order_item_price,                                    "order_item_quantity" => $order_item_quantity                                );                            }                        }                        if(isset($result->fields['26']) and intval($result->fields['26']) > 0) {                            $delivery_id = intval($result->fields['26']);                            $delivery_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['27']));                            $delivery_price = number_format(floatval($result->fields['28']),2,'.',' ');                            $delivery_all[] = array(                                "delivery_id" => $delivery_id,                                "delivery_name" => $delivery_name,                                "delivery_price" => $delivery_price                            );                        }                        if(isset($result->fields['29']) and intval($result->fields['29']) > 0) {                            $pay_id = intval($result->fields['29']);                            $pay_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['30']));                            $pay_price = floatval($result->fields['31']);                            $pay_all[] = array("pay_id" => $pay_id,"pay_name" => $pay_name,"pay_price" => $pay_price);                        }                        $result->MoveNext();                    }                } else {                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$edit."notfoundorder|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        if($edit == 'edit') {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                        } else {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSHOWORDER'));                        }                        $this->registry->main_class->assign("shop_message","notfoundorder");                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$edit."notfoundorder|".$this->registry->language);                    exit();                }            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);                $this->registry->main_class->assign("error",$error);                if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$edit."sqlerrororder|".$this->registry->language)) {                    $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                    if($edit == 'edit') {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                    } else {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSHOWORDER'));                    }                    $this->registry->main_class->assign("shop_message","sqlerror");                    $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                    $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                }                $this->registry->main_class->database_close();                $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$edit."sqlerrororder|".$this->registry->language);                exit();            }            if(isset($order_items_all)) {                $this->registry->main_class->assign("order_items_all",$order_items_all);            } else {                $this->registry->main_class->assign("order_items_all","no");            }            if(isset($delivery_all)) {                $this->registry->main_class->assign("delivery_all",$delivery_all);            } else {                $this->registry->main_class->assign("delivery_all","no");            }            if(isset($pay_all)) {                $this->registry->main_class->assign("pay_all",$pay_all);            } else {                $this->registry->main_class->assign("pay_all","no");            }            $this->registry->main_class->assign("order_all",$order_all);            $this->registry->main_class->assign("adminmodules_shop_orderedit",$edit);            $this->registry->main_class->assign("adminmodules_shop_orderid",$order_id);            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");            if($edit == 'edit') {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));            } else {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPSHOWORDER'));            }            $this->registry->main_class->assign("include_jquery","yes");            $this->registry->main_class->assign("include_jquery_data","dateinput");            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_order.html");        }        $this->registry->main_class->database_close();        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|order|".$edit.$order_id."|".$this->registry->language);    }    public function shop_order_save() {        if(isset($_POST['order_id'])) {            $order_id = intval($_POST['order_id']);        }        if(isset($_POST['order_date'])) {            $order_date = trim($_POST['order_date']);        }        if(isset($_POST['order_hour'])) {            $order_hour = intval($_POST['order_hour']);        } else {            $order_hour = 0;        }        if(isset($_POST['order_minute'])) {            $order_minute = intval($_POST['order_minute']);        } else {            $order_minute = 0;        }        if(isset($_POST['ship_date'])) {            $ship_date = trim($_POST['ship_date']);        }        if(isset($_POST['ship_hour'])) {            $ship_hour = intval($_POST['ship_hour']);        } else {            $ship_hour = 0;        }        if(isset($_POST['ship_minute'])) {            $ship_minute = intval($_POST['ship_minute']);        } else {            $ship_minute = 0;        }        if(isset($_POST['order_status'])) {            $order_status = intval($_POST['order_status']);        }        if(isset($_POST['order_status_old'])) {            $order_status_old = intval($_POST['order_status_old']);        }        if(isset($_POST['ship_name'])) {            $ship_name = trim($_POST['ship_name']);        }        if(isset($_POST['ship_street'])) {            $ship_street = trim($_POST['ship_street']);        }        if(isset($_POST['ship_house'])) {            $ship_house = trim($_POST['ship_house']);        }        if(isset($_POST['ship_flat'])) {            $ship_flat = trim($_POST['ship_flat']);        }        if(isset($_POST['ship_city'])) {            $ship_city = trim($_POST['ship_city']);        }        if(isset($_POST['ship_state'])) {            $ship_state = trim($_POST['ship_state']);        }        if(isset($_POST['ship_postalcode'])) {            $ship_postalcode = trim($_POST['ship_postalcode']);        }        if(isset($_POST['ship_country'])) {            $ship_country = trim($_POST['ship_country']);        }        if(isset($_POST['ship_telephone'])) {            $ship_telephone = trim($_POST['ship_telephone']);        }        if(isset($_POST['ship_email'])) {            $ship_email = trim($_POST['ship_email']);        }        if(isset($_POST['ship_addinfo'])) {            $ship_addinfo = trim($_POST['ship_addinfo']);        }        if(isset($_POST['order_delivery'])) {            $order_delivery = intval($_POST['order_delivery']);        }        if(isset($_POST['order_pay'])) {            $order_pay = intval($_POST['order_pay']);        }        if(isset($_POST['order_comments'])) {            $order_comments = trim($_POST['order_comments']);        }        if(isset($_POST['order_edit'])) {            $order_edit = intval($_POST['order_edit']);        } else {            $order_edit = 0;        }        if((!isset($_POST['order_id']) or ($order_edit == 0 and (!isset($_POST['order_status']) or !isset($_POST['order_status_old']))) or ($order_edit == 1 and (!isset($_POST['order_status']) or !isset($_POST['order_status_old']) or !isset($_POST['order_date']) or !isset($_POST['order_hour']) or !isset($_POST['order_minute']) or !isset($_POST['ship_date']) or !isset($_POST['ship_hour']) or !isset($_POST['ship_minute']) or !isset($_POST['ship_name']) or !isset($_POST['ship_street']) or !isset($_POST['ship_house']) or !isset($_POST['ship_flat']) or !isset($_POST['ship_city']) or !isset($_POST['ship_state']) or !isset($_POST['ship_postalcode']) or !isset($_POST['ship_country']) or !isset($_POST['ship_telephone']) or !isset($_POST['ship_email']) or !isset($_POST['ship_addinfo']) or !isset($_POST['order_delivery']) or !isset($_POST['order_pay']) or !isset($_POST['order_comments'])))) or ($order_id == 0 or ($order_edit == 0 and ($order_status == 0 or $order_status_old == 0)) or ($order_edit == 1 and ($order_date == "" or $order_status == 0 or $order_status_old == 0 or $ship_name == "" or $ship_telephone == "" or $ship_email == "" or $order_delivery == 0 or $order_pay == 0)))) {            $this->registry->main_class->display_theme_adminheader();            $this->registry->main_class->display_theme_adminmain();            $this->registry->main_class->displayadmininfo();            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|ordernotalldata|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                $this->registry->main_class->assign("shop_message","notalldata");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|ordernotalldata|".$this->registry->language);            exit();        }        if($order_edit == 0) {            $sql = "UPDATE ".PREFIX."_orders_".$this->registry->sitelang." SET order_status =  '".$order_status."' WHERE order_id = ".$order_id;        } elseif($order_edit == 1) {            $order_date = $this->registry->main_class->format_striptags($order_date);            $order_date = $order_date.".".$order_hour.".".$order_minute;            $order_date = $this->registry->main_class->timetounix($order_date);            if($order_status == 7 or $order_status == 8) {                $ship_date = $this->registry->main_class->format_striptags($ship_date);                if($ship_date == "") {                    $ship_date = "'".$this->registry->main_class->gettime()."'";                } else {                    $ship_date = $ship_date.".".$ship_hour.".".$ship_minute;                    $ship_date = "'".$this->registry->main_class->timetounix($ship_date)."'";                }            } else {                $ship_date = 'NULL';            }            $ship_name = $this->registry->main_class->format_striptags($ship_name);            $ship_name = $this->registry->main_class->processing_data($ship_name);            $ship_telephone = $this->registry->main_class->format_striptags($ship_telephone);            $ship_telephone = $this->registry->main_class->processing_data($ship_telephone);            $ship_email = $this->registry->main_class->format_striptags($ship_email);            if(!$this->registry->main_class->check_email($this->registry->main_class->checkneed_stripslashes($ship_email))) {                $this->registry->main_class->display_theme_adminheader();                $this->registry->main_class->display_theme_adminmain();                $this->registry->main_class->displayadmininfo();                if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|shipemail|".$this->registry->language)) {                    $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                    $this->registry->main_class->assign("shop_message","incorrectemail");                    $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                    $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                }                $this->registry->main_class->database_close();                $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|shipemail|".$this->registry->language);                exit();            }            $ship_email = $this->registry->main_class->processing_data($ship_email);            $ship_country = $this->registry->main_class->format_striptags($ship_country);            if($ship_country != "") {                $ship_country = $this->registry->main_class->processing_data($ship_country);            } else {                $ship_country = 'NULL';            }            $ship_state = $this->registry->main_class->format_striptags($ship_state);            if($ship_state != "") {                $ship_state = $this->registry->main_class->processing_data($ship_state);            } else {                $ship_state = 'NULL';            }            $ship_city = $this->registry->main_class->format_striptags($ship_city);            if($ship_city != "") {                $ship_city = $this->registry->main_class->processing_data($ship_city);            } else {                $ship_city = 'NULL';            }            $ship_street = $this->registry->main_class->format_striptags($ship_street);            if($ship_street != "") {                $ship_street = $this->registry->main_class->processing_data($ship_street);            } else {                $ship_street = 'NULL';            }            $ship_house = $this->registry->main_class->format_striptags($ship_house);            if($ship_house != "") {                $ship_house = $this->registry->main_class->processing_data($ship_house);            } else {                $ship_house = 'NULL';            }            $ship_flat = $this->registry->main_class->format_striptags($ship_flat);            if($ship_flat != "") {                $ship_flat = $this->registry->main_class->processing_data($ship_flat);            } else {                $ship_flat = 'NULL';            }            $ship_postalcode = $this->registry->main_class->format_striptags($ship_postalcode);            if($ship_postalcode != "") {                $ship_postalcode = $this->registry->main_class->processing_data($ship_postalcode);            } else {                $ship_postalcode = 'NULL';            }            $ship_addinfo = $this->registry->main_class->format_striptags($ship_addinfo);            $ship_addinfo_length = strlen($ship_addinfo);            if($ship_addinfo != "") {                $ship_addinfo = $this->registry->main_class->processing_data($ship_addinfo);            } else {                $ship_addinfo = 'NULL';            }            $order_comments = $this->registry->main_class->format_striptags($order_comments);            $order_comments_length = strlen($order_comments);            if($order_comments != "") {                $order_comments = $this->registry->main_class->processing_data($order_comments);            } else {                $order_comments = 'NULL';            }            if($ship_addinfo_length > 255 or $order_comments_length > 255) {                $this->registry->main_class->display_theme_adminheader();                $this->registry->main_class->display_theme_adminmain();                $this->registry->main_class->displayadmininfo();                if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|postlength|".$this->registry->language)) {                    $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                    $this->registry->main_class->assign("shop_message","postlength");                    $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                    $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                }                $this->registry->main_class->database_close();                $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|postlength|".$this->registry->language);                exit();            }            $sql = "UPDATE ".PREFIX."_orders_".$this->registry->sitelang." SET order_amount = (SELECT sum(order_item_price*order_item_quantity) FROM ".PREFIX."_order_items_".$this->registry->sitelang." WHERE order_id = ".$order_id."),order_date = '".$order_date."',ship_date = ".$ship_date.",order_status = '".$order_status."',ship_name = ".$ship_name.",ship_telephone = ".$ship_telephone.",ship_email = ".$ship_email.",ship_country = ".$ship_country.",ship_state = ".$ship_state.",ship_city = ".$ship_city.",ship_street = ".$ship_street.",ship_house = ".$ship_house.",ship_flat = ".$ship_flat.",ship_postalcode = ".$ship_postalcode.",ship_addinfo = ".$ship_addinfo.",order_delivery = '".$order_delivery."',order_pay = '".$order_pay."',order_comments = ".$order_comments." WHERE order_id = ".$order_id;        } else {            header("Location: index.php?path=admin_shop&func=shop_orderproc&order_id=".$order_id."&lang=".$this->registry->sitelang);        }        $result = $this->db->Execute($sql);        if($result) {            $num_result = $this->db->Affected_Rows();        } else {            $error_message = $this->db->ErrorMsg();            $error_code = $this->db->ErrorNo();            $error[] = array("code" => $error_code,"message" => $error_message);        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if($result === false) {            $this->registry->main_class->assign("error",$error);            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|ordersqlerror|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                $this->registry->main_class->assign("shop_message","sqlerror");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|ordersqlerror|".$this->registry->language);            exit();        } elseif($result !== false and $num_result == 0) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|orderok|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                $this->registry->main_class->assign("shop_message","notsave");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|orderok|".$this->registry->language);            exit();        } else {            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orders|0");            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orders|".$order_status);            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orders|".$order_status_old);            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|order|".$order_id);            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|order|edit".$order_id);            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|order|ok|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                $this->registry->main_class->assign("shop_message","editorderok");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|order|ok|".$this->registry->language);        }    }    public function shop_order_status() {        if(isset($_GET['action'])) {            $action = trim($_GET['action']);        } else {            $action = "";        }        if(!isset($_GET['action']) and isset($_POST['action'])) {            $action = trim($_POST['action']);        }        if(isset($_GET['item_id'])) {            $item_id = intval($_GET['item_id']);        } else {            $item_id = 0;        }        if($item_id == 0 and isset($_POST['item_id']) and is_array($_POST['item_id']) and count($_POST['item_id']) > 0) {            $item_id_is_arr = 1;            for($i = 0,$size = count($_POST['item_id']);$i < $size;++$i) {                if($i == 0) {                    $item_id = "'".intval($_POST['item_id'][$i])."'";                } else {                    $item_id .= ",'".intval($_POST['item_id'][$i])."'";                }            }        } else {            $item_id_is_arr = 0;            $item_id = "'".$item_id."'";        }        $action = $this->registry->main_class->format_striptags($action);        if($action == "" or $item_id == "'0'") {            $this->registry->main_class->display_theme_adminheader();            $this->registry->main_class->display_theme_adminmain();            $this->registry->main_class->displayadmininfo();            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|statusordnotalldata|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPORDERSTITLE'));                $this->registry->main_class->assign("shop_message","notalldata");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|statusordnotalldata|".$this->registry->language);            exit();        }        if($action == "1" or $action == "2" or $action == "3" or $action == "4" or $action == "5" or $action == "6" or $action == "7" or $action == "8" or $action == "9") {            if($action == "7" or $action == "8") {                $ship_date = "'".$this->registry->main_class->gettime()."'";                $sql = "UPDATE ".PREFIX."_orders_".$this->registry->sitelang." SET order_status = '".$action."',ship_date = ".$ship_date." WHERE order_id IN (".$item_id.")";            } else {                $sql = "UPDATE ".PREFIX."_orders_".$this->registry->sitelang." SET order_status = '".$action."',ship_date = NULL WHERE order_id IN (".$item_id.")";            }            $result = $this->db->Execute($sql);            if($result) {                $num_result = $this->db->Affected_Rows();            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            $this->registry->main_class->assign("shop_message","status");        } elseif($action == "on" or $action == "off") {            $this->db->StartTrans();            if($action == "on") {                $delivery_status = 1;                $this->registry->main_class->assign("shop_message","delivstatuson");            } else {                $delivery_status = 0;                $this->registry->main_class->assign("shop_message","delivstatusoff");                $sql1 = "SELECT count(delivery_id) as count_rows FROM ".PREFIX."_delivery_".$this->registry->sitelang." WHERE delivery_status = '1'";                $result1 = $this->db->Execute($sql1);                if($result1) {                    if(isset($result1->fields['0'])) {                        if($item_id_is_arr == 0) {                            $numrows = intval($result1->fields['0']);                        } else {                            $numrows = intval($result1->fields['0']) - intval(count($_POST['item_id']));                        }                    } else {                        $numrows = 0;                    }                    if($numrows == 0 or ($numrows < 2 and $item_id_is_arr == 0) or ($numrows < 1 and $item_id_is_arr == 1)) {                        $this->registry->main_class->display_theme_adminheader();                        $this->registry->main_class->display_theme_adminmain();                        $this->registry->main_class->displayadmininfo();                        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|delivitems2|".$this->registry->language)) {                            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPDELIVERY'));                            $this->registry->main_class->assign("shop_message","delivitems2");                            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                        }                        $this->registry->main_class->database_close();                        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|delivitems2|".$this->registry->language);                        exit();                    }                } else {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                }            }            $sql = "UPDATE ".PREFIX."_delivery_".$this->registry->sitelang." SET delivery_status = '".$delivery_status."' WHERE delivery_id IN (".$item_id.")";            $result = $this->db->Execute($sql);            if($result) {                $num_result = $this->db->Affected_Rows();            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            if($result === false or (isset($result1) and $result1 === false)) {                $result = false;            }            $this->db->CompleteTrans();        } elseif($action == "on2" or $action == "off2") {            $this->db->StartTrans();            if($action == "on2") {                $pay_status = 1;                $this->registry->main_class->assign("shop_message","paystatuson");            } else {                $pay_status = 0;                $this->registry->main_class->assign("shop_message","paystatusoff");                $sql1 = "SELECT count(pay_id) as count_rows FROM ".PREFIX."_pay_".$this->registry->sitelang." WHERE pay_status = '1'";                $result1 = $this->db->Execute($sql1);                if($result1) {                    if(isset($result1->fields['0'])) {                        if($item_id_is_arr == 0) {                            $numrows = intval($result1->fields['0']);                        } else {                            $numrows = intval($result1->fields['0']) - intval(count($_POST['item_id']));                        }                    } else {                        $numrows = 0;                    }                    if($numrows == 0 or ($numrows < 2 and $item_id_is_arr == 0) or ($numrows < 1 and $item_id_is_arr == 1)) {                        $this->registry->main_class->display_theme_adminheader();                        $this->registry->main_class->display_theme_adminmain();                        $this->registry->main_class->displayadmininfo();                        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|payitems2|".$this->registry->language)) {                            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPPAY'));                            $this->registry->main_class->assign("shop_message","payitems2");                            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                        }                        $this->registry->main_class->database_close();                        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|payitems2|".$this->registry->language);                        exit();                    }                } else {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                }            }            $sql = "UPDATE ".PREFIX."_pay_".$this->registry->sitelang." SET pay_status = '".$pay_status."' WHERE pay_id IN (".$item_id.")";            $result = $this->db->Execute($sql);            if($result) {                $num_result = $this->db->Affected_Rows();            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            if($result === false or (isset($result1) and $result1 === false)) {                $result = false;            }            $this->db->CompleteTrans();        } elseif($action == "delete") {            $this->db->StartTrans();            $sql1 = "DELETE FROM ".PREFIX."_order_items_".$this->registry->sitelang." WHERE order_id IN (".$item_id.")";            $result1 = $this->db->Execute($sql1);            if($result1 === false) {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            $sql = "DELETE FROM ".PREFIX."_orders_".$this->registry->sitelang." WHERE order_id IN (".$item_id.")";            $result = $this->db->Execute($sql);            if($result) {                $num_result = $this->db->Affected_Rows();            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            if($result1 === false) {                $result = false;            }            $this->db->CompleteTrans();            $this->registry->main_class->assign("shop_message","orderdelete");        } elseif($action == "delete2") {            $this->db->StartTrans();            $sql1 = "SELECT count(order_item_id) as count_rows,max(order_id) FROM ".PREFIX."_order_items_".$this->registry->sitelang." WHERE order_id = (SELECT DISTINCT b.order_id FROM ".PREFIX."_order_items_".$this->registry->sitelang." b WHERE b.order_item_id IN (".$item_id."))";            $result1 = $this->db->Execute($sql1);            if($result1) {                if(isset($result1->fields['0'])) {                    if($item_id_is_arr == 0) {                        $numrows = intval($result1->fields['0']);                    } else {                        $numrows = intval($result1->fields['0']) - intval(count($_POST['item_id']));                    }                    $order_id = intval($result1->fields['1']);                } else {                    $numrows = 0;                }                if($numrows == 0 or ($numrows < 2 and $item_id_is_arr == 0) or ($numrows < 1 and $item_id_is_arr == 1)) {                    $this->registry->main_class->display_theme_adminheader();                    $this->registry->main_class->display_theme_adminmain();                    $this->registry->main_class->displayadmininfo();                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|orderitems|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPORDERSTITLE'));                        $this->registry->main_class->assign("shop_message","orderitems");                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|orderitems|".$this->registry->language);                    exit();                }                $sql = "DELETE FROM ".PREFIX."_order_items_".$this->registry->sitelang." WHERE order_item_id IN (".$item_id.")";                $result = $this->db->Execute($sql);                if($result) {                    $num_result = $this->db->Affected_Rows();                } else {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                }                $sql2 = "UPDATE ".PREFIX."_orders_".$this->registry->sitelang." SET order_amount = (SELECT sum(b.order_item_price*b.order_item_quantity) FROM ".PREFIX."_order_items_".$this->registry->sitelang." b WHERE b.order_id = ".$order_id.") WHERE order_id = ".$order_id;                $result2 = $this->db->Execute($sql2);                if($result2 === false) {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                }            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            if($result1 === false or (isset($result2) and $result2 === false)) {                $result = false;            }            $this->db->CompleteTrans();            $this->registry->main_class->assign("shop_message","itemdelete");        } elseif($action == "delete3") {            $this->db->StartTrans();            $sql1 = "SELECT count(delivery_id) as count_rows FROM ".PREFIX."_delivery_".$this->registry->sitelang;            $result1 = $this->db->Execute($sql1);            if($result1) {                if(isset($result1->fields['0'])) {                    if($item_id_is_arr == 0) {                        $numrows = intval($result1->fields['0']);                    } else {                        $numrows = intval($result1->fields['0']) - intval(count($_POST['item_id']));                    }                } else {                    $numrows = 0;                }                if($numrows == 0 or ($numrows < 2 and $item_id_is_arr == 0) or ($numrows < 1 and $item_id_is_arr == 1)) {                    $this->registry->main_class->display_theme_adminheader();                    $this->registry->main_class->display_theme_adminmain();                    $this->registry->main_class->displayadmininfo();                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|delivitems|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPDELIVERY'));                        $this->registry->main_class->assign("shop_message","delivitems");                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|delivitems|".$this->registry->language);                    exit();                }                $sql2 = "DELETE FROM ".PREFIX."_order_items_".$this->registry->sitelang." WHERE order_id IN (SELECT order_id FROM ".PREFIX."_orders_".$this->registry->sitelang." WHERE order_delivery IN (".$item_id."))";                $result2 = $this->db->Execute($sql2);                if($result2 === false) {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                }                $sql3 = "DELETE FROM ".PREFIX."_orders_".$this->registry->sitelang." WHERE order_delivery IN (".$item_id.")";                $result3 = $this->db->Execute($sql3);                if($result3 === false) {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                }                $sql = "DELETE FROM ".PREFIX."_delivery_".$this->registry->sitelang." WHERE delivery_id IN (".$item_id.")";                $result = $this->db->Execute($sql);                if($result) {                    $num_result = $this->db->Affected_Rows();                } else {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                }            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            if($result1 === false or (isset($result2) and $result2 === false) or (isset($result3) and $result3 === false)) {                $result = false;            }            $this->db->CompleteTrans();            $this->registry->main_class->assign("shop_message","delivdelete");        } elseif($action == "delete4") {            $this->db->StartTrans();            $sql1 = "SELECT count(pay_id) as count_rows FROM ".PREFIX."_pay_".$this->registry->sitelang;            $result1 = $this->db->Execute($sql1);            if($result1) {                if(isset($result1->fields['0'])) {                    if($item_id_is_arr == 0) {                        $numrows = intval($result1->fields['0']);                    } else {                        $numrows = intval($result1->fields['0']) - intval(count($_POST['item_id']));                    }                } else {                    $numrows = 0;                }                if($numrows == 0 or ($numrows < 2 and $item_id_is_arr == 0) or ($numrows < 1 and $item_id_is_arr == 1)) {                    $this->registry->main_class->display_theme_adminheader();                    $this->registry->main_class->display_theme_adminmain();                    $this->registry->main_class->displayadmininfo();                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|payitems|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPPAY'));                        $this->registry->main_class->assign("shop_message","payitems");                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|payitems|".$this->registry->language);                    exit();                }                $sql2 = "DELETE FROM ".PREFIX."_order_items_".$this->registry->sitelang." WHERE order_id IN (SELECT order_id FROM ".PREFIX."_orders_".$this->registry->sitelang." WHERE order_pay IN (".$item_id."))";                $result2 = $this->db->Execute($sql2);                if($result2 === false) {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                }                $sql3 = "DELETE FROM ".PREFIX."_orders_".$this->registry->sitelang." WHERE order_pay IN (".$item_id.")";                $result3 = $this->db->Execute($sql3);                if($result3 === false) {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                }                $sql = "DELETE FROM ".PREFIX."_pay_".$this->registry->sitelang." WHERE pay_id IN (".$item_id.")";                $result = $this->db->Execute($sql);                if($result) {                    $num_result = $this->db->Affected_Rows();                } else {                    $error_message = $this->db->ErrorMsg();                    $error_code = $this->db->ErrorNo();                    $error[] = array("code" => $error_code,"message" => $error_message);                }            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);            }            if($result1 === false or (isset($result2) and $result2 === false) or (isset($result3) and $result3 === false)) {                $result = false;            }            $this->db->CompleteTrans();            $this->registry->main_class->assign("shop_message","paydelete");        } else {            $this->registry->main_class->database_close();            header("Location: index.php?path=admin_shop&func=shop_orders&lang=".$this->registry->sitelang);            exit();        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if($result === false) {            $this->registry->main_class->assign("error",$error);            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|ord".$action."sqlerror|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($action == "delete3" or $action == "on" or $action == "off") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPDELIVERY'));                } elseif($action == "delete4" or $action == "on2" or $action == "off2") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPPAY'));                } else {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPORDERSTITLE'));                }                $this->registry->main_class->assign("shop_message","sqlerror");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|ord".$action."sqlerror|".$this->registry->language);            exit();        } elseif($result !== false and $num_result == 0) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|ord".$action."ok|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($action == "delete3" or $action == "on" or $action == "off") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPDELIVERY'));                } elseif($action == "delete4" or $action == "on2" or $action == "off2") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPPAY'));                } else {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPORDERSTITLE'));                }                $this->registry->main_class->assign("shop_message","notsave");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|ord".$action."ok|".$this->registry->language);            exit();        } else {            if($action == "1" or $action == "2" or $action == "3" or $action == "4" or $action == "5" or $action == "6" or $action == "7" or $action == "8" or $action == "9" or $action == "delete") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orders");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|order");                if($action == "delete") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                }            } elseif($action == "delete3" or $action == "on" or $action == "off") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|delivs");                if($item_id_is_arr == 0) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|deliv|edit".intval($_GET['item_id']));                } else {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|deliv");                }                if($action == "delete3") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orders");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|order");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                }                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout|display|admin");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout|display|other");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout2|display|admin");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout2|display|other");            } elseif($action == "delete4" or $action == "on2" or $action == "off2") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|pays");                if($item_id_is_arr == 0) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|pay|edit".intval($_GET['item_id']));                } else {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|pay");                }                if($action == "delete4") {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orders");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|order");                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi");                }                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout|display|admin");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout|display|other");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout2|display|admin");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout2|display|other");            } else {                $this->registry->main_class->assign("adminmodules_shop_order_id",$order_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|order|".$order_id);                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|order|edit".$order_id);                if($item_id_is_arr == 0) {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi|".$order_id."|editi".intval($_GET['item_id']));                } else {                    $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi|".$order_id);                }            }            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|ord".$action."|ok|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($action == "delete3" or $action == "on" or $action == "off") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPDELIVERY'));                } elseif($action == "delete4" or $action == "on2" or $action == "off2") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPPAY'));                } else {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPORDERSTITLE'));                }                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|ord".$action."|ok|".$this->registry->language);        }    }    public function shop_orderi_edit() {        if(isset($_GET['item_id'])) {            $item_id = intval($_GET['item_id']);        } else {            $item_id = 0;        }        if(isset($_GET['order_id'])) {            $order_id = intval($_GET['order_id']);        } else {            $order_id = 0;        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if($item_id == 0 or $order_id == 0) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|noitem|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                $this->registry->main_class->assign("shop_message","noitem");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|noitem|".$this->registry->language);            exit();        }        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|orderi|".$order_id."|editi".$item_id."|".$this->registry->language)) {            $sql = "SELECT a.order_item_id,a.order_id,a.item_id,a.order_item_name,a.order_item_price,a.order_item_quantity,b.item_catalog_id,b.item_category_id,b.item_subcategory_id,f.catalog_id as categ_cat_id,g.category_id as subcateg_categ_id,h.catalog_id as subcateg_cat_id FROM ".PREFIX."_order_items_".$this->registry->sitelang." a LEFT OUTER JOIN ".PREFIX."_items_".$this->registry->sitelang." b ON a.item_id = b.item_id LEFT OUTER JOIN ".PREFIX."_catalogs_".$this->registry->sitelang." c ON b.item_catalog_id = c.catalog_id and b.item_catalog_id is NOT NULL "."LEFT OUTER JOIN ".PREFIX."_categories_".$this->registry->sitelang." d ON b.item_category_id = d.category_id and b.item_category_id is NOT NULL LEFT OUTER JOIN ".PREFIX."_catalogs_".$this->registry->sitelang." f ON d.cat_catalog_id=f.catalog_id and b.item_category_id is NOT NULL "."LEFT OUTER JOIN ".PREFIX."_subcategories_".$this->registry->sitelang." e ON b.item_subcategory_id = e.subcategory_id and b.item_subcategory_id is NOT NULL LEFT OUTER JOIN ".PREFIX."_categories_".$this->registry->sitelang." g ON e.subcategory_cat_id=g.category_id and b.item_subcategory_id is NOT NULL LEFT OUTER JOIN ".PREFIX."_catalogs_".$this->registry->sitelang." h ON g.cat_catalog_id=h.catalog_id and b.item_subcategory_id is NOT NULL "."WHERE a.order_item_id = ".$item_id." and a.order_id = ".$order_id;            $result = $this->db->Execute($sql);            if($result) {                if(isset($result->fields['0'])) {                    $numrows = intval($result->fields['0']);                } else {                    $numrows = 0;                }                if($numrows > 0) {                    while(!$result->EOF) {                        $order_item_id = intval($result->fields['0']);                        $order_id = intval($result->fields['1']);                        $item_id2 = intval($result->fields['2']);                        $order_item_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['3']));                        $order_item_price = floatval($result->fields['4']);                        $order_item_quantity = intval($result->fields['5']);                        $item_catalog_id = intval($result->fields['6']);                        $item_category_id = intval($result->fields['7']);                        if($item_category_id > 0) {                            $item_categ_cat_id = intval($result->fields['9']);                        } else {                            $item_categ_cat_id = "no";                        }                        $item_subcategory_id = intval($result->fields['8']);                        if($item_subcategory_id > 0) {                            $item_subcateg_categ_id = intval($result->fields['10']);                            $item_subcateg_cat_id = intval($result->fields['11']);                        } else {                            $item_subcateg_categ_id = "no";                            $item_subcateg_cat_id = "no";                        }                        $order_item_all[] = array(                            "order_item_id" => $order_item_id,                            "order_id" => $order_id,                            "item_id" => $item_id2,                            "order_item_name" => $order_item_name,                            "order_item_price" => $order_item_price,                            "order_item_quantity" => $order_item_quantity,                            "item_catalog_id" => $item_catalog_id,                            "item_category_id" => $item_category_id,                            "item_categ_cat_id" => $item_categ_cat_id,                            "item_subcategory_id" => $item_subcategory_id,                            "item_subcateg_categ_id" => $item_subcateg_categ_id,                            "item_subcateg_cat_id" => $item_subcateg_cat_id                        );                        $result->MoveNext();                    }                    $this->registry->main_class->assign("order_item_all",$order_item_all);                } else {                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfoundordi|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                        $this->registry->main_class->assign("shop_message","notfounditem");                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfoundordi|".$this->registry->language);                    exit();                }            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);                $this->registry->main_class->assign("error",$error);                if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerrorordi|".$this->registry->language)) {                    $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                    $this->registry->main_class->assign("shop_message","sqlerror");                    $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                    $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                }                $this->registry->main_class->database_close();                $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerrorordi|".$this->registry->language);                exit();            }            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_orderi_edit.html");        }        $this->registry->main_class->database_close();        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|orderi|".$order_id."|editi".$item_id."|".$this->registry->language);    }    public function shop_orderi_save() {        if(isset($_POST['order_item_id'])) {            $order_item_id = intval($_POST['order_item_id']);        }        if(isset($_POST['order_id'])) {            $order_id = intval($_POST['order_id']);        }        if(isset($_POST['order_item_name'])) {            $order_item_name = trim($_POST['order_item_name']);        }        if(isset($_POST['order_item_price'])) {            $order_item_price = $this->registry->main_class->float2db($_POST['order_item_price']);        }        if(isset($_POST['order_item_quantity'])) {            $order_item_quantity = intval($_POST['order_item_quantity']);        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if((!isset($_POST['order_item_id']) or !isset($_POST['order_id']) or !isset($_POST['order_item_name']) or !isset($_POST['order_item_price']) or !isset($_POST['order_item_quantity'])) or ($order_item_id == 0 or $order_id == 0 or $order_item_name == "" or $order_item_quantity == 0)) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|ordinotalldata|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                $this->registry->main_class->assign("shop_message","notalldata");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|ordinotalldata|".$this->registry->language);            exit();        }        $order_item_name = $this->registry->main_class->format_striptags($order_item_name);        $order_item_name = $this->registry->main_class->processing_data($order_item_name);        $this->db->StartTrans();        $sql = "UPDATE ".PREFIX."_order_items_".$this->registry->sitelang." SET order_item_name = ".$order_item_name.",order_item_price = '".$order_item_price."',order_item_quantity = '".$order_item_quantity."' WHERE order_item_id = ".$order_item_id;        $result = $this->db->Execute($sql);        if($result) {            $num_result = $this->db->Affected_Rows();        } else {            $error_message = $this->db->ErrorMsg();            $error_code = $this->db->ErrorNo();            $error[] = array("code" => $error_code,"message" => $error_message);        }        $sql2 = "UPDATE ".PREFIX."_orders_".$this->registry->sitelang." SET order_amount = (SELECT sum(b.order_item_price*b.order_item_quantity) FROM ".PREFIX."_order_items_".$this->registry->sitelang." b WHERE b.order_id = ".$order_id.") WHERE order_id = ".$order_id;        $result2 = $this->db->Execute($sql2);        if($result2 === false) {            $error_message = $this->db->ErrorMsg();            $error_code = $this->db->ErrorNo();            $error[] = array("code" => $error_code,"message" => $error_message);        }        if($result2 === false) {            $result = false;        }        $this->db->CompleteTrans();        if($result === false) {            $this->registry->main_class->assign("error",$error);            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|ordieditsqlerror|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                $this->registry->main_class->assign("shop_message","sqlerror");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|ordieditsqlerror|".$this->registry->language);            exit();        } elseif($result !== false and $num_result == 0) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|ordieditok|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                $this->registry->main_class->assign("shop_message","notsave");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|ordieditok|".$this->registry->language);            exit();        } else {            $this->registry->main_class->assign("adminmodules_shop_order_id",$order_id);            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|order|".$order_id);            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|order|edit".$order_id);            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|orderi|".$order_id."|editi".$order_item_id);            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|ordiedit|ok|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITORDER'));                $this->registry->main_class->assign("shop_message","itemupdate");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|ordiedit|ok|".$this->registry->language);        }    }    public function shop_methods() {        if(isset($_GET['pay'])) {            $pay = intval($_GET['pay']);        } else {            $pay = 0;        }        if($pay == 0) {            $cache = "delivs";        } else {            $cache = "pays";        }        if(isset($_GET['num_page']) and intval($_GET['num_page']) != 0) {            $num_page = intval($_GET['num_page']);            if($num_page == 0) {                $num_page = 1;            }        } else {            $num_page = 1;        }        $num_string_rows = SYSTEMDK_ADMINROWS_PERPAGE;        $offset = ($num_page - 1) * $num_string_rows;        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cache."|".$num_page."|".$this->registry->language)) {            if($cache == "delivs") {                $sql = "SELECT a.delivery_id,a.delivery_name,a.delivery_price,a.delivery_status,(SELECT count(*) FROM ".PREFIX."_delivery_".$this->registry->sitelang." b) as count_rows FROM ".PREFIX."_delivery_".$this->registry->sitelang." a";            } else {                $sql = "SELECT a.pay_id,a.pay_name,a.pay_price,a.pay_status,(SELECT count(*) FROM ".PREFIX."_pay_".$this->registry->sitelang." b ) as count_rows FROM ".PREFIX."_pay_".$this->registry->sitelang." a";            }            $result = $this->db->SelectLimit($sql,$num_string_rows,$offset);            if($result) {                if(isset($result->fields['0'])) {                    $numrows = intval($result->fields['0']);                } else {                    $numrows = 0;                }                if($numrows == 0 and $num_page > 1) {                    $this->registry->main_class->database_close();                    if($cache == "delivs") {                        header("Location: index.php?path=admin_shop&func=shop_methods&lang=".$this->registry->sitelang);                    } else {                        header("Location: index.php?path=admin_shop&func=shop_methods&pay=1&lang=".$this->registry->sitelang);                    }                    exit();                }                if($numrows > 0) {                    while(!$result->EOF) {                        if(!isset($numrows2)) {                            $numrows2 = intval($result->fields['4']);                        }                        $item_id = intval($result->fields['0']);                        $item_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['1']));                        $item_price = number_format(floatval($result->fields['2']),2,'.',' ');                        $item_status = intval($result->fields['3']);                        $items_all[] = array(                            "item_id" => $item_id,                            "item_name" => $item_name,                            "item_price" => $item_price,                            "item_status" => $item_status                        );                        $result->MoveNext();                    }                    $this->registry->main_class->assign("items_all",$items_all);                    if(isset($numrows2)) {                        $num_pages = @ceil($numrows2 / $num_string_rows);                    } else {                        $num_pages = 0;                    }                    if($num_pages > 1) {                        if($num_page > 1) {                            $prevpage = $num_page - 1;                            $this->registry->main_class->assign("prevpage",$prevpage);                        } else {                            $this->registry->main_class->assign("prevpage","no");                        }                        for($i = 1;$i < $num_pages + 1;$i++) {                            if($i == $num_page) {                                $html[] = array("number" => $i,"param1" => "1");                            } else {                                $pagelink = 5;                                if(($i > $num_page) and ($i < $num_page + $pagelink) or ($i < $num_page) and ($i > $num_page - $pagelink)) {                                    $html[] = array("number" => $i,"param1" => "2");                                }                                if(($i == $num_pages) and ($num_page < $num_pages - $pagelink)) {                                    $html[] = array("number" => $i,"param1" => "3");                                }                                if(($i == 1) and ($num_page > $pagelink + 1)) {                                    $html[] = array("number" => $i,"param1" => "4");                                }                            }                        }                        if($num_page < $num_pages) {                            $nextpage = $num_page + 1;                            $this->registry->main_class->assign("nextpage",$nextpage);                        } else {                            $this->registry->main_class->assign("nextpage","no");                        }                        $this->registry->main_class->assign("html",$html);                        $this->registry->main_class->assign("totalitems",$numrows2);                        $this->registry->main_class->assign("num_pages",$num_pages);                    } else {                        $this->registry->main_class->assign("html","no");                    }                } else {                    $this->registry->main_class->assign("items_all","no");                    $this->registry->main_class->assign("html","no");                }            } else {                $this->registry->main_class->display_theme_adminheader();                $this->registry->main_class->display_theme_adminmain();                $this->registry->main_class->displayadmininfo();                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);                $this->registry->main_class->assign("error",$error);                if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$cache."sqlerror|".$this->registry->language)) {                    $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                    if($cache == "delivs") {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPDELIVERY'));                    } else {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPPAY'));                    }                    $this->registry->main_class->assign("shop_message","sqlerror");                    $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                    $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                }                $this->registry->main_class->database_close();                $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$cache."sqlerror|".$this->registry->language);                exit();            }        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cache."|".$num_page."|".$this->registry->language)) {            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");            $this->registry->main_class->assign("adminmodules_shop_method",$cache);            if($cache == "delivs") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPDELIVERY'));            } else {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPPAY'));            }            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_methods.html");        }        $this->registry->main_class->database_close();        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cache."|".$num_page."|".$this->registry->language);    }    public function shop_edit_method() {        if(isset($_GET['item_id'])) {            $item_id = intval($_GET['item_id']);        } else {            $item_id = 0;        }        if(isset($_GET['pay'])) {            $pay = intval($_GET['pay']);        } else {            $pay = 0;        }        if($pay == 0) {            $cache = "deliv";        } else {            $cache = "pay";        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if($item_id == 0) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|no".$cache."|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "deliv") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITDELIVERY'));                } else {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITPAY'));                }                $this->registry->main_class->assign("shop_message","no".$cache);                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|no".$cache."|".$this->registry->language);            exit();        }        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cache."|edit".$item_id."|".$this->registry->language)) {            if($cache == "deliv") {                $sql = "SELECT delivery_id,delivery_name,delivery_price,delivery_status FROM ".PREFIX."_delivery_".$this->registry->sitelang." WHERE delivery_id = ".$item_id;            } else {                $sql = "SELECT pay_id,pay_name,pay_price,pay_status FROM ".PREFIX."_pay_".$this->registry->sitelang." WHERE pay_id = ".$item_id;            }            $result = $this->db->Execute($sql);            if($result) {                if(isset($result->fields['0'])) {                    $numrows = intval($result->fields['0']);                } else {                    $numrows = 0;                }                if($numrows > 0) {                    while(!$result->EOF) {                        $item_id = intval($result->fields['0']);                        $item_name = $this->registry->main_class->format_htmlspecchars($this->registry->main_class->extracting_data($result->fields['1']));                        $item_price = floatval($result->fields['2']);                        $item_status = intval($result->fields['3']);                        $item_all[] = array(                            "item_id" => $item_id,                            "item_name" => $item_name,                            "item_price" => $item_price,                            "item_status" => $item_status                        );                        $result->MoveNext();                    }                    $this->registry->main_class->assign("item_all",$item_all);                } else {                    if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound".$cache."|".$this->registry->language)) {                        $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                        if($cache == "deliv") {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITDELIVERY'));                        } else {                            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITPAY'));                        }                        $this->registry->main_class->assign("shop_message","notfound".$cache);                        $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                        $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                    }                    $this->registry->main_class->database_close();                    $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|notfound".$cache."|".$this->registry->language);                    exit();                }            } else {                $error_message = $this->db->ErrorMsg();                $error_code = $this->db->ErrorNo();                $error[] = array("code" => $error_code,"message" => $error_message);                $this->registry->main_class->assign("error",$error);                if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerror".$cache."|".$this->registry->language)) {                    $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                    if($cache == "deliv") {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITDELIVERY'));                    } else {                        $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITPAY'));                    }                    $this->registry->main_class->assign("shop_message","sqlerror");                    $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                    $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");                }                $this->registry->main_class->database_close();                $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|sqlerror".$cache."|".$this->registry->language);                exit();            }            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");            $this->registry->main_class->assign("adminmodules_shop_method",$cache);            if($cache == "deliv") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITDELIVERY'));            } else {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITPAY'));            }            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_method_edit.html");        }        $this->registry->main_class->database_close();        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cache."|edit".$item_id."|".$this->registry->language);    }    public function shop_method_save() {        if(isset($_POST['item_id'])) {            $item_id = intval($_POST['item_id']);        }        if(isset($_POST['item_name'])) {            $item_name = trim($_POST['item_name']);        }        if(isset($_POST['item_price'])) {            $item_price = $this->registry->main_class->float2db($_POST['item_price']);        }        if(isset($_POST['item_status'])) {            $item_status = intval($_POST['item_status']);        }        if(isset($_POST['pay'])) {            $pay = intval($_POST['pay']);        } else {            $pay = 0;        }        if($pay == 0) {            $cache = "deliv";        } else {            $cache = "pay";        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if((!isset($_POST['item_id']) or !isset($_POST['item_name']) or !isset($_POST['item_price']) or !isset($_POST['item_status'])) or ($item_id == 0 or $item_name == "")) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$cache."notalldata|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "deliv") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITDELIVERY'));                } else {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITPAY'));                }                $this->registry->main_class->assign("shop_message","notalldata");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$cache."notalldata|".$this->registry->language);            exit();        }        $item_name = $this->registry->main_class->format_striptags($item_name);        $item_name = $this->registry->main_class->processing_data($item_name);        if($cache == "deliv") {            $sql = "UPDATE ".PREFIX."_delivery_".$this->registry->sitelang." SET delivery_name = ".$item_name.",delivery_price = '".$item_price."',delivery_status = '".$item_status."' WHERE delivery_id = ".$item_id;        } else {            $sql = "UPDATE ".PREFIX."_pay_".$this->registry->sitelang." SET pay_name = ".$item_name.",pay_price = '".$item_price."',pay_status = '".$item_status."' WHERE pay_id = ".$item_id;        }        $result = $this->db->Execute($sql);        if($result) {            $num_result = $this->db->Affected_Rows();        } else {            $error_message = $this->db->ErrorMsg();            $error_code = $this->db->ErrorNo();            $error[] = array("code" => $error_code,"message" => $error_message);        }        if($result === false) {            $this->registry->main_class->assign("error",$error);            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$cache."editsqlerror|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "deliv") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITDELIVERY'));                } else {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITPAY'));                }                $this->registry->main_class->assign("shop_message","sqlerror");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$cache."editsqlerror|".$this->registry->language);            exit();        } elseif($result !== false and $num_result == 0) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$cache."editok|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "deliv") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITDELIVERY'));                } else {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITPAY'));                }                $this->registry->main_class->assign("shop_message","notsave");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$cache."editok|".$this->registry->language);            exit();        } else {            if($cache == "deliv") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|delivs");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|deliv|edit".$item_id);            } else {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|pays");                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|pay|edit".$item_id);            }            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|order");            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout|display|admin");            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout|display|other");            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout2|display|admin");            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout2|display|other");            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cache."edit|ok|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "deliv") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITDELIVERY'));                } else {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPEDITPAY'));                }                $this->registry->main_class->assign("shop_message","update".$cache);                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cache."edit|ok|".$this->registry->language);        }    }    public function shop_method_add() {        if(isset($_GET['pay'])) {            $pay = intval($_GET['pay']);        } else {            $pay = 0;        }        if($pay == 0) {            $cache = "deliv";        } else {            $cache = "pay";        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cache."|add|".$this->registry->language)) {            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");            $this->registry->main_class->assign("adminmodules_shop_method",$cache);            if($cache == "deliv") {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPADDDELIVERY'));            } else {                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPADDPAY'));            }            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_method_add.html");        }        $this->registry->main_class->database_close();        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cache."|add|".$this->registry->language);    }    public function shop_method_save2() {        if(isset($_POST['item_name'])) {            $item_name = trim($_POST['item_name']);        }        if(isset($_POST['item_price'])) {            $item_price = $this->registry->main_class->float2db($_POST['item_price']);        }        if(isset($_POST['item_status'])) {            $item_status = intval($_POST['item_status']);        }        if(isset($_POST['pay'])) {            $pay = intval($_POST['pay']);        } else {            $pay = 0;        }        if($pay == 0) {            $cache = "deliv";        } else {            $cache = "pay";        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if((!isset($_POST['item_name']) or !isset($_POST['item_price']) or !isset($_POST['item_status'])) or ($item_name == "")) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|add".$cache."notalldata|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "deliv") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPADDDELIVERY'));                } else {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPADDPAY'));                }                $this->registry->main_class->assign("shop_message","notalldata");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|add".$cache."notalldata|".$this->registry->language);            exit();        }        $item_name = $this->registry->main_class->format_striptags($item_name);        $item_name = $this->registry->main_class->processing_data($item_name);        if($cache == "deliv") {            $item_id = $this->db->GenID(PREFIX."_delivery_id_".$this->registry->sitelang);            $sql = "INSERT INTO ".PREFIX."_delivery_".$this->registry->sitelang." (delivery_id,delivery_name,delivery_price,delivery_status) VALUES ('".$item_id."',".$item_name.",'".$item_price."','".$item_status."')";        } else {            $item_id = $this->db->GenID(PREFIX."_pay_id_".$this->registry->sitelang);            $sql = "INSERT INTO ".PREFIX."_pay_".$this->registry->sitelang." (pay_id,pay_name,pay_price,pay_status) VALUES ('".$item_id."',".$item_name.",'".$item_price."','".$item_status."')";        }        $result = $this->db->Execute($sql);        if($result) {            $num_result = $this->db->Affected_Rows();        } else {            $error_message = $this->db->ErrorMsg();            $error_code = $this->db->ErrorNo();            $error[] = array("code" => $error_code,"message" => $error_message);        }        if($result === false) {            $this->registry->main_class->assign("error",$error);            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$cache."addsqlerror|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "deliv") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPADDDELIVERY'));                } else {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPADDPAY'));                }                $this->registry->main_class->assign("shop_message","sqlerror");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|".$cache."addsqlerror|".$this->registry->language);            exit();        } else {            if($cache == "deliv") {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|delivs");            } else {                $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|pays");            }            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|systemadmin|modules|shop|order");            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout|display|admin");            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout|display|other");            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout2|display|admin");            $this->registry->main_class->clearCache(null,$this->registry->sitelang."|modules|shop|checkout2|display|other");            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cache."add|ok|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                if($cache == "deliv") {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPADDDELIVERY'));                } else {                    $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPADDPAY'));                }                $this->registry->main_class->assign("shop_message","add".$cache);                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|".$cache."add|ok|".$this->registry->language);        }    }    public function shop_config() {        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|config|".$this->registry->language)) {            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCONFIGPAGETITLE'));            require_once('../modules/shop/shop_config.inc');            $this->registry->main_class->assign("systemdk_shop_catalogs_order",trim(SYSTEMDK_SHOP_CATALOGS_ORDER));            $this->registry->main_class->assign("systemdk_shop_homeitems_perpage",intval(SYSTEMDK_SHOP_HOMEITEMS_PERPAGE));            $this->registry->main_class->assign("systemdk_shop_homeitems_order",trim(SYSTEMDK_SHOP_HOMEITEMS_ORDER));            $this->registry->main_class->assign("systemdk_shop_categories_order",trim(SYSTEMDK_SHOP_CATEGORIES_ORDER));            $this->registry->main_class->assign("systemdk_shop_catitems_perpage",intval(SYSTEMDK_SHOP_CATITEMS_PERPAGE));            $this->registry->main_class->assign("systemdk_shop_catitems_order",trim(SYSTEMDK_SHOP_CATITEMS_ORDER));            $this->registry->main_class->assign("systemdk_shop_subcategories_order",trim(SYSTEMDK_SHOP_SUBCATEGORIES_ORDER));            $this->registry->main_class->assign("systemdk_shop_categitems_perpage",intval(SYSTEMDK_SHOP_CATEGITEMS_PERPAGE));            $this->registry->main_class->assign("systemdk_shop_categitems_order",trim(SYSTEMDK_SHOP_CATEGITEMS_ORDER));            $this->registry->main_class->assign("systemdk_shop_subcategitems_perpage",intval(SYSTEMDK_SHOP_SUBCATEGITEMS_PERPAGE));            $this->registry->main_class->assign("systemdk_shop_subcategitems_order",trim(SYSTEMDK_SHOP_SUBCATEGITEMS_ORDER));            $this->registry->main_class->assign("systemdk_shop_itemimage_path",trim(SYSTEMDK_SHOP_ITEMIMAGE_PATH));            $this->registry->main_class->assign("systemdk_shop_itemimage_position",trim(SYSTEMDK_SHOP_ITEMIMAGE_POSITION));            $this->registry->main_class->assign("systemdk_shop_itemimage_maxsize",intval(SYSTEMDK_SHOP_ITEMIMAGE_MAXSIZE));            $this->registry->main_class->assign("systemdk_shop_itemimage_maxwidth",intval(SYSTEMDK_SHOP_ITEMIMAGE_MAXWIDTH));            $this->registry->main_class->assign("systemdk_shop_itemimage_maxheight",intval(SYSTEMDK_SHOP_ITEMIMAGE_MAXHEIGHT));            $this->registry->main_class->assign("systemdk_shop_itemimage_width",intval(SYSTEMDK_SHOP_ITEMIMAGE_WIDTH));            $this->registry->main_class->assign("systemdk_shop_itemimage_width2",intval(SYSTEMDK_SHOP_ITEMIMAGE_WIDTH2));            $this->registry->main_class->assign("systemdk_shop_itemimage_width3",intval(SYSTEMDK_SHOP_ITEMIMAGE_WIDTH3));            $this->registry->main_class->assign("systemdk_shop_itemimage_height3",intval(SYSTEMDK_SHOP_ITEMIMAGE_HEIGHT3));            $this->registry->main_class->assign("systemdk_shop_image_path",trim(SYSTEMDK_SHOP_IMAGE_PATH));            $this->registry->main_class->assign("systemdk_shop_image_position",trim(SYSTEMDK_SHOP_IMAGE_POSITION));            $this->registry->main_class->assign("systemdk_shop_image_maxsize",intval(SYSTEMDK_SHOP_IMAGE_MAXSIZE));            $this->registry->main_class->assign("systemdk_shop_image_maxwidth",intval(SYSTEMDK_SHOP_IMAGE_MAXWIDTH));            $this->registry->main_class->assign("systemdk_shop_image_maxheight",intval(SYSTEMDK_SHOP_IMAGE_MAXHEIGHT));            $this->registry->main_class->assign("systemdk_shop_image_width",intval(SYSTEMDK_SHOP_IMAGE_WIDTH));            $this->registry->main_class->assign("systemdk_shop_items_columns",intval(SYSTEMDK_SHOP_ITEMS_COLUMNS));            $this->registry->main_class->assign("systemdk_shop_items_underparent",intval(SYSTEMDK_SHOP_ITEMS_UNDERPARENT));            $this->registry->main_class->assign("systemdk_shop_valuta",trim(SYSTEMDK_SHOP_VALUTA));            $this->registry->main_class->assign("systemdk_shop_antispam_ipaddr",intval(SYSTEMDK_SHOP_ANTISPAM_IPADDR));            $this->registry->main_class->assign("systemdk_shop_antispam_num",intval(SYSTEMDK_SHOP_ANTISPAM_NUM));            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_config.html");        }        $this->registry->main_class->database_close();        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|config|".$this->registry->language);    }    function shop_config_save() {        if(isset($_POST['systemdk_shop_catalogs_order'])) {            $systemdk_shop_catalogs_order = trim($_POST['systemdk_shop_catalogs_order']);        }        if(isset($_POST['systemdk_shop_homeitems_perpage'])) {            $systemdk_shop_homeitems_perpage = intval($_POST['systemdk_shop_homeitems_perpage']);        }        if(isset($_POST['systemdk_shop_homeitems_order'])) {            $systemdk_shop_homeitems_order = trim($_POST['systemdk_shop_homeitems_order']);        }        if(isset($_POST['systemdk_shop_categories_order'])) {            $systemdk_shop_categories_order = trim($_POST['systemdk_shop_categories_order']);        }        if(isset($_POST['systemdk_shop_catitems_perpage'])) {            $systemdk_shop_catitems_perpage = intval($_POST['systemdk_shop_catitems_perpage']);        }        if(isset($_POST['systemdk_shop_catitems_order'])) {            $systemdk_shop_catitems_order = trim($_POST['systemdk_shop_catitems_order']);        }        if(isset($_POST['systemdk_shop_subcategories_order'])) {            $systemdk_shop_subcategories_order = trim($_POST['systemdk_shop_subcategories_order']);        }        if(isset($_POST['systemdk_shop_categitems_perpage'])) {            $systemdk_shop_categitems_perpage = intval($_POST['systemdk_shop_categitems_perpage']);        }        if(isset($_POST['systemdk_shop_categitems_order'])) {            $systemdk_shop_categitems_order = trim($_POST['systemdk_shop_categitems_order']);        }        if(isset($_POST['systemdk_shop_subcategitems_perpage'])) {            $systemdk_shop_subcategitems_perpage = intval($_POST['systemdk_shop_subcategitems_perpage']);        }        if(isset($_POST['systemdk_shop_subcategitems_order'])) {            $systemdk_shop_subcategitems_order = trim($_POST['systemdk_shop_subcategitems_order']);        }        if(isset($_POST['systemdk_shop_itemimage_path'])) {            $systemdk_shop_itemimage_path = trim($_POST['systemdk_shop_itemimage_path']);        }        if(isset($_POST['systemdk_shop_itemimage_position'])) {            $systemdk_shop_itemimage_position = trim($_POST['systemdk_shop_itemimage_position']);        }        if(isset($_POST['systemdk_shop_itemimage_maxsize'])) {            $systemdk_shop_itemimage_maxsize = intval($_POST['systemdk_shop_itemimage_maxsize']);        }        if(isset($_POST['systemdk_shop_itemimage_maxwidth'])) {            $systemdk_shop_itemimage_maxwidth = intval($_POST['systemdk_shop_itemimage_maxwidth']);        }        if(isset($_POST['systemdk_shop_itemimage_maxheight'])) {            $systemdk_shop_itemimage_maxheight = intval($_POST['systemdk_shop_itemimage_maxheight']);        }        if(isset($_POST['systemdk_shop_itemimage_width'])) {            $systemdk_shop_itemimage_width = intval($_POST['systemdk_shop_itemimage_width']);        }        if(isset($_POST['systemdk_shop_itemimage_width2'])) {            $systemdk_shop_itemimage_width2 = intval($_POST['systemdk_shop_itemimage_width2']);        }        if(isset($_POST['systemdk_shop_itemimage_width3'])) {            $systemdk_shop_itemimage_width3 = intval($_POST['systemdk_shop_itemimage_width3']);        }        if(isset($_POST['systemdk_shop_itemimage_height3'])) {            $systemdk_shop_itemimage_height3 = intval($_POST['systemdk_shop_itemimage_height3']);        }        if(isset($_POST['systemdk_shop_image_path'])) {            $systemdk_shop_image_path = trim($_POST['systemdk_shop_image_path']);        }        if(isset($_POST['systemdk_shop_image_position'])) {            $systemdk_shop_image_position = trim($_POST['systemdk_shop_image_position']);        }        if(isset($_POST['systemdk_shop_image_maxsize'])) {            $systemdk_shop_image_maxsize = intval($_POST['systemdk_shop_image_maxsize']);        }        if(isset($_POST['systemdk_shop_image_maxwidth'])) {            $systemdk_shop_image_maxwidth = intval($_POST['systemdk_shop_image_maxwidth']);        }        if(isset($_POST['systemdk_shop_image_maxheight'])) {            $systemdk_shop_image_maxheight = intval($_POST['systemdk_shop_image_maxheight']);        }        if(isset($_POST['systemdk_shop_image_width'])) {            $systemdk_shop_image_width = intval($_POST['systemdk_shop_image_width']);        }        if(isset($_POST['systemdk_shop_items_columns'])) {            $systemdk_shop_items_columns = intval($_POST['systemdk_shop_items_columns']);        }        if(isset($_POST['systemdk_shop_items_underparent'])) {            $systemdk_shop_items_underparent = intval($_POST['systemdk_shop_items_underparent']);        }        if(isset($_POST['systemdk_shop_valuta'])) {            $systemdk_shop_valuta = trim($_POST['systemdk_shop_valuta']);        }        if(isset($_POST['systemdk_shop_antispam_ipaddr'])) {            $systemdk_shop_antispam_ipaddr = intval($_POST['systemdk_shop_antispam_ipaddr']);        }        if(isset($_POST['systemdk_shop_antispam_num'])) {            $systemdk_shop_antispam_num = intval($_POST['systemdk_shop_antispam_num']);        }        $this->registry->main_class->display_theme_adminheader();        $this->registry->main_class->display_theme_adminmain();        $this->registry->main_class->displayadmininfo();        if((!isset($_POST['systemdk_shop_catalogs_order']) or !isset($_POST['systemdk_shop_homeitems_perpage']) or !isset($_POST['systemdk_shop_homeitems_order']) or !isset($_POST['systemdk_shop_categories_order']) or !isset($_POST['systemdk_shop_catitems_perpage']) or !isset($_POST['systemdk_shop_catitems_order']) or !isset($_POST['systemdk_shop_subcategories_order']) or !isset($_POST['systemdk_shop_categitems_perpage']) or !isset($_POST['systemdk_shop_categitems_order']) or !isset($_POST['systemdk_shop_subcategitems_perpage']) or !isset($_POST['systemdk_shop_subcategitems_order']) or !isset($_POST['systemdk_shop_itemimage_path']) or !isset($_POST['systemdk_shop_itemimage_position']) or !isset($_POST['systemdk_shop_itemimage_maxsize']) or !isset($_POST['systemdk_shop_itemimage_maxwidth']) or !isset($_POST['systemdk_shop_itemimage_maxheight']) or !isset($_POST['systemdk_shop_itemimage_width']) or !isset($_POST['systemdk_shop_itemimage_width2']) or !isset($_POST['systemdk_shop_itemimage_width3']) or !isset($_POST['systemdk_shop_itemimage_height3']) or !isset($_POST['systemdk_shop_image_path']) or !isset($_POST['systemdk_shop_image_position']) or !isset($_POST['systemdk_shop_image_maxsize']) or !isset($_POST['systemdk_shop_image_maxwidth']) or !isset($_POST['systemdk_shop_image_maxheight']) or !isset($_POST['systemdk_shop_image_width']) or !isset($_POST['systemdk_shop_items_columns']) or !isset($_POST['systemdk_shop_items_underparent']) or !isset($_POST['systemdk_shop_valuta']) or !isset($_POST['systemdk_shop_antispam_ipaddr']) or !isset($_POST['systemdk_shop_antispam_num'])) or ($systemdk_shop_catalogs_order == "" or $systemdk_shop_homeitems_perpage == 0 or $systemdk_shop_homeitems_order == "" or $systemdk_shop_categories_order == "" or $systemdk_shop_catitems_perpage == 0 or $systemdk_shop_catitems_order == "" or $systemdk_shop_subcategories_order == "" or $systemdk_shop_categitems_perpage == 0 or $systemdk_shop_categitems_order == "" or $systemdk_shop_subcategitems_perpage == 0 or $systemdk_shop_subcategitems_order == "" or $systemdk_shop_itemimage_path == "" or $systemdk_shop_itemimage_position == "" or $systemdk_shop_itemimage_maxsize == 0 or $systemdk_shop_itemimage_maxwidth == 0 or $systemdk_shop_itemimage_maxheight == 0 or $systemdk_shop_itemimage_width == 0 or $systemdk_shop_itemimage_width2 == 0 or $systemdk_shop_itemimage_width3 == 0 or $systemdk_shop_itemimage_height3 == 0 or $systemdk_shop_image_path == "" or $systemdk_shop_image_position == "" or $systemdk_shop_image_maxsize == 0 or $systemdk_shop_image_maxwidth == 0 or $systemdk_shop_image_maxheight == 0 or $systemdk_shop_image_width == 0 or $systemdk_shop_items_columns == 0 or $systemdk_shop_valuta == "")) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|confnotalldata|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCONFIGPAGETITLE'));                $this->registry->main_class->assign("shop_message","notalldata");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|confnotalldata|".$this->registry->language);            exit();        }        $systemdk_shop_catalogs_order = $this->registry->main_class->format_htmlspecchars_stripslashes_striptags($systemdk_shop_catalogs_order);        $systemdk_shop_homeitems_order = $this->registry->main_class->format_htmlspecchars_stripslashes_striptags($systemdk_shop_homeitems_order);        $systemdk_shop_categories_order = $this->registry->main_class->format_htmlspecchars_stripslashes_striptags($systemdk_shop_categories_order);        $systemdk_shop_catitems_order = $this->registry->main_class->format_htmlspecchars_stripslashes_striptags($systemdk_shop_catitems_order);        $systemdk_shop_subcategories_order = $this->registry->main_class->format_htmlspecchars_stripslashes_striptags($systemdk_shop_subcategories_order);        $systemdk_shop_categitems_order = $this->registry->main_class->format_htmlspecchars_stripslashes_striptags($systemdk_shop_categitems_order);        $systemdk_shop_subcategitems_order = $this->registry->main_class->format_htmlspecchars_stripslashes_striptags($systemdk_shop_subcategitems_order);        $systemdk_shop_itemimage_path = $this->registry->main_class->format_htmlspecchars_stripslashes_striptags($systemdk_shop_itemimage_path);        $systemdk_shop_itemimage_position = $this->registry->main_class->format_htmlspecchars_stripslashes_striptags($systemdk_shop_itemimage_position);        $systemdk_shop_image_path = $this->registry->main_class->format_htmlspecchars_stripslashes_striptags($systemdk_shop_image_path);        $systemdk_shop_image_position = $this->registry->main_class->format_htmlspecchars_stripslashes_striptags($systemdk_shop_image_position);        $systemdk_shop_valuta = $this->registry->main_class->format_htmlspecchars_stripslashes_striptags($systemdk_shop_valuta);        @chmod("../modules/shop/shop_config.inc",0777);        $file = @fopen("../modules/shop/shop_config.inc","w");        if(!$file) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|confnofile|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCONFIGPAGETITLE'));                $this->registry->main_class->assign("shop_message","nofile");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|confnofile|".$this->registry->language);            exit();        }        $content = "<?php\n";        $content .= 'define("SYSTEMDK_SHOP_CATALOGS_ORDER","'.$systemdk_shop_catalogs_order."\");\n";        $content .= 'define("SYSTEMDK_SHOP_HOMEITEMS_PERPAGE",'.$systemdk_shop_homeitems_perpage.");\n";        $content .= 'define("SYSTEMDK_SHOP_HOMEITEMS_ORDER","'.$systemdk_shop_homeitems_order."\");\n";        $content .= 'define("SYSTEMDK_SHOP_CATEGORIES_ORDER","'.$systemdk_shop_categories_order."\");\n";        $content .= 'define("SYSTEMDK_SHOP_CATITEMS_PERPAGE",'.$systemdk_shop_catitems_perpage.");\n";        $content .= 'define("SYSTEMDK_SHOP_CATITEMS_ORDER","'.$systemdk_shop_catitems_order."\");\n";        $content .= 'define("SYSTEMDK_SHOP_SUBCATEGORIES_ORDER","'.$systemdk_shop_subcategories_order."\");\n";        $content .= 'define("SYSTEMDK_SHOP_CATEGITEMS_PERPAGE",'.$systemdk_shop_categitems_perpage.");\n";        $content .= 'define("SYSTEMDK_SHOP_CATEGITEMS_ORDER","'.$systemdk_shop_categitems_order."\");\n";        $content .= 'define("SYSTEMDK_SHOP_SUBCATEGITEMS_PERPAGE",'.$systemdk_shop_subcategitems_perpage.");\n";        $content .= 'define("SYSTEMDK_SHOP_SUBCATEGITEMS_ORDER","'.$systemdk_shop_subcategitems_order."\");\n";        $content .= 'define("SYSTEMDK_SHOP_ITEMIMAGE_PATH","'.$systemdk_shop_itemimage_path."\");\n";        $content .= 'define("SYSTEMDK_SHOP_ITEMIMAGE_POSITION","'.$systemdk_shop_itemimage_position."\");\n";        $content .= 'define("SYSTEMDK_SHOP_ITEMIMAGE_MAXSIZE",'.$systemdk_shop_itemimage_maxsize.");\n";        $content .= 'define("SYSTEMDK_SHOP_ITEMIMAGE_MAXWIDTH",'.$systemdk_shop_itemimage_maxwidth.");\n";        $content .= 'define("SYSTEMDK_SHOP_ITEMIMAGE_MAXHEIGHT",'.$systemdk_shop_itemimage_maxheight.");\n";        $content .= 'define("SYSTEMDK_SHOP_ITEMIMAGE_WIDTH",'.$systemdk_shop_itemimage_width.");\n";        $content .= 'define("SYSTEMDK_SHOP_ITEMIMAGE_WIDTH2",'.$systemdk_shop_itemimage_width2.");\n";        $content .= 'define("SYSTEMDK_SHOP_ITEMIMAGE_WIDTH3",'.$systemdk_shop_itemimage_width3.");\n";        $content .= 'define("SYSTEMDK_SHOP_ITEMIMAGE_HEIGHT3",'.$systemdk_shop_itemimage_height3.");\n";        $content .= 'define("SYSTEMDK_SHOP_IMAGE_PATH","'.$systemdk_shop_image_path."\");\n";        $content .= 'define("SYSTEMDK_SHOP_IMAGE_POSITION","'.$systemdk_shop_image_position."\");\n";        $content .= 'define("SYSTEMDK_SHOP_IMAGE_MAXSIZE",'.$systemdk_shop_image_maxsize.");\n";        $content .= 'define("SYSTEMDK_SHOP_IMAGE_MAXWIDTH",'.$systemdk_shop_image_maxwidth.");\n";        $content .= 'define("SYSTEMDK_SHOP_IMAGE_MAXHEIGHT",'.$systemdk_shop_image_maxheight.");\n";        $content .= 'define("SYSTEMDK_SHOP_IMAGE_WIDTH",'.$systemdk_shop_image_width.");\n";        $content .= 'define("SYSTEMDK_SHOP_ITEMS_COLUMNS",'.$systemdk_shop_items_columns.");\n";        $content .= 'define("SYSTEMDK_SHOP_ITEMS_UNDERPARENT",'.$systemdk_shop_items_underparent.");\n";        $content .= 'define("SYSTEMDK_SHOP_VALUTA","'.$systemdk_shop_valuta."\");\n";        $content .= 'define("SYSTEMDK_SHOP_ANTISPAM_IPADDR",'.$systemdk_shop_antispam_ipaddr.");\n";        $content .= 'define("SYSTEMDK_SHOP_ANTISPAM_NUM",'.$systemdk_shop_antispam_num.");\n";        $content .= "?>\n";        $writefile = @fwrite($file,$content);        if(!$writefile) {            if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|confnowrite|".$this->registry->language)) {                $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");                $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCONFIGPAGETITLE'));                $this->registry->main_class->assign("shop_message","nowrite");                $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");                $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");            }            $this->registry->main_class->database_close();            $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|error|confnowrite|".$this->registry->language);            exit();        }        $this->registry->main_class->systemdk_clearcache("modules|shop");        $this->registry->main_class->systemdk_clearcache("systemadmin|modules|shop");        if(!$this->registry->main_class->isCached("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|configok|".$this->registry->language)) {            $this->registry->main_class->configLoad($this->registry->language."/systemadmin/modules/shop/shop.conf");            $this->registry->main_class->set_sitemeta($this->registry->main_class->getConfigVars('_SHOPCONFIGPAGETITLE'));            $this->registry->main_class->assign("shop_message","writeok");            $this->registry->main_class->assign("include_center_up","systemadmin/adminup.html");            $this->registry->main_class->assign("include_center","systemadmin/modules/shop/shop_messages.html");        }        @fclose($file);        @chmod("../modules/shop/shop_config.inc",0604);        $this->registry->main_class->database_close();        $this->registry->main_class->display("systemadmin/main.html",$this->registry->sitelang."|systemadmin|modules|shop|configok|".$this->registry->language);    }}?>